<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>重启nfs server后client打开文件卡顿很长时间的问题</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://chenxiaosong.com/stylesheet.css" />
</head>
<body>
<header id="title-block-header">
<!-- sign begin -->
<ul>
<li>作者: 陈孝松</li>
<li><a href="https://chenxiaosong.com/">中文主页: chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/en">英文主页: chenxiaosong.com/en</a></li>
<li><a href="https://chenxiaosong.com/video.html">哔哩哔哩教学视频: 陈孝松</a></li>
<li><a href="https://chenxiaosong.com/course.html">课程: chenxiaosong.com/course</a></li>
<li><a href="https://chenxiaosong.com/blog.html">博客: chenxiaosong.com/blog</a></li>
<li><a href="https://chenxiaosong.com/contribution.html">贡献: chenxiaosong.com/contribution</a></li>
<li>邮箱: <a href="mailto:chenxiaosong@chenxiaosong.com" class="email">chenxiaosong@chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/q.html">QQ交流群: 544216206, 点击查看群介绍</a></li>
</ul>
<!-- sign end -->
<h1 class="title">重启nfs server后client打开文件卡顿很长时间的问题</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#问题描述"><span class="toc-section-number">1</span> 问题描述</a></li>
<li><a href="#测试"><span class="toc-section-number">2</span> 测试</a></li>
<li><a href="#client端代码分析"><span class="toc-section-number">3</span> client端代码分析</a></li>
<li><a href="#server端代码分析"><span class="toc-section-number">4</span> server端代码分析</a></li>
</ul>
</nav>
<h1 id="问题描述"><span class="header-section-number">1</span> 问题描述</h1>
<p>用主线内核(<code>7033999ecd7b</code>)测试nfs，发现当server端重启服务<code>systemctl restart nfs-server</code>，client端再读写文件会卡一会儿，5.10内核没有这个现象。</p>
<p>5.10内核server端重启服务，有如下打印:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="bu">[</span>   97.616435] nfsd: last server has exited, flushing export cache</a>
<a class="sourceLine" id="cb1-2" title="2">[   98.763518] NFSD: Using UMH upcall client tracking operations.</a>
<a class="sourceLine" id="cb1-3" title="3">[   98.765527] NFSD: starting 90-second grace period (net f0000098)</a></code></pre></div>
<p>主线内核server端重启服务，有如下打印:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="bu">[</span>   64.637398] NFSD: Unable to initialize client recovery tracking<span class="ot">!</span> (-110)</a>
<a class="sourceLine" id="cb2-2" title="2">[   64.639536] NFSD: starting 90-second grace period (net f0000000)</a></code></pre></div>
<h1 id="测试"><span class="header-section-number">2</span> 测试</h1>
<p>复现命令如下:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="co"># 以下命令如果没有特别强调，默认是client端的命令</span></a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="ex">systemctl</span> restart nfs-server <span class="co"># server端命令</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="bu">echo</span> something <span class="op">&gt;</span> something</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co"># 为什么不直接用 echo something &gt; /mnt/file 呢，因为用ps命令无法查看到echo进程</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co"># 但是这里好像用cat也没什么卵用，还是要用 ps aux | grep bash 才能找到进程号</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co"># cat something &gt; /mnt/file</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co"># 还是用后台运行的方式，打印出进程号</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="bu">echo</span> something <span class="op">&gt;</span> /mnt/file <span class="kw">&amp;</span> <span class="co"># 写文件，后台运行，会打印出进程号</span></a>
<a class="sourceLine" id="cb3-10" title="10">[<span class="ex">1</span>] 493 <span class="co"># 进程号</span></a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="ex">systemctl</span> restart nfs-server <span class="co"># server端命令</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="bu">echo</span> 3 <span class="op">&gt;</span> /proc/sys/vm/drop_caches</a>
<a class="sourceLine" id="cb3-14" title="14"><span class="fu">cat</span> /mnt/file <span class="kw">&amp;</span> <span class="co"># 读文件</span></a>
<a class="sourceLine" id="cb3-15" title="15"></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="fu">cat</span> /proc/493/stack</a>
<a class="sourceLine" id="cb3-17" title="17">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs4_delay_interruptible+0x33/0xa0</span></a>
<a class="sourceLine" id="cb3-18" title="18">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs4_delay+0x40/0x50</span></a>
<a class="sourceLine" id="cb3-19" title="19">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs4_handle_exception+0xd2/0xf0</span></a>
<a class="sourceLine" id="cb3-20" title="20">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs4_do_open+0x170/0x280</span></a>
<a class="sourceLine" id="cb3-21" title="21">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs4_atomic_open+0xa9/0x110</span></a>
<a class="sourceLine" id="cb3-22" title="22">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs_atomic_open+0x3cb/0x720</span></a>
<a class="sourceLine" id="cb3-23" title="23">[<span class="op">&lt;0&gt;</span>] <span class="ex">atomic_open+0x8c/0x1b0</span></a>
<a class="sourceLine" id="cb3-24" title="24">[<span class="op">&lt;0&gt;</span>] <span class="ex">lookup_open+0x330/0x470</span></a>
<a class="sourceLine" id="cb3-25" title="25">[<span class="op">&lt;0&gt;</span>] <span class="ex">open_last_lookups+0x25b/0x4b0</span></a>
<a class="sourceLine" id="cb3-26" title="26">[<span class="op">&lt;0&gt;</span>] <span class="ex">path_openat+0xa5/0x190</span></a>
<a class="sourceLine" id="cb3-27" title="27">[<span class="op">&lt;0&gt;</span>] <span class="ex">do_filp_open+0x53/0xc0</span></a>
<a class="sourceLine" id="cb3-28" title="28">[<span class="op">&lt;0&gt;</span>] <span class="ex">do_sys_openat2+0xab/0xe0</span></a>
<a class="sourceLine" id="cb3-29" title="29">[<span class="op">&lt;0&gt;</span>] <span class="ex">do_sys_open+0xb5/0xd0</span></a>
<a class="sourceLine" id="cb3-30" title="30">[<span class="op">&lt;0&gt;</span>] <span class="ex">__se_sys_openat+0x2f/0x40</span></a>
<a class="sourceLine" id="cb3-31" title="31">[<span class="op">&lt;0&gt;</span>] <span class="ex">__x64_sys_openat+0x23/0x30</span></a>
<a class="sourceLine" id="cb3-32" title="32">[<span class="op">&lt;0&gt;</span>] <span class="ex">do_syscall_64+0xe1/0x1d0</span></a>
<a class="sourceLine" id="cb3-33" title="33">[<span class="op">&lt;0&gt;</span>] <span class="ex">entry_SYSCALL_64_after_hwframe+0x6c/0x74</span></a></code></pre></div>
<p>server端用主线，client端用5.10，有问题；server端用5.10，client端用主线，没有问题。说明问题出在server端。</p>
<h1 id="client端代码分析"><span class="header-section-number">3</span> client端代码分析</h1>
<p>虽然问题出在server端，但我们还是先分析一下client端的代码，看看为什么读写文件会卡一会儿。</p>
<p>加调试打印信息:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="ex">---</span> a/fs/nfs/nfs4proc.c</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ex">+++</span> b/fs/nfs/nfs4proc.c</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="ex">@@</span> -617,6 +617,7 @@ int nfs4_handle_exception(struct nfs_server *server, int errorcode, struct nfs4_</a>
<a class="sourceLine" id="cb4-4" title="4">                        <span class="ex">exception-</span><span class="op">&gt;</span>retry = 0<span class="kw">;</span></a>
<a class="sourceLine" id="cb4-5" title="5">                        <span class="bu">return</span> ret2<span class="kw">;</span></a>
<a class="sourceLine" id="cb4-6" title="6">                }</a>
<a class="sourceLine" id="cb4-7" title="7"><span class="ex">+</span>               printk(<span class="st">&quot;%s:%d, timeout:%ld\n&quot;</span>, __func__, __LINE__, exception-<span class="op">&gt;</span>timeout);</a>
<a class="sourceLine" id="cb4-8" title="8">                <span class="ex">ret</span> = nfs4_delay(<span class="kw">&amp;</span><span class="ex">exception-</span><span class="op">&gt;</span>timeout,</a>
<a class="sourceLine" id="cb4-9" title="9">                                <span class="ex">exception-</span><span class="op">&gt;</span>interruptible);</a>
<a class="sourceLine" id="cb4-10" title="10">                <span class="ex">goto</span> out_retry<span class="kw">;</span></a></code></pre></div>
<p>测试打印结果如下:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="ex">root@syzkaller</span>:~# time echo something <span class="op">&gt;</span> /mnt/file <span class="kw">&amp;</span></a>
<a class="sourceLine" id="cb5-2" title="2">[<span class="ex">1</span>] 547</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="bu">[</span>  439.410573] nfs4_handle_exception:620, timeout:0</a>
<a class="sourceLine" id="cb5-4" title="4">[  439.518513] nfs4_handle_exception:620, timeout:200</a>
<a class="sourceLine" id="cb5-5" title="5">[  439.727291] nfs4_handle_exception:620, timeout:400 <span class="co"># 600</span></a>
<a class="sourceLine" id="cb5-6" title="6">[  440.135717] nfs4_handle_exception:620, timeout:800 <span class="co"># 1400</span></a>
<a class="sourceLine" id="cb5-7" title="7">[  440.992090] nfs4_handle_exception:620, timeout:1600 <span class="co"># 3000</span></a>
<a class="sourceLine" id="cb5-8" title="8">[  442.655003] nfs4_handle_exception:620, timeout:3200 <span class="co"># 6200</span></a>
<a class="sourceLine" id="cb5-9" title="9">[  445.919886] nfs4_handle_exception:620, timeout:6400 <span class="co"># 12600</span></a>
<a class="sourceLine" id="cb5-10" title="10">[  452.383892] nfs4_handle_exception:620, timeout:12800 <span class="co"># 25400</span></a>
<a class="sourceLine" id="cb5-11" title="11">[  465.695635] nfs4_handle_exception:620, timeout:25600 <span class="co"># 51000</span></a>
<a class="sourceLine" id="cb5-12" title="12">[  481.055601] nfs4_handle_exception:620, timeout:30000 <span class="co"># 81000</span></a>
<a class="sourceLine" id="cb5-13" title="13">[  496.415008] nfs4_handle_exception:620, timeout:30000 <span class="co"># 111000</span></a>
<a class="sourceLine" id="cb5-14" title="14">[  511.775498] nfs4_handle_exception:620, timeout:30000 <span class="co"># 141000</span></a>
<a class="sourceLine" id="cb5-15" title="15">real    1m27.820s <span class="co"># 87.82s</span></a>
<a class="sourceLine" id="cb5-16" title="16">user    0m0.000s</a>
<a class="sourceLine" id="cb5-17" title="17">sys     0m0.024s</a></code></pre></div>
<p>server重启服务后，client打开文件时server端不断返回<code>NFS4ERR_GRACE</code>错误，代码流程如下:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" title="1">openat</a>
<a class="sourceLine" id="cb6-2" title="2">  do_sys_open</a>
<a class="sourceLine" id="cb6-3" title="3">    do_sys_openat<span class="dv">2</span></a>
<a class="sourceLine" id="cb6-4" title="4">      do_filp_open</a>
<a class="sourceLine" id="cb6-5" title="5">        path_openat</a>
<a class="sourceLine" id="cb6-6" title="6">          open_last_lookups</a>
<a class="sourceLine" id="cb6-7" title="7">            lookup_open</a>
<a class="sourceLine" id="cb6-8" title="8">              atomic_open</a>
<a class="sourceLine" id="cb6-9" title="9">                nfs_atomic_open</a>
<a class="sourceLine" id="cb6-10" title="10">                  nfs<span class="dv">4</span><span class="er">_atomic_open</span></a>
<a class="sourceLine" id="cb6-11" title="11">                    nfs<span class="dv">4</span><span class="er">_do_open</span></a>
<a class="sourceLine" id="cb6-12" title="12">                      status = _nfs<span class="dv">4</span><span class="er">_do_open</span></a>
<a class="sourceLine" id="cb6-13" title="13">                        _nfs<span class="dv">4</span><span class="er">_open_and_get_state</span></a>
<a class="sourceLine" id="cb6-14" title="14">                          _nfs<span class="dv">4</span><span class="er">_proc_open</span></a>
<a class="sourceLine" id="cb6-15" title="15">                            nfs<span class="dv">4</span><span class="er">_run_open_task</span></a>
<a class="sourceLine" id="cb6-16" title="16">                              rpc_run_task</a>
<a class="sourceLine" id="cb6-17" title="17">                              <span class="co">// 从抓包数据可以看出，间隔时间依次是 0.105461, 0.20805, 0.407991, 0.807962, 1.665381, 3.264049, 6.463902, 13.311876, 15.35971</span></a>
<a class="sourceLine" id="cb6-18" title="18">                              status = rpc_wait_for_completion_task</a>
<a class="sourceLine" id="cb6-19" title="19">                      nfs4_handle_exception(status)</a>
<a class="sourceLine" id="cb6-20" title="20">                        nfs<span class="dv">4</span><span class="er">_do_handle_exception</span></a>
<a class="sourceLine" id="cb6-21" title="21">                          <span class="cf">case</span> -NFS4ERR_GRACE:</a>
<a class="sourceLine" id="cb6-22" title="22">                          exception-&gt;delay = <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-23" title="23">                        <span class="cf">if</span> (exception-&gt;delay) { <span class="co">// 条件满足</span></a>
<a class="sourceLine" id="cb6-24" title="24">                        nfs<span class="dv">4</span><span class="er">_delay</span></a>
<a class="sourceLine" id="cb6-25" title="25">                          nfs<span class="dv">4</span><span class="er">_delay_interruptible</span></a></code></pre></div>
<h1 id="server端代码分析"><span class="header-section-number">4</span> server端代码分析</h1>
<p>下面我们再分析server端的问题。</p>
<p>首先看一下重启服务时的报错信息。前面说过，5.10内核server端重启服务，有如下打印:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="bu">[</span>   97.616435] nfsd: last server has exited, flushing export cache</a>
<a class="sourceLine" id="cb7-2" title="2">[   98.763518] NFSD: Using UMH upcall client tracking operations.</a>
<a class="sourceLine" id="cb7-3" title="3">[   98.765527] NFSD: starting 90-second grace period (net f0000098)</a></code></pre></div>
<p>主线内核server端重启服务，有如下错误打印:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="bu">[</span>   64.637398] NFSD: Unable to initialize client recovery tracking<span class="ot">!</span> (-110)</a>
<a class="sourceLine" id="cb8-2" title="2">[   64.639536] NFSD: starting 90-second grace period (net f0000000)</a></code></pre></div>
<p>主线内核打开<code>CONFIG_NFSD_LEGACY_CLIENT_TRACKING</code>配置，没有问题，重启server端服务打印以下日志:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="bu">[</span>  122.050050] NFSD: Using UMH upcall client tracking operations.</a>
<a class="sourceLine" id="cb9-2" title="2">[  122.074438] NFSD: Using UMH upcall client tracking operations.</a>
<a class="sourceLine" id="cb9-3" title="3">[  122.076097] NFSD: starting 90-second grace period (net f0000000)</a></code></pre></div>
<p>所以现在要分析没打开<code>CONFIG_NFSD_LEGACY_CLIENT_TRACKING</code>配置时为什么会报错。<code>cld_running()</code>一直返回<code>false</code>。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb10-1" title="1"><span class="co">// rpc.nfsd进程</span></a>
<a class="sourceLine" id="cb10-2" title="2">write</a>
<a class="sourceLine" id="cb10-3" title="3">  ksys_write</a>
<a class="sourceLine" id="cb10-4" title="4">    vfs_write</a>
<a class="sourceLine" id="cb10-5" title="5">      nfsctl_transaction_write</a>
<a class="sourceLine" id="cb10-6" title="6">        write_threads</a>
<a class="sourceLine" id="cb10-7" title="7">          nfsd_svc</a>
<a class="sourceLine" id="cb10-8" title="8">            nfsd_startup_net</a>
<a class="sourceLine" id="cb10-9" title="9">              nfs<span class="dv">4</span><span class="er">_state_start_net</span></a>
<a class="sourceLine" id="cb10-10" title="10">                nfsd<span class="dv">4</span><span class="er">_client_tracking_init</span></a>
<a class="sourceLine" id="cb10-11" title="11">                  status = nfsd4_cld_tracking_init(net) = -<span class="dv">110</span> <span class="co">// ETIMEDOUT</span></a>
<a class="sourceLine" id="cb10-12" title="12">                    running = cld_running() = false <span class="co">// 判断10次，共1秒</span></a>
<a class="sourceLine" id="cb10-13" title="13">                    <span class="cf">if</span> (!running) <span class="co">// 条件满足 running == false</span></a>
<a class="sourceLine" id="cb10-14" title="14">                    status = -ETIMEDOUT</a>
<a class="sourceLine" id="cb10-15" title="15">                  check_for_legacy_methods(status == -ETIMEDOUT)</a>
<a class="sourceLine" id="cb10-16" title="16">                  <span class="cf">if</span> (status) { <span class="co">// status == -ETIMEDOUT</span></a>
<a class="sourceLine" id="cb10-17" title="17">                  printk(KERN_WARNING <span class="st">&quot;NFSD: Unable to initialize client&quot;</span></a>
<a class="sourceLine" id="cb10-18" title="18">                                      <span class="st">&quot;recovery tracking! (%d)</span><span class="sc">\n</span><span class="st">&quot;</span>, status)</a>
<a class="sourceLine" id="cb10-19" title="19">                printk(KERN_INFO <span class="st">&quot;NFSD: starting %lld-second grace period (net %x)</span><span class="sc">\n</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb10-20" title="20">                queue_delayed_work(laundry_wq, &amp;nn-&gt;laundromat_work, nn-&gt;nfsd4_grace * HZ)</a>
<a class="sourceLine" id="cb10-21" title="21"></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="co">// laundromat_work 延时执行的任务</span></a>
<a class="sourceLine" id="cb10-23" title="23">laundromat_main</a></code></pre></div>
<p>下面分析client端请求打开文件时，server为什么会返回错误<code>NFS4ERR_GRACE</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb11-1" title="1">nfsd</a>
<a class="sourceLine" id="cb11-2" title="2">  svc_recv</a>
<a class="sourceLine" id="cb11-3" title="3">    svc_handle_xprt</a>
<a class="sourceLine" id="cb11-4" title="4">      svc_process</a>
<a class="sourceLine" id="cb11-5" title="5">        svc_process_common</a>
<a class="sourceLine" id="cb11-6" title="6">          nfsd_dispatch</a>
<a class="sourceLine" id="cb11-7" title="7">            nfsd<span class="dv">4</span><span class="er">_proc_compound</span></a>
<a class="sourceLine" id="cb11-8" title="8">              nfsd<span class="dv">4</span><span class="er">_open</span></a>
<a class="sourceLine" id="cb11-9" title="9">                status = nfserr_grace</a>
<a class="sourceLine" id="cb11-10" title="10">                open-&gt;op_claim_type == NFS<span class="dv">4</span><span class="er">_OPEN_CLAIM_NULL</span></a>
<a class="sourceLine" id="cb11-11" title="11">                opens_in_grace(net) = true</a>
<a class="sourceLine" id="cb11-12" title="12">                  __state_in_grace</a>
<a class="sourceLine" id="cb11-13" title="13">                <span class="cf">return</span> nfserr_grace</a></code></pre></div>
</body>
</html>
