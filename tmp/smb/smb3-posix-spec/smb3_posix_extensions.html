<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>SMB3 POSIX Extensions</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="" />
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#posix-smb2-smb3-posix-extensions"
id="toc-posix-smb2-smb3-posix-extensions">[POSIX-SMB2] SMB3 POSIX
Extensions</a>
<ul>
<li><a href="#published-version" id="toc-published-version">Published
Version</a></li>
<li><a href="#previous-versions" id="toc-previous-versions">Previous
Versions</a></li>
</ul></li>
<li><a href="#introduction" id="toc-introduction">1
Introduction</a></li>
<li><a href="#messages-and-structures"
id="toc-messages-and-structures">2 Messages and Structures</a>
<ul>
<li><a href="#message-syntax" id="toc-message-syntax">2.2 Message
Syntax</a>
<ul>
<li><a href="#smb2-negotiate-request"
id="toc-smb2-negotiate-request">2.2.3 SMB2 NEGOTIATE Request</a>
<ul>
<li><a href="#smb2-negotiate_context-request-values"
id="toc-smb2-negotiate_context-request-values">2.2.3.1 SMB2
NEGOTIATE_CONTEXT Request Values</a></li>
</ul></li>
<li><a href="#smb2-negotiate-response"
id="toc-smb2-negotiate-response">2.2.4 SMB2 NEGOTIATE Response</a>
<ul>
<li><a href="#smb2-negotiate_context-response-values"
id="toc-smb2-negotiate_context-response-values">2.2.4.1 SMB2
NEGOTIATE_CONTEXT Response Values</a></li>
</ul></li>
<li><a href="#smb2-create-request" id="toc-smb2-create-request">2.2.13
SMB2 CREATE Request</a>
<ul>
<li><a href="#smb2_create_context-request-values"
id="toc-smb2_create_context-request-values">2.2.13.2 SMB2_CREATE_CONTEXT
Request Values</a></li>
<li><a href="#smb2_create_context-response-values"
id="toc-smb2_create_context-response-values">2.2.14.2
SMB2_CREATE_CONTEXT Response Values</a></li>
</ul></li>
<li><a href="#smb2-query_directory-request"
id="toc-smb2-query_directory-request">2.2.33 SMB2 QUERY_DIRECTORY
Request</a></li>
<li><a href="#smb2-query_directory-response"
id="toc-smb2-query_directory-response">2.2.34 SMB2 QUERY_DIRECTORY
Response</a></li>
<li><a href="#smb2-query_info-request"
id="toc-smb2-query_info-request">2.2.37 SMB2 QUERY_INFO Request</a></li>
</ul></li>
</ul></li>
<li><a href="#protocol-details" id="toc-protocol-details">3 Protocol
Details</a>
<ul>
<li><a href="#client-details" id="toc-client-details">3.2 Client
Details</a>
<ul>
<li><a href="#abstract-data-model" id="toc-abstract-data-model">3.2.1
Abstract Data Model</a>
<ul>
<li><a href="#global" id="toc-global">3.2.1.1 Global</a></li>
<li><a href="#per-smb2-transport-connection"
id="toc-per-smb2-transport-connection">3.2.1.2 Per SMB2 Transport
Connection</a></li>
<li><a href="#per-tree-connect" id="toc-per-tree-connect">3.2.1.4 Per
Tree Connect</a></li>
<li><a href="#per-open" id="toc-per-open">3.2.1.5 Per Open</a></li>
</ul></li>
<li><a href="#initialization" id="toc-initialization">3.2.3
Initialization</a></li>
<li><a href="#higher-layer-triggered-events"
id="toc-higher-layer-triggered-events">3.2.4 Higher-Layer Triggered
Events</a>
<ul>
<li><a href="#application-requests-a-connection-to-a-share"
id="toc-application-requests-a-connection-to-a-share">3.2.4.2
Application Requests a Connection to a Share</a></li>
<li><a href="#application-requests-opening-a-file"
id="toc-application-requests-opening-a-file">3.2.4.3 Application
Requests Opening a File</a></li>
<li><a href="#application-requests-writing-to-a-file-or-named-pipe"
id="toc-application-requests-writing-to-a-file-or-named-pipe">3.2.4.7
Application Requests Writing to a File or Named Pipe</a></li>
<li><a href="#application-requests-querying-file-attributes"
id="toc-application-requests-querying-file-attributes">3.2.4.8
Application Requests Querying File Attributes</a></li>
<li><a href="#application-requests-applying-file-attributes"
id="toc-application-requests-applying-file-attributes">3.2.4.9
Application Requests Applying File Attributes</a></li>
</ul></li>
<li><a href="#processing-events-and-sequencing-rules"
id="toc-processing-events-and-sequencing-rules">3.2.5 Processing Events
and Sequencing Rules</a>
<ul>
<li><a href="#receiving-an-smb2-negotiate-response"
id="toc-receiving-an-smb2-negotiate-response">3.2.5.2 Receiving an SMB2
NEGOTIATE Response</a></li>
<li><a href="#receiving-an-smb2-tree_connect-response"
id="toc-receiving-an-smb2-tree_connect-response">3.2.5.5 Receiving an
SMB2 TREE_CONNECT Response</a></li>
<li><a
href="#receiving-an-smb2-create-response-for-a-new-create-operation"
id="toc-receiving-an-smb2-create-response-for-a-new-create-operation">3.2.5.7
Receiving an SMB2 CREATE Response for a New Create Operation</a></li>
</ul></li>
</ul></li>
<li><a href="#server-details" id="toc-server-details">3.3 Server
Details</a>
<ul>
<li><a href="#abstract-data-model-1"
id="toc-abstract-data-model-1">3.3.1 Abstract Data Model</a>
<ul>
<li><a href="#global-1" id="toc-global-1">3.3.1.5 Global</a></li>
<li><a href="#per-share" id="toc-per-share">3.3.1.6 Per Share</a></li>
<li><a href="#per-tree-connect-1" id="toc-per-tree-connect-1">3.3.1.9
Per Tree Connect</a></li>
<li><a href="#per-open-1" id="toc-per-open-1">3.3.1.10 Per Open</a></li>
</ul></li>
<li><a href="#initialization-1" id="toc-initialization-1">3.3.3
Initialization</a></li>
<li><a href="#processing-events-and-sequencing-rules-1"
id="toc-processing-events-and-sequencing-rules-1">3.3.5 Processing
Events and Sequencing Rules</a>
<ul>
<li><a href="#receiving-a-smb2-negotiate_context-request"
id="toc-receiving-a-smb2-negotiate_context-request">3.3.5.4 Receiving a
SMB2 NEGOTIATE_CONTEXT Request</a></li>
<li><a href="#receiving-a-smb2-create-request"
id="toc-receiving-a-smb2-create-request">3.3.5.9 Receiving a SMB2 CREATE
Request</a></li>
<li><a href="#receiving-an-smb2-write-request"
id="toc-receiving-an-smb2-write-request">3.3.5.13 Receiving an SMB2
WRITE Request</a></li>
<li><a href="#receiving-a-smb2-query_directory-request"
id="toc-receiving-a-smb2-query_directory-request">3.3.5.18 Receiving a
SMB2 QUERY_DIRECTORY Request</a></li>
<li><a href="#receiving-a-smb2-query_info-request"
id="toc-receiving-a-smb2-query_info-request">3.3.5.20 Receiving a SMB2
QUERY_INFO Request</a></li>
<li><a href="#receiving-a-smb2-set_info-request"
id="toc-receiving-a-smb2-set_info-request">3.3.5.21 Receiving a SMB2
SET_INFO Request</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
<style>
body {
  font-family: Segoe UI,SegoeUI,Helvetica Neue,Helvetica,Arial,sans-serif;
  padding: 1em;
  margin: auto;
  max-width: 42em;
  background: #fefefe;
}
.protocol-table p {
  margin-top: 0px;
}
p {
  margin-top: 1rem;
  margin-bottom: 0px;
}
table {
  margin-top: 1rem;
  border: 1px solid #EAEAEA;
  border-collapse: collapse;
  width: 100%;
}
table, th, td {
  border-radius: 3px;
  padding: 5px;
}
th, td {
  font-size: .875rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  border: 1px solid #bbb;
  color: #2a2a2a;
}
th {
  background-color: #ededed;
  font-weight: 600;
}
td {
  padding: 0.5rem;
  background-color: #fff;
}
h1, h2, h3, h4, h5, h6 {
  font-weight: bold;
  color: #000;
}
h1 {
  font-size: 28px;
}
h2 {
  font-size: 24px;
}
h3 {
  font-size: 18px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 18px;
}
h6 {
  font-size: 18px;
}
</style>
<h1 id="posix-smb2-smb3-posix-extensions">[POSIX-SMB2] SMB3 POSIX
Extensions</h1>
<p>Specifies the SMB3 protocol extension for supporting POSIX compliant
operating systems.</p>
<h2 id="published-version">Published Version</h2>
<table class="protocol-table"><thead>
  <tr>
   <th>
   <p>Date</p>
   </th>
   <th>
   <p>Protocol Revision</p>
   </th>
   <th>
   <p>Revision Class</p>
   </th>
   <th>
   <p>Downloads</p>
   </th>
  </tr>
 </thead><tbody><tr>
  <td>
  <p>9/27/2023</p>
  </td>
  <td>
  <p>0.03</p>
  </td>
  <td>
  <p>Minor</p>
  </td>
  <td>
  <p>
    <span><a href="https://codeberg.org/SMB3UNIX/smb3_posix_spec/releases/download/0.3/smb3_posix_extensions.pdf" data-linktype="external">PDF</a></span>
  | <span><a href="https://codeberg.org/SMB3UNIX/smb3_posix_spec/releases/download/0.3/smb3_posix_extensions.html" data-linktype="external">HTML</a></span>
  </p>
  </td>
</tr></tbody></table>
<h2 id="previous-versions">Previous Versions</h2>
<table class="protocol-table"><thead>
  <tr>
   <th>
   <p>Date</p>
   </th>
   <th>
   <p>Protocol Revision</p>
   </th>
   <th>
   <p>Revision Class</p>
   </th>
   <th>
   <p>Downloads</p>
   </th>
  </tr>
 </thead><tbody>
 <tr>
  <td>
  <p>10/10/2022</p>
  </td>
  <td>
  <p>0.02</p>
  </td>
  <td>
  <p>Minor</p>
  </td>
  <td>
  <p>
    <span><a href="https://codeberg.org/SMB3UNIX/smb3_posix_spec/releases/download/0.02/smb3_posix_extensions.pdf" data-linktype="external">PDF</a></span>
  | <span><a href="https://codeberg.org/SMB3UNIX/smb3_posix_spec/releases/download/0.02/smb3_posix_extensions.html" data-linktype="external">HTML</a></span>
  </p>
  </td>
 </tr>
 <tr>
  <td>
  <p>9/22/2022</p>
  </td>
  <td>
  <p>0.01</p>
  </td>
  <td>
  <p>New</p>
  </td>
  <td>
  <p>
    <span><a href="https://codeberg.org/SMB3UNIX/smb3_posix_spec/releases/download/0.01/smb3_posix_spec.pdf" data-linktype="external">PDF</a></span>
  | <span><a href="https://codeberg.org/SMB3UNIX/smb3_posix_spec/releases/download/0.01/smb3_posix_spec.html" data-linktype="external">HTML</a></span>
  </p>
  </td>
 </tr>
</tbody></table>
<h1 id="introduction">1 Introduction</h1>
<p>The SMB3 POSIX Extensions are protocol extensions to enable POSIX
compliant operating systems to better interoperate with SMB3 servers and
storage appliances by extending the <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2">[MS-SMB2]</a>
specification. Popular servers such as Samba, Windows Server and others
support SMB3 by default. These extensions are already implemented in
multiple clients and servers.</p>
<h1 id="messages-and-structures">2 Messages and Structures</h1>
<h2 id="message-syntax">2.2 Message Syntax</h2>
<h3 id="smb2-negotiate-request">2.2.3 SMB2 NEGOTIATE Request</h3>
<h4 id="smb2-negotiate_context-request-values">2.2.3.1 SMB2
NEGOTIATE_CONTEXT Request Values</h4>
<p>Refer to section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/15332256-522e-4a53-8cd7-0bd17678a2f7">2.2.3.1</a>
of [MS-SMB2] for additional details. This section only explains details
relevant to a SMB3_POSIX_EXTENSIONS_AVAILABLE negotiate context
request.</p>
<table class="protocol-table">
 <tr>
  <th><p><br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>1<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>2<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>3<br>0</p></th>
  <th><p><br>1</p></th>
 </tr>
 <tr>
  <td colspan="16">
  <p>ContextType</p>
  </td>
  <td colspan="16">
  <p>DataLength</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>Reserved</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>Data
  (variable)</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
</table>
<p><strong>ContextType (2 bytes):</strong> Specifies the type of context
in the Data field. This field MUST contain one of the values specified
in section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/15332256-522e-4a53-8cd7-0bd17678a2f7">2.2.3.1</a>
of [MS-SMB2] or the following extended value:</p>
<table class="protocol-table"><thead>
  <tr>
   <th>
   <p>Value</p>
   </th>
   <th>
   <p>Meaning</p>
   </th>
  </tr>
 </thead><tbody><tr>
  <td>
  <p>SMB3_POSIX_EXTENSIONS_AVAILABLE</p>
  <p>0x0100</p>
  </td>
  <td>
  <p>The <b>Data</b> field contains a blob which uniquely identifies the SMB3
  POSIX version.</p>
  </td>
</tr></tbody></table>
<p><strong>DataLength (2 bytes):</strong> The length, in bytes, of the
<strong>Data</strong> field.</p>
<p><strong>Reserved (4 bytes):</strong> This field MUST NOT be used and
MUST be reserved. This value MUST be set to 0 by the client, and MUST be
ignored by the server.</p>
<p><strong>Data (variable):</strong> A variable-length field that
contains the negotiate context specified by the
<strong>ContextType</strong> field.</p>
<h5 id="smb3_posix_extensions_available">2.2.3.1.8
SMB3_POSIX_EXTENSIONS_AVAILABLE</h5>
<p>The SMB3_POSIX_EXTENSIONS_AVAILABLE context is specified in an SMB2
NEGOTIATE request by the client to indicate the version of SMB3 POSIX
Extensions that the client supports. The format of the data in the
<strong>Data</strong> field of this SMB2_NEGOTIATE_CONTEXT is as
follows.</p>
<table class="protocol-table">
 <tr>
  <th><p><br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>1<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>2<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>3<br>0</p></th>
  <th><p><br>1</p></th>
 </tr>
 <tr>
  <td colspan="32">
  <p>PosixTag</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>…</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>…</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>…</p>
  </td>
 </tr>
</table>
<p><strong>PosixTag (16 bytes):</strong> A blob indicating the SMB3
POSIX version. The following versions are defined.</p>
<table class="protocol-table"><thead>
  <tr>
   <th>
   <p><span>Version</span></p>
   </th>
   <th>
   <p><span>Value</span></p>
   </th>
  </tr>
 </thead><tbody><tr>
  <td>
  <p><span>1</span></p>
  </td>
  <td>
  <p>0x93AD25509CB411E7B42383DE968BCD7C</p>
  </td>
</tr></tbody></table>
<h3 id="smb2-negotiate-response">2.2.4 SMB2 NEGOTIATE Response</h3>
<h4 id="smb2-negotiate_context-response-values">2.2.4.1 SMB2
NEGOTIATE_CONTEXT Response Values</h4>
<h5 id="smb3_posix_extensions_available-1">2.2.4.1.8
SMB3_POSIX_EXTENSIONS_AVAILABLE</h5>
<p>The SMB3_POSIX_EXTENSIONS_AVAILABLE context is specified in an SMB2
NEGOTIATE response by the server to indicate that the SMB3 POSIX version
specified by the client is supported. The format of the data in the Data
field of this SMB2_NEGOTIATE_CONTEXT MUST take the same form specified
in section <a href="#smb3_posix_extensions_available">2.2.3.1.8</a>.</p>
<h3 id="smb2-create-request">2.2.13 SMB2 CREATE Request</h3>
<h4 id="smb2_create_context-request-values">2.2.13.2 SMB2_CREATE_CONTEXT
Request Values</h4>
<p>Refer to section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/75364667-3a93-4e2c-b771-592d8d5e876d">2.2.13.2</a>
of [MS-SMB2] for additional details. This section only explains details
relevant to a SMB2_CREATE_POSIX_CONTEXT request.</p>
<table class="protocol-table">
 <tr>
  <th><p><br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>1<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>2<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>3<br>0</p></th>
  <th><p><br>1</p></th>
 </tr>
 <tr>
  <td colspan="32">
  <p>Next</p>
  </td>
 </tr>
 <tr>
  <td colspan="16">
  <p>TagOffset</p>
  </td>
  <td colspan="16">
  <p>TagLength</p>
  </td>
 </tr>
 <tr>
  <td colspan="16">
  <p>Reserved</p>
  </td>
  <td colspan="16">
  <p>BlobOffset</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>BlobLength</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>Buffer
  (variable)</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
</table>
<p><strong>Next (4 bytes):</strong> The offset from the beginning of
this Create Context to the beginning of a subsequent 8-byte aligned
Create Context. This field MUST be set to 0 if there are no subsequent
contexts.</p>
<p><strong>TagOffset (2 bytes):</strong> The offset from the beginning
of this structure to its 8-byte aligned tag value.</p>
<p><strong>TagLength (2 bytes):</strong> The length, in bytes, of the
Create Context tag.</p>
<p><strong>Reserved (2 bytes):</strong> This field MUST NOT be used and
MUST be reserved. This value MUST be set to 0 by the client, and ignored
by the server.</p>
<p><strong>BlobOffset (2 bytes):</strong> The offset, in bytes, from the
beginning of this structure to the 8-byte aligned data payload. If
BlobLength is 0, the client SHOULD set this value to 0 and the server
MUST ignore it on receipt.</p>
<p><strong>BlobLength (4 bytes):</strong> The length, in bytes, of the
data. The format of the data is determined by the type of
SMB2_CREATE_CONTEXT request, as outlined in the following sections. The
type is inferred from the Create Context name specified by the
<strong>TagOffset</strong> and <strong>TagLength</strong> fields.</p>
<p><strong>Buffer (variable):</strong> A variable-length buffer that
contains the name and data fields, as defined by
<strong>TagOffset</strong>, <strong>TagLength</strong>,
<strong>BlobOffset</strong>, and <strong>BlobLength</strong>. The tag is
represented as four or more octets and MUST be one of the values
provided in section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/75364667-3a93-4e2c-b771-592d8d5e876d">2.2.13.2</a>
of [MS-SMB2] and the following table. The structure tag indicates what
information is encoded by the data payload. The values specified in
section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/75364667-3a93-4e2c-b771-592d8d5e876d">2.2.13.2</a>
of [MS-SMB2] and the following extended value are the valid Create
Context values and are defined to be in network byte order.</p>
<table class="protocol-table"><thead>
  <tr>
   <th>
   <p>Value</p>
   </th>
   <th>
   <p>Meaning</p>
   </th>
  </tr>
 </thead><tbody><tr>
  <td>
  <p>SMB2_CREATE_POSIX_CONTEXT</p>
  <p>0x93AD25509CB411E7B42383DE968BCD7C</p>
  </td>
  <td>
  <p>The data contains a POSIX Create Context.</p>
  </td>
</tr></tbody></table>
<h5 id="smb2_create_posix_context">2.2.13.2.16
SMB2_CREATE_POSIX_CONTEXT</h5>
<p>The SMB2_CREATE_POSIX_CONTEXT context is only specified on an SMB2
CREATE Request if SMB3_POSIX_EXTENSIONS_AVAILABLE was negotiated. The
client MAY specify SMB2_CREATE_POSIX_CONTEXT if POSIX permissions will
be set on create, or POSIX attributes will be requested from the
returned file handle.</p>
<table class="protocol-table">
 <tr>
  <th><p><br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>1<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>2<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>3<br>0</p></th>
  <th><p><br>1</p></th>
 </tr>
 <tr>
  <td colspan="32">
  <p>POSIXMode</p>
  </td>
 </tr>
</table>
<p><strong>POSIXPerms (4 bytes):</strong> The POSIX mode requested on
create if FILE_SUPERSEDE, FILE_CREATE, FILE_OPEN_IF, FILE_OVERWRITE, or
FILE_OVERWRITE_IF are specfied in the <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/e8fb45c1-a03d-44ca-b7ae-47385cfd7997">CreateDisposition</a>.
The server MUST ignore this value if the file exists. If the <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/e8fb45c1-a03d-44ca-b7ae-47385cfd7997">CreateDisposition</a>
is FILE_OPEN the client MUST set this to 0 and it MUST be ignored by the
server. POSIX mode is defined in <a
href="fscc_posix_extensions.html#posix-mode">POSIX-FSCC 2.1.1</a>.</p>
<h4 id="smb2_create_context-response-values">2.2.14.2
SMB2_CREATE_CONTEXT Response Values</h4>
<h5 id="smb2_create_posix_context-response">2.2.14.2.16
SMB2_CREATE_POSIX_CONTEXT Response</h5>
<p>The SMB2_CREATE_POSIX_CONTEXT response is sent by the server in
response to a SMB2_CREATE_POSIX_CONTEXT request (section <a
href="#smb2_create_posix_context">2.2.13.2.16</a>).</p>
<table class="protocol-table">
 <tr>
  <th><p><br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>1<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>2<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>3<br>0</p></th>
  <th><p><br>1</p></th>
 </tr>
 <tr>
  <td colspan="32">
  <p>NumberOfLinks</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>ReparseTag</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>POSIXMode</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>OwnerSID (variable)</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>GroupSID (variable)</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
</table>
<p><strong>NumberOfLinks (4 bytes):</strong> The number of hard links to
the file.</p>
<p><strong>ReparseTag (4 bytes):</strong> The reparse tag, as defined in
section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-fscc/c8e77b37-3909-4fe6-a4ea-2b9d423b1ee4">2.1.2.1</a>
of [MS-FSCC].</p>
<p><strong>POSIXMode (4 bytes):</strong> The POSIX mode as defined in <a
href="fscc_posix_extensions.html#posix-mode">POSIX-FSCC 2.1.1</a>.</p>
<p><strong>OwnerSID (variable):</strong> The owner SID as defined in <a
href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers">Microsoft
Security identifiers</a>.</p>
<p><strong>GroupSID (variable):</strong> The group SID as defined in <a
href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers">Microsoft
Security identifiers</a>.</p>
<h3 id="smb2-query_directory-request">2.2.33 SMB2 QUERY_DIRECTORY
Request</h3>
<p>Refer to section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/10906442-294c-46d3-8515-c277efe1f752">2.2.33</a>
of [MS-SMB2] for additional details. This section only explains details
relevant to a SMB2_FIND_POSIX_INFORMATION request.</p>
<table class="protocol-table">
 <tr>
  <th><p><br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>1<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>2<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>3<br>0</p></th>
  <th><p><br>1</p></th>
 </tr>
 <tr>
  <td colspan="16">
  <p>StructureSize</p>
  </td>
  <td colspan="8">
  <p>FileInformationClass</p>
  </td>
  <td colspan="8">
  <p>Flags</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>FileIndex</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>FileId</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
 <tr>
  <td colspan="16">
  <p>FileNameOffset</p>
  </td>
  <td colspan="16">
  <p>FileNameLength</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>OutputBufferLength</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>Buffer
  (variable)</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
</table>
<p><strong>StructureSize (2 bytes):</strong> The client MUST set this
field to 33, indicating the size of the request structure, not including
the header. The client MUST set this field to this value regardless of
how long Buffer[] actually is in the request being sent.</p>
<p><strong>FileInformationClass (1 byte):</strong> The file information
class describing the format that data MUST be returned in. Possible
values are specified in section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/10906442-294c-46d3-8515-c277efe1f752">2.2.33</a>
of [MS-SMB2] as well as the following extended file information
class:</p>
<table class="protocol-table"><thead>
  <tr>
   <th>
   <p>Value</p>
   </th>
   <th>
   <p>Meaning</p>
   </th>
  </tr>
 </thead><tbody><tr>
  <td>
  <p><a href="fscc_posix_extensions.html#fileposixinformation">FilePosixInformation</a></p>
  <p>0x64</p>
  </td>
  <td>
  <p>Basic posix information of a file or directory. Basic information is
  defined as the file's name, creation time, last access time, last modification
  time, last change time, allocation size, size, attributes, inode, devid, link
  count, reparse tag, POSIX permissions, and the owner and group SIDs.
  </p>
  </td>
 </tr></tbody>
</table>
<p><strong>Flags (1 byte):</strong> Flags indicating how the query
directory operation MUST be processed. As indicated in section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/10906442-294c-46d3-8515-c277efe1f752">2.2.33</a>
of [MS-SMB2].</p>
<p><strong>FileIndex (4 bytes):</strong> The byte offset within the
directory, indicating the position at which to resume the enumeration.
If SMB2_INDEX_SPECIFIED is set in Flags, this value MUST be supplied and
is based on the FileIndex value received in a previous enumeration
response. Otherwise, it MUST be set to zero and the server MUST ignore
it.</p>
<p><strong>FileId (16 bytes):</strong> An SMB2_FILEID identifier of the
directory on which to perform the enumeration. This is returned from an
SMB2 Create Request to open a directory on the server.</p>
<p><strong>FileNameOffset (2 bytes):</strong> The offset, in bytes, from
the beginning of the SMB2 header to the search pattern to be used for
the enumeration. This field MUST be 0 if no search pattern is
provided.</p>
<p><strong>FileNameLength (2 bytes):</strong> The length, in bytes, of
the search pattern. This field MUST be 0 if no search pattern is
provided.</p>
<p><strong>OutputBufferLength (4 bytes):</strong> The maximum number of
bytes the server is allowed to return in the SMB2 QUERY_DIRECTORY
Response.</p>
<p><strong>Buffer (variable):</strong> A variable-length buffer
containing the Unicode search pattern for the request, as described by
the <strong>FileNameOffset</strong> and <strong>FileNameLength</strong>
fields. The format, including wildcards and other conventions for this
pattern, is specified in [MS-CIFS] section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-cifs/dc92d939-ec45-40c8-96e5-4c4091e4ab43">2.2.1.1.3</a>.</p>
<h3 id="smb2-query_directory-response">2.2.34 SMB2 QUERY_DIRECTORY
Response</h3>
<p>Refer to section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/4f75351b-048c-4a0c-9ea3-addd55a71956">2.2.34</a>
of [MS-SMB2] for additional details. This section only explains details
relevant to a SMB2_FIND_POSIX_INFORMATION request.</p>
<table class="protocol-table">
 <tr>
  <th><p><br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>1<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>2<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>3<br>0</p></th>
  <th><p><br>1</p></th>
 </tr>
 <tr>
  <td colspan="16">
  <p>StructureSize</p>
  </td>
  <td colspan="16">
  <p>OutputBufferOffset</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>OutputBufferLength</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>Buffer
  (variable)</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
</table>
<p><strong>StructureSize (2 bytes):</strong> The server MUST set this
field to 9, indicating the size of the request structure, not including
the header. The server MUST set this field to this value regardless of
how long Buffer[] actually is in the request.</p>
<p><strong>OutputBufferOffset (2 bytes):</strong> The offset, in bytes,
from the beginning of the SMB2 header to the directory enumeration data
being returned.</p>
<p><strong>OutputBufferLength (4 bytes):</strong> The length, in bytes,
of the directory enumeration being returned.</p>
<p><strong>Buffer (variable):</strong> A variable-length buffer
containing the directory enumeration being returned in the response, as
described by the <strong>OutputBufferOffset</strong> and
<strong>OutputBufferLength</strong>. The format of this content is as
specified in [MS-FSCC] section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-fscc/4718fc40-e539-4014-8e33-b675af74e3e1">2.4</a>,
within the topic for the specific file information class referenced in
the SMB2 QUERY_DIRECTORY Request. The format for FilePosixInformation is
described <a
href="fscc_posix_extensions.html#fileposixinformation">POSIX-FSCC
2.3.1.1</a>.</p>
<h3 id="smb2-query_info-request">2.2.37 SMB2 QUERY_INFO Request</h3>
<p>Refer to section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/d623b2f7-a5cd-4639-8cc9-71fa7d9f9ba9">2.2.37</a>
of [MS-SMB2] for additional details. This section only explains details
relevant to a SMB2_FIND_POSIX_INFORMATION request.</p>
<table class="protocol-table">
 <tr>
  <th><p><br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>1<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>2<br>0</p></th>
  <th><p><br>1</p></th>
  <th><p><br>2</p></th>
  <th><p><br>3</p></th>
  <th><p><br>4</p></th>
  <th><p><br>5</p></th>
  <th><p><br>6</p></th>
  <th><p><br>7</p></th>
  <th><p><br>8</p></th>
  <th><p><br>9</p></th>
  <th><p>3<br>0</p></th>
  <th><p><br>1</p></th>
 </tr>
 <tr>
  <td colspan="16">
  <p>StructureSize</p>
  </td>
  <td colspan="8">
  <p>InfoType</p>
  </td>
  <td colspan="8">
  <p>FileInfoClass</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>OutputBufferLength</p>
  </td>
 </tr>
 <tr>
  <td colspan="16">
  <p>InputBufferOffset</p>
  </td>
  <td colspan="16">
  <p>Reserved</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>InputBufferLength</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>AdditionalInformation</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>Flags</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>FileId</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>Buffer
  (variable)</p>
  </td>
 </tr>
 <tr>
  <td colspan="32">
  <p>...</p>
  </td>
 </tr>
</table>
<p><strong>StructureSize (2 bytes):</strong> The client MUST set this
field to 41, indicating the size of the request structure, not including
the header. The client MUST set this field to this value regardless of
how long <strong>Buffer</strong>[] actually is in the request being
sent.</p>
<p><strong>InfoType (1 byte):</strong> The type of information queried.
This field MUST contain one of the values specified in section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/d623b2f7-a5cd-4639-8cc9-71fa7d9f9ba9">2.2.37</a>
of [MS-SMB2].</p>
<p><strong>FileInfoClass (1 byte):</strong> For file information
queries, this field MUST contain one of the FILE_INFORMATION_CLASS
values, as specified in section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/d64e0451-64a2-425a-848e-52a7dddab7b9">3.3.5.20.1</a>
of [MS-SMB2] and in [MS-FSCC] section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-fscc/4718fc40-e539-4014-8e33-b675af74e3e1">2.4</a>,
or the following extension defined in section [POSIX-FSCC 2.3.1.1].</p>
<ul>
<li><a
href="fscc_posix_extensions.html#fileposixinformation">FilePosixInformation</a></li>
</ul>
<p><strong>OutputBufferLength (4 bytes):</strong> The maximum number of
bytes of information the server can send in the response.</p>
<p><strong>InputBufferOffset (2 bytes):</strong> The offset, in bytes,
from the beginning of the SMB2 header to the input buffer.</p>
<p><strong>Reserved (2 bytes):</strong> This field MUST NOT be used and
MUST be reserved. The client MUST set this field to 0, and the server
MUST ignore it on receipt.</p>
<p><strong>InputBufferLength (4 bytes):</strong> The length of the input
buffer.</p>
<p><strong>AdditionalInformation (4 bytes):</strong> Provides additional
information to the server.</p>
<p><strong>Flags (4 bytes):</strong> The flags MUST be set to a
combination of zero or more of the bit values defined in section <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/d623b2f7-a5cd-4639-8cc9-71fa7d9f9ba9">2.2.37</a>
of [MS-SMB2] for a FileFullEaInformation query.</p>
<p><strong>FileId (16 bytes):</strong> An <a
href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/f1d9b40d-e335-45fc-9d0b-199a31ede4c3">SMB2_FILEID</a>
identifier of the file or named pipe on which to perform the query.
Queries for underlying object store or quota information are directed to
the volume on which the file resides.</p>
<p><strong>Buffer (variable):</strong> A variable-length buffer
containing the input buffer for the request, as described by the
<strong>InputBufferOffset</strong> and
<strong>InputBufferLength</strong> fields.</p>
<h1 id="protocol-details">3 Protocol Details</h1>
<h2 id="client-details">3.2 Client Details</h2>
<h3 id="abstract-data-model">3.2.1 Abstract Data Model</h3>
<h4 id="global">3.2.1.1 Global</h4>
<p>The client MUST implement the following:</p>
<p><strong>SupportsPosix</strong>: A boolean that indicates whether SMB3
POSIX Extensions are globally available and enabled.</p>
<h4 id="per-smb2-transport-connection">3.2.1.2 Per SMB2 Transport
Connection</h4>
<p>The client MUST implement the following:</p>
<p><strong>Connection.SupportsPosix</strong>: A boolean that indicates
whether SMB3 POSIX Extensions are available on this connection.</p>
<h4 id="per-tree-connect">3.2.1.4 Per Tree Connect</h4>
<p>The client MUST implement the following:</p>
<p><strong>TreeConnect.SupportsPosix</strong>: A boolean that indicates
whether SMB3 POSIX Extensions are effective on this mount.</p>
<h4 id="per-open">3.2.1.5 Per Open</h4>
<p>The client MUST implement the following:</p>
<p><strong>Open.Posix</strong>: A boolean that indicates whether SMB3
POSIX Extensions are effective for this open.</p>
<p><strong>Open.PosixAppend</strong>: the file was opened with O_APPEND
by the client application.</p>
<h3 id="initialization">3.2.3 Initialization</h3>
<p><strong>Global.SupportsPosix</strong> a boolean that MUST be
initialized in an implementation defined manner.</p>
<h3 id="higher-layer-triggered-events">3.2.4 Higher-Layer Triggered
Events</h3>
<h4 id="application-requests-a-connection-to-a-share">3.2.4.2
Application Requests a Connection to a Share</h4>
<p>The application provides the following additional info:</p>
<ul>
<li><strong>Posix</strong>: A boolean indicating whether the application
requests POSIX semantics on this share.</li>
</ul>
<p>If the client does not implement the SMB 3.1.1 dialect and
<strong>Posix</strong> is TRUE, the client MUST return
STATUS_NOT_SUPPORTED to the calling application.</p>
<p>If <strong>Global.SupportsPosix</strong> is FALSE and
<strong>Posix</strong> is TRUE, the client MUST return
STATUS_NOT_SUPPORTED to the calling application.</p>
<p>The client MUST lookup the target server in the
<strong>ConnectionTable</strong>. If an existing connection is found and
if <strong>Connection.SupportsPosix</strong> is FALSE, the client MUST
return STATUS_NOT_SUPPORTED to the calling application.</p>
<h5 id="negotiating-the-protocol">3.2.4.2.2 Negotiating the
Protocol</h5>
<h6 id="smb2-only-negotiate">3.2.4.2.2.2 SMB2-Only Negotiate</h6>
<p>If <strong>Posix</strong> is requested by the application, it MUST do
the following:</p>
<ul>
<li><p>Increment NegotiateContextCount by 1.</p></li>
<li><p>Add an SMB2_NEGOTIATE_CONTEXT with ContextType as
SMB3_POSIX_EXTENSIONS_AVAILABLE to the negotiate request as specified in
section 2.2.3.1.</p></li>
<li><p>Set <strong>Connection.SupportsPosix</strong> to TRUE.</p></li>
</ul>
<h5 id="connecting-to-the-share">3.2.4.2.4 Connecting to the Share</h5>
<p>If <strong>Posix</strong> is TRUE, the client MUST set
<strong>TreeConnect.SupportsPosix</strong> to TRUE.</p>
<h4 id="application-requests-opening-a-file">3.2.4.3 Application
Requests Opening a File</h4>
<p>The application MUST provide the following additional parameter when
creating files or directories:</p>
<ul>
<li><strong>POSIXPerms</strong>: The requested POSIX permissions for the
new object.</li>
</ul>
<p>If TreeConnect.SupportsPosix is FALSE, the reminder of this section
can be skipped.</p>
<p>When an application requests an <strong>open()</strong> with
<strong>O_APPEND</strong>, the client MUST fill
<strong>DesiredAccess</strong> with <strong>FILE_APPEND_DATA</strong>
but without <strong>FILE_WRITE_DATA</strong>. The client MUST set
<strong>Open.PosixAppend</strong> to True.</p>
<p>Otherwise the client MUST construct a create context, as specified in
section <a href="#smb2_create_posix_context">2.2.13.2.16</a> using the
POSIXPerms value provided by the application, and append it to any other
create contexts being issued with this CREATE request.
<strong>Open.Posix</strong> MUST be set to TRUE.</p>
<h4 id="application-requests-writing-to-a-file-or-named-pipe">3.2.4.7
Application Requests Writing to a File or Named Pipe</h4>
<p>The Offset field MUST be set to -1 if
<strong>Open.PosixAppend</strong> is True, otherwise Offset MUST be set
to the application provided value.</p>
<h4 id="application-requests-querying-file-attributes">3.2.4.8
Application Requests Querying File Attributes</h4>
<p>If <strong>Open.Posix</strong> is FALSE and
<strong>InformationClass</strong> is
<strong>FilePosixInformation</strong>, as specified in section <a
href="#file-information-classes">2.3.1</a>, the client MUST return
STATUS_INVALID_INFO_CLASS.</p>
<h4 id="application-requests-applying-file-attributes">3.2.4.9
Application Requests Applying File Attributes</h4>
<p>The application optionally provides the following additional
info:</p>
<ul>
<li><strong>POSIXPerms</strong>: The requested POSIX permissions</li>
</ul>
<p>If the optional parameter <em>POSIXPerms</em> is not present in the
request, the reminder of this section MUST be skipped.</p>
<p>If <strong>Open.Posix</strong> is FALSE, the reminder of this section
MUST be skipped.</p>
<p>Otherwise the client MUST initialize an empty security descriptor
object, as specified in [MS-DTYP] section 2.4.6.</p>
<p>The client MUST process the optional <em>POSIXPerms</em> argument as
follows:</p>
<ul>
<li>append an <em>ACCESS_ALLOWED_ACE</em> with SID
S-1-5-88-3-<em>mode</em>, where <em>mode</em> is the numeric
representation of <em>POSIXPerms</em>.</li>
</ul>
<p>The client MUST initialize an SMB2 SET_INFO Request following the
syntax specified in section [MS-SMB2] 2.2.39, SMB2 SET_INFO Request.</p>
<p>The SMB2 header MUST be initialized as specified in [MS-SMB2]
3.2.4.13, Application Requests Applying File Security.</p>
<p>The SMB2 SET_INFO Request MUST be initialized as specified in
[MS-SMB2] 3.2.4.13, Application Requests Applying File Security with the
following difference:</p>
<ul>
<li>The created security descriptor is copied into
<strong>Buffer</strong></li>
</ul>
<h3 id="processing-events-and-sequencing-rules">3.2.5 Processing Events
and Sequencing Rules</h3>
<h4 id="receiving-an-smb2-negotiate-response">3.2.5.2 Receiving an SMB2
NEGOTIATE Response</h4>
<p>If Connection.Dialect is "3.1.1", the client MUST process the
NegotiateContextList that is specified by the response's
NegotiateContextOffset and NegotiateContextCount fields as follows:</p>
<ul>
<li><p>If <strong>Connection.SupportsPosix</strong> is FALSE, a
SMB3_POSIX_EXTENSIONS_AVAILABLE context MUST be ignored if
present.</p></li>
<li><p>If <strong>Connection.SupportsPosix</strong> is TRUE and the
NegotiateContextList does not contain the
SMB3_POSIX_EXTENSIONS_AVAILABLE context, the client MUST return
STATUS_NOT_SUPPORTED to the calling application.</p></li>
<li><p>If the NegotiateContextList contains more than one
SMB3_POSIX_EXTENSIONS_AVAILABLE negotiate context, the client MUST
return an error to the calling application.</p></li>
</ul>
<p>Processing the SMB3_POSIX_EXTENSIONS_AVAILABLE negotiate context:</p>
<ul>
<li>If the SMB3_POSIX_EXTENSIONS_AVAILABLE negotiate context
<strong>PosixTag</strong> doesn't match the data in <a
href="#smb3_posix_extensions_available">2.2.3.1.8</a> the request MUST
return STATUS_INVALID_LEVEL to the calling application.</li>
</ul>
<h4 id="receiving-an-smb2-tree_connect-response">3.2.5.5 Receiving an
SMB2 TREE_CONNECT Response</h4>
<p>If <strong>TreeConnect.SupportsPosix</strong> is TRUE the client
SHOULD send a SMB2_CREATE request to the server with the following
parameters:</p>
<ul>
<li><p>path as ""</p></li>
<li><p>DesiredAccess: READ_ATTRIBUTES</p></li>
<li><p>RequestedOplockLevel: SMB2_OPLOCK_LEVEL_NONE</p></li>
<li><p>FileAttributes: FILE_ATTRIBUTE_DIRECTORY</p></li>
<li><p>ShareAccess: FILE_SHARE_READ + FILE_SHARE_WRITE +
FILE_SHARE_DELETE</p></li>
<li><p>CreateDisposition: FILE_OPEN</p></li>
<li><p>CreateOptions: FILE_DIRECTORY_FILE</p></li>
<li><p>SMB2_CREATE_CONTEXT: a single SMB2_CREATE_POSIX_CONTEXT context
as specified in <a href="#smb2_create_posix_context">2.2.13.2.16</a>.
POSIXPerms MUST be set to 0.</p></li>
</ul>
<p>When receiving the response for this request, if the status code in
the SMB2 header is not equal to STATUS_SUCCESS, the client MUST return
the error to the calling application.</p>
<p>If the CreateContexts lists of the response doesn't contain a
SMB2_CREATE_POSIX_CONTEXT context as specified in <a
href="#smb2_create_posix_context-response">2.2.14.2.16</a>, the client
MUST return the STATUS_NOT_SUPPORTED to the calling application.</p>
<p>Otherwise the client MUST set TreeConnect.SupportsPosix to TRUE and
MUST return the metadata values of the context to the calling
application.</p>
<h4
id="receiving-an-smb2-create-response-for-a-new-create-operation">3.2.5.7
Receiving an SMB2 CREATE Response for a New Create Operation</h4>
<p>If Open.Posix is FALSE the reminder of this section MUST be
skipped.</p>
<p>Otherwise, if the SMB2_CREATE_POSIX_CONTEXT context as specified in
<a href="#smb2_create_posix_context-response">2.2.14.2.16</a> is not
present in the response, the client MUST return STATUS_NOT_SUPPORTED to
the application.</p>
<p>The client MUST return the attributes returned in the
SMB2_CREATE_POSIX_CONTEXT context to the calling application.</p>
<h2 id="server-details">3.3 Server Details</h2>
<h3 id="abstract-data-model-1">3.3.1 Abstract Data Model</h3>
<h4 id="global-1">3.3.1.5 Global</h4>
<p>The server MUST implement the following:</p>
<p><strong>SupportsPosix</strong>: A boolean that indicates whether SMB3
POSIX Extensions are globally available and enabled.</p>
<h4 id="per-share">3.3.1.6 Per Share</h4>
<p>The server MUST implement the following:</p>
<p><strong>Share.SupportsPosix</strong>: A boolean that indicates
whether SMB3 POSIX Extensions are enabled on this share.</p>
<h4 id="per-tree-connect-1">3.3.1.9 Per Tree Connect</h4>
<p>The server MUST implement the following:</p>
<p><strong>TreeConnect.SupportsPosix</strong>: A boolean that indicates
whether SMB3 POSIX Extensions are enabled on this share.</p>
<h4 id="per-open-1">3.3.1.10 Per Open</h4>
<p>The server MUST implement the following:</p>
<p><strong>Open.Posix</strong>: A boolean that indicates whether SMB3
POSIX Extensions are enabled for this open.</p>
<p><strong>Open.PosixAppend</strong>: the client successfully requested
an open with POSIX append-IO semantics.</p>
<h3 id="initialization-1">3.3.3 Initialization</h3>
<p><strong>Global.SupportsPosix</strong>: a boolean that MUST be
initialized in an implementation defined way.</p>
<h3 id="processing-events-and-sequencing-rules-1">3.3.5 Processing
Events and Sequencing Rules</h3>
<h4 id="receiving-a-smb2-negotiate_context-request">3.3.5.4 Receiving a
SMB2 NEGOTIATE_CONTEXT Request</h4>
<p>If the NegotiateContextList does not contain a
SMB3_POSIX_EXTENSIONS_AVAILABLE context as specified in section <a
href="#smb2-negotiate-context-request-values">2.2.3.1</a>, the reminder
of this section can be skipped.</p>
<p>Otherwise, if Connection.Dialect is not "3.1.1", the request MUST
fail with STATUS_INVALID_PARAMETER.</p>
<p>If <strong>Global.SupportsPosix</strong> is FALSE, the request MUST
fail with STATUS_NOT_SUPPORTED.</p>
<p>The server MUST build a SMB3_POSIX_EXTENSIONS_AVAILABLE negotiate
context, as specified in section <a
href="#smb3-posix-extensions-available">2.2.4.1.8</a>, and add it to
NegotiateContextList.</p>
<h4 id="receiving-a-smb2-create-request">3.3.5.9 Receiving a SMB2 CREATE
Request</h4>
<h5 id="handling-the-smb2_create_posix_context-create-context">3.3.5.9.1
Handling the SMB2_CREATE_POSIX_CONTEXT Create Context</h5>
<p>If no SMB2_CREATE_POSIX_CONTEXT is present in the request, the
remainder of this section MUST be skipped.</p>
<p>Otherweise, if Connection.Dialect is not 3.1.1, the server MUST fail
the context with STATUS_INVALID_CLASS.</p>
<p>If more then one SMB2_CREATE_POSIX_CONTEXT is present, the request
MUST fail with STATUS_INVALID_PARAMETER.</p>
<p>If Global.SupportsPosix is FALSE, the server MUST fail the request
with STATUS_NOT_SUPPORTED.</p>
<p>If Share.SupportsPosix is FALSE, the server MUST fail the request
with STATUS_NOT_SUPPORTED.</p>
<p>If the request is for a named pipe, the request MUST fail with
STATUS_NOT_SUPPORTED.</p>
<p>If DesiredAccess contains FILE_APPEND_DATA:</p>
<ul>
<li><p>if DesiredAccess also contains FILE_WRITE_DATA, the subsequent
actions MUST be skipped</p></li>
<li><p>otherwise the server MUST pass O_APPEND to the underlying object
store when requesting the open from the underlying object
store.</p></li>
</ul>
<p>Querying the object store:</p>
<ul>
<li><p>The server MUST pass TRUE as the value to the parameter
<strong>IsPosix</strong>.</p></li>
<li><p>The server MUST pass POSIXPerms from the
SMB2_CREATE_POSIX_CONTEXT as additional parameter.</p></li>
</ul>
<p>Successful Open Initialization:</p>
<ul>
<li><p>Open.Posix MUST be set to TRUE.</p></li>
<li><p>Open.PosixAppend to True if O_APPEND was requested from the
underlying object store.</p></li>
</ul>
<p>The server MUST construct a response following the syntax specified
in section 2.2.14. The values MUST be set as follows:</p>
<ul>
<li><p>NumberOfLinks: is set to the value queried from the object
store.</p></li>
<li><p>ReparseTag: is set to the value queried from the object
store.</p></li>
<li><p>POSIXPerms: is set to the value queried from the object
store.</p></li>
<li><p>OwnerSID: is set to the value queried from the object
store.</p></li>
<li><p>GroupSID: is set to the value queried from the object
store.</p></li>
</ul>
<h4 id="receiving-an-smb2-write-request">3.3.5.13 Receiving an SMB2
WRITE Request</h4>
<p>If the offset in the WRITE requests is -1:</p>
<ul>
<li><p>if Open.PosixAppend is not True, the operation MUST be failed
with STATUS_INVALID_PARAMETER.</p></li>
<li><p>otherwise the server MUST request a write from the underlying
object store that writes data at the current end of the file</p></li>
</ul>
<p>If the offset in the WRITE requests is not -1:</p>
<ul>
<li>if Open.PosixAppend is True, the operation MUST be failed with
STATUS_INVALID_PARAMETER.</li>
</ul>
<h4 id="receiving-a-smb2-query_directory-request">3.3.5.18 Receiving a
SMB2 QUERY_DIRECTORY Request</h4>
<p>In addition to the information classes listed in MS-SMB2 3.3.5.18,
the server MUST support the <strong>FilePosixInformation</strong> class
as specified in <a
href="fscc_posix_extensions.html#fileposixinformation">POSIX-FSCC
2.3.1.1</a></p>
<p>If the information class in the request is not FilePosixInformation,
the reminder of this section MUST be skipped.</p>
<p>If Connection.Dialect is not "3.1.1" the request MUST be failed with
STATUS_INVALID_INFO_CLASS.</p>
<p>If Open.Posix is FALSE, the server MUST fail the request with
STATUS_INVALID_INFO_CLASS.</p>
<p>Querying the object store:</p>
<ul>
<li>The server MUST query the object store for the metdata requested in
<a href="fscc_posix_extensions.html#fileposixinformation">POSIX-FSCC
2.3.1.1</a>.</li>
</ul>
<p>The server MUST construct a response following the syntax specified
in section <a
href="fscc_posix_extensions.html#fileposixinformation">POSIX-FSCC
2.3.1.1</a> and fill in the metadata with the values received from the
object store.</p>
<h4 id="receiving-a-smb2-query_info-request">3.3.5.20 Receiving a SMB2
QUERY_INFO Request</h4>
<h5 id="handling-smb2_0_info_file">3.3.5.20.1 Handling
SMB2_0_INFO_FILE</h5>
<p>In addition to the information classes listed in MS-SMB2 2.2.37, the
server MUST support the <strong>FilePosixInformation</strong> class as
specified in <a
href="fscc_posix_extensions.html#fileposixinformation">POSIX-FSCC
2.3.1.1</a></p>
<p>If the information class in the request is not FilePosixInformation,
the reminder of this section MUST be skipped.</p>
<p>If Connection.Dialect is not "3.1.1" the request MUST be failed with
STATUS_INVALID_INFO_CLASS.</p>
<p>If Open.Posix is FALSE, the server MUST fail the request with
STATUS_INVALID_INFO_CLASS.</p>
<p>Querying the object store:</p>
<ul>
<li>The server MUST query the object store for the metdata requested in
<a href="fscc_posix_extensions.html#fileposixinformation">POSIX-FSCC
2.3.1.1</a>.</li>
</ul>
<p>The server MUST construct a response following the syntax specified
in section <a
href="fscc_posix_extensions.html#fileposixinformation">POSIX-FSCC
2.3.1.1</a> and fill in the metadata with the values received from the
object store.</p>
<h5 id="handling-smb2_0_info_filesystem">3.3.5.20.1 Handling
SMB2_0_INFO_FILESYSTEM</h5>
<p>In addition to the information classes listed in MS-SMB2 2.2.37, the
server MUST support the <strong>FileFsPosixInformation</strong> class as
specified in <a
href="fscc_posix_extensions.html#filefsposixinformation">POSIX-FSCC
2.3.2.1</a>.</p>
<p>If the information class in the request is not
FileFsPosixInformation, the reminder of this section MUST be
skipped.</p>
<p>If Connection.Dialect is not "3.1.1" the request MUST be failed with
STATUS_INVALID_INFO_CLASS.</p>
<p>If Open.Posix is FALSE, the server MUST fail the request with
STATUS_INVALID_INFO_CLASS.</p>
<p>Querying the object store:</p>
<ul>
<li>The server MUST query the object store for the metdata requested in
<a href="fscc_posix_extensions.html#filefsposixinformation">POSIX-FSCC
2.3.2.1</a>.</li>
</ul>
<p>The server MUST construct a response following the syntax specified
in section <a
href="fscc_posix_extensions.html#filefsposixinformation">POSIX-FSCC
2.3.2.1</a> and fill in the metadata with the values received from the
object store.</p>
<h4 id="receiving-a-smb2-set_info-request">3.3.5.21 Receiving a SMB2
SET_INFO Request</h4>
<h5 id="handling-smb2_0_info_security">3.3.5.21.3 Handling
SMB2_0_INFO_SECURITY</h5>
<p>If <strong>AdditionalInformation</strong> does not contain
<em>DACL_SECURITY_INFORMATION</em> the reminder of this section MUST be
skipped.</p>
<p>If the <strong>SECURITY_DESCRIPTOR.DACL</strong> in the
<strong>Buffer</strong> does not contain an ACCESS_ALLOWED_ACE with the
SID S-1-5-88-3, the reminder of this section MUST be skipped.</p>
<p>If Connection.Dialect is not "3.1.1" the request MUST be failed with
STATUS_INVALID_INFO_CLASS.</p>
<p>If Open.Posix is FALSE, the server MUST fail the request with
STATUS_INVALID_INFO_CLASS.</p>
<p>The server MUST issue an request to the underlying object store to
modify the POSIX mode of the object, taking the mode value from the
encoded SID S-1-5-88-3-<em>mode</em>.</p>
</body>
</html>
