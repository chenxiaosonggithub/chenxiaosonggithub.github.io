<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>nfsv3选项一样时挂载hung住的问题</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://chenxiaosong.com/stylesheet.css" />
</head>
<body>
<header id="title-block-header">
<!-- sign begin -->
<ul>
<li>作者: 陈孝松</li>
<li><a href="https://chenxiaosong.com/">中文主页: chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/en">英文主页: chenxiaosong.com/en</a></li>
<li><a href="https://chenxiaosong.com/video.html">哔哩哔哩教学视频: 陈孝松</a></li>
<li><a href="https://chenxiaosong.com/course.html">课程: chenxiaosong.com/course</a></li>
<li><a href="https://chenxiaosong.com/blog.html">博客: chenxiaosong.com/blog</a></li>
<li><a href="https://chenxiaosong.com/contribution.html">贡献: chenxiaosong.com/contribution</a></li>
<li>邮箱: <a href="mailto:chenxiaosong@chenxiaosong.com" class="email">chenxiaosong@chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/q.html">QQ交流群: 544216206, 点击查看群介绍</a></li>
</ul>
<!-- sign end -->
<h1 class="title">nfsv3选项一样时挂载hung住的问题</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#问题描述"><span class="toc-section-number">1</span> 问题描述</a></li>
<li><a href="#调试"><span class="toc-section-number">2</span> 调试</a><ul>
<li><a href="#kprobe"><span class="toc-section-number">2.1</span> kprobe</a></li>
<li><a href="#获取所有进程的栈"><span class="toc-section-number">2.2</span> 获取所有进程的栈</a></li>
</ul></li>
<li><a href="#代码分析"><span class="toc-section-number">3</span> 代码分析</a></li>
<li><a href="#构造"><span class="toc-section-number">4</span> 构造</a></li>
<li><a href="#规避方案"><span class="toc-section-number">5</span> 规避方案</a></li>
</ul>
</nav>
<p><a href="https://chenxiaosong.com/course/nfs/video.html">点击这里查看配套的教学视频</a>。</p>
<p><a href="https://chenxiaosong.com/course/nfs/nfs.html">点击跳转到nfs课程所有目录</a>。</p>
<h1 id="问题描述"><span class="header-section-number">1</span> 问题描述</h1>
<p>nfsv3挂载参数带<code>soft</code>或<code>actimeo=1</code>能挂载成功，不带这两个参数时挂载hung住:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">mount</span> -t nfs -o vers=3 <span class="va">${server_ip}</span>:/svr/export /mnt <span class="co"># hung</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="fu">mount</span> -t nfs -o vers=3,soft <span class="va">${server_ip}</span>:/svr/export /mnt <span class="co"># 成功</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="fu">mount</span> -t nfs -o vers=3,actimeo=1 <span class="va">${server_ip}</span>:/svr/export /mnt <span class="co"># 成功</span></a></code></pre></div>
<p>类似问题请参考<a href="https://bugzilla.kernel.org/show_bug.cgi?id=204395#c1">Bug 204395 - NFS v3 mount hung</a>。</p>
<h1 id="调试"><span class="header-section-number">2</span> 调试</h1>
<h2 id="kprobe"><span class="header-section-number">2.1</span> kprobe</h2>
<p>以下脚本验证都会走到<code>nfs_fs_mount_common()</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="va">kprobe_func_name=</span>nfs_fs_mount_common</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="bu">cd</span> /sys/kernel/debug/tracing/</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co"># 可以用 kprobe 跟踪的函数</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="fu">cat</span> available_filter_functions <span class="kw">|</span> <span class="fu">grep</span> <span class="va">${kprobe_func_name}</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="bu">echo</span> 1 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="bu">echo</span> <span class="st">&quot;p:p_</span><span class="va">${kprobe_func_name}</span><span class="st"> </span><span class="va">${kprobe_func_name}</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="bu">echo</span> 1 <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/enable</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co"># echo stacktrace &gt; events/kprobes/p_${kprobe_func_name}/trigger # 打印栈</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co"># echo &#39;!stacktrace&#39; &gt; events/kprobes/p_${kprobe_func_name}/trigger # 关闭栈</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="co"># echo 0 &gt; events/kprobes/p_${kprobe_func_name}/enable</span></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co"># echo &quot;-:p_${kprobe_func_name}&quot; &gt;&gt; kprobe_events</span></a>
<a class="sourceLine" id="cb2-13" title="13"></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="bu">echo</span> 0 <span class="op">&gt;</span> trace <span class="co"># 清除trace信息</span></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="fu">cat</span> trace_pipe</a></code></pre></div>
<h2 id="获取所有进程的栈"><span class="header-section-number">2.2</span> 获取所有进程的栈</h2>
<p>脚本查看<a href="https://chenxiaosong.com/course/nfs/debug.html#get-all_stack">《nfs调试方法》</a>。</p>
<p>vim删除某个重复的栈:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1">:<span class="ex">%s</span>/<span class="dt">\[</span><span class="op">&lt;0&gt;</span><span class="dt">\]</span> <span class="ex">grab_super+0x2b</span>\/0x90\_.<span class="dt">\{</span>-}=======================================================<span class="ex">//g</span></a>
<a class="sourceLine" id="cb3-2" title="2">:<span class="ex">%s</span>/<span class="dt">\[</span><span class="op">&lt;0&gt;</span><span class="dt">\]</span> <span class="ex">iterate_supers+0x7f</span>\/0x100\_.<span class="dt">\{</span>-}=======================================================<span class="ex">//g</span></a></code></pre></div>
<p>找到以下可疑的nfs相关的栈:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1">=============== 进程 <span class="ex">1232699</span> 线程 1232699 kworker/u256:0+flush-0:48 栈信息 ===============</a>
<a class="sourceLine" id="cb4-2" title="2">[<span class="op">&lt;0&gt;</span>] <span class="ex">inode_wait_for_writeback+0x21/0x30</span></a>
<a class="sourceLine" id="cb4-3" title="3">[<span class="op">&lt;0&gt;</span>] <span class="ex">evict+0xbc/0x1a0</span></a>
<a class="sourceLine" id="cb4-4" title="4">[<span class="op">&lt;0&gt;</span>] <span class="ex">__dentry_kill+0xdd/0x180</span></a>
<a class="sourceLine" id="cb4-5" title="5">[<span class="op">&lt;0&gt;</span>] <span class="ex">dentry_kill+0x4d/0x260</span></a>
<a class="sourceLine" id="cb4-6" title="6">[<span class="op">&lt;0&gt;</span>] <span class="ex">dput+0x183/0x200</span></a>
<a class="sourceLine" id="cb4-7" title="7">[<span class="op">&lt;0&gt;</span>] <span class="ex">__put_nfs_open_context+0xd0/0x130</span> [nfs]</a>
<a class="sourceLine" id="cb4-8" title="8">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs_free_request+0xb7/0x180</span> [nfs]</a>
<a class="sourceLine" id="cb4-9" title="9">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs_release_request+0x59/0x80</span> [nfs]</a>
<a class="sourceLine" id="cb4-10" title="10">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs_do_writepage+0x1bf/0x2d0</span> [nfs]</a>
<a class="sourceLine" id="cb4-11" title="11">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs_writepages_callback+0xf/0x20</span> [nfs]</a>
<a class="sourceLine" id="cb4-12" title="12">[<span class="op">&lt;0&gt;</span>] <span class="ex">write_cache_pages+0x187/0x410</span></a>
<a class="sourceLine" id="cb4-13" title="13">[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs_writepages+0xb0/0x170</span> [nfs]</a>
<a class="sourceLine" id="cb4-14" title="14">[<span class="op">&lt;0&gt;</span>] <span class="ex">do_writepages+0x4b/0xe0</span></a>
<a class="sourceLine" id="cb4-15" title="15">[<span class="op">&lt;0&gt;</span>] <span class="ex">__writeback_single_inode+0x3d/0x330</span></a>
<a class="sourceLine" id="cb4-16" title="16">[<span class="op">&lt;0&gt;</span>] <span class="ex">writeback_sb_inodes+0x1ad/0x4b0</span></a>
<a class="sourceLine" id="cb4-17" title="17">[<span class="op">&lt;0&gt;</span>] <span class="ex">__writeback_inodes_wb+0x5d/0xb0</span></a>
<a class="sourceLine" id="cb4-18" title="18">[<span class="op">&lt;0&gt;</span>] <span class="ex">wb_writeback+0x26c/0x300</span></a>
<a class="sourceLine" id="cb4-19" title="19">[<span class="op">&lt;0&gt;</span>] <span class="ex">wb_workfn+0x1dc/0x4c0</span></a>
<a class="sourceLine" id="cb4-20" title="20">[<span class="op">&lt;0&gt;</span>] <span class="ex">process_one_work+0x195/0x3d0</span></a>
<a class="sourceLine" id="cb4-21" title="21">[<span class="op">&lt;0&gt;</span>] <span class="ex">worker_thread+0x30/0x390</span> </a>
<a class="sourceLine" id="cb4-22" title="22">[<span class="op">&lt;0&gt;</span>] <span class="ex">kthread+0x113/0x130</span></a>
<a class="sourceLine" id="cb4-23" title="23">[<span class="op">&lt;0&gt;</span>] <span class="ex">ret_from_fork+0x35/0x40</span></a>
<a class="sourceLine" id="cb4-24" title="24">=======================================================</a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="ex">rpm2cpio</span> kernel-debuginfo-4.19.90-23.16.v2101.ky10.x86_64.rpm <span class="kw">|</span> <span class="fu">cpio</span> -div</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="ex">./klinux-4.19/scripts/faddr2line</span> usr/lib/debug/lib/modules/4.19.90-23.16.v2101.ky10.x86_64/kernel/fs/nfs/nfs.ko.debug nfs_release_request+0x59/0x80</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="ex">nfs_release_request+0x59</span>/0x80:</a>
<a class="sourceLine" id="cb5-5" title="5"><span class="ex">nfs_page_group_destroy</span> at /usr/src/debug/kernel-4.19.90/linux-4.19.90-23.16.v2101.ky10.x86_64/fs/nfs/pagelist.c:314</a>
<a class="sourceLine" id="cb5-6" title="6"><span class="kw">(</span><span class="ex">inlined</span> by<span class="kw">)</span> <span class="ex">kref_put</span> at /usr/src/debug/kernel-4.19.90/linux-4.19.90-23.16.v2101.ky10.x86_64/./include/linux/kref.h:70</a>
<a class="sourceLine" id="cb5-7" title="7"><span class="kw">(</span><span class="ex">inlined</span> by<span class="kw">)</span> <span class="ex">nfs_release_request</span> at /usr/src/debug/kernel-4.19.90/linux-4.19.90-23.16.v2101.ky10.x86_64/fs/nfs/pagelist.c:458</a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="ex">./klinux-4.19/scripts/faddr2line</span> usr/lib/debug/lib/modules/4.19.90-23.16.v2101.ky10.x86_64/kernel/fs/nfs/nfs.ko.debug nfs_do_writepage+0x1bf/0x2d0</a>
<a class="sourceLine" id="cb5-10" title="10"><span class="ex">nfs_do_writepage+0x1bf</span>/0x2d0:</a>
<a class="sourceLine" id="cb5-11" title="11"><span class="ex">nfs_do_writepage</span> at /usr/src/debug/kernel-4.19.90/linux-4.19.90-23.16.v2101.ky10.x86_64/fs/nfs/write.c:679</a></code></pre></div>
<p><code>nfs_do_writepage</code>内联了太多函数，所以要<a href="https://gitee.com/chenxiaosonggitee/tmp/blob/master/gnu-linux/nfs/nfsv3-mount-hung-with-same-option-vmcore.md">查看反汇编</a>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># fs/nfs/write.c: 674 if (ret == -EAGAIN) {</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="ex">0xffffffffc08b2600</span> <span class="op">&lt;</span>nfs_do_writepage+0x1a0<span class="op">&gt;</span>:    cmp    <span class="va">$0</span>xfffffff5,%r14d</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="ex">0xffffffffc08b2604</span> <span class="op">&lt;</span>nfs_do_writepage+0x1a4<span class="op">&gt;</span>:    je     0xffffffffc08b2671 <span class="op">&lt;</span>nfs_do_writepage+0x211<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co"># fs/nfs/write.c: 679 return ret;</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="ex">0xffffffffc08b2606</span> <span class="op">&lt;</span>nfs_do_writepage+0x1a6<span class="op">&gt;</span>:    pop    %rbx</a>
<a class="sourceLine" id="cb6-6" title="6"><span class="ex">0xffffffffc08b2607</span> <span class="op">&lt;</span>nfs_do_writepage+0x1a7<span class="op">&gt;</span>:    mov    %r14d,%eax</a>
<a class="sourceLine" id="cb6-7" title="7"><span class="ex">0xffffffffc08b260a</span> <span class="op">&lt;</span>nfs_do_writepage+0x1aa<span class="op">&gt;</span>:    pop    %rbp</a>
<a class="sourceLine" id="cb6-8" title="8"><span class="ex">0xffffffffc08b260b</span> <span class="op">&lt;</span>nfs_do_writepage+0x1ab<span class="op">&gt;</span>:    pop    %r12</a>
<a class="sourceLine" id="cb6-9" title="9"><span class="ex">0xffffffffc08b260d</span> <span class="op">&lt;</span>nfs_do_writepage+0x1ad<span class="op">&gt;</span>:    pop    %r13</a>
<a class="sourceLine" id="cb6-10" title="10"><span class="ex">0xffffffffc08b260f</span> <span class="op">&lt;</span>nfs_do_writepage+0x1af<span class="op">&gt;</span>:    pop    %r14</a>
<a class="sourceLine" id="cb6-11" title="11"><span class="ex">0xffffffffc08b2611</span> <span class="op">&lt;</span>nfs_do_writepage+0x1b1<span class="op">&gt;</span>:    pop    %r15</a>
<a class="sourceLine" id="cb6-12" title="12"><span class="ex">0xffffffffc08b2613</span> <span class="op">&lt;</span>nfs_do_writepage+0x1b3<span class="op">&gt;</span>:    retq   </a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co"># fs/nfs/write.c: 663 nfs_page_async_flush() nfs_write_error_remove_page(req);</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="ex">0xffffffffc08b2614</span> <span class="op">&lt;</span>nfs_do_writepage+0x1b4<span class="op">&gt;</span>:    mov    %rbp,%rdi <span class="co"># x86_64下整数参数使用的寄存器依次为: RDI，RSI，RDX，RCX，R8，R9</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="co"># fs/nfs/write.c: 664 nfs_page_async_flush() return 0;</span></a>
<a class="sourceLine" id="cb6-16" title="16"><span class="ex">0xffffffffc08b2617</span> <span class="op">&lt;</span>nfs_do_writepage+0x1b7<span class="op">&gt;</span>:    xor    %r14d,%r14d <span class="co"># 最终效果是将 %r14d 寄存器的值设置为零</span></a>
<a class="sourceLine" id="cb6-17" title="17"><span class="co"># fs/nfs/write.c: 663 nfs_page_async_flush() nfs_write_error_remove_page(req);</span></a>
<a class="sourceLine" id="cb6-18" title="18"><span class="ex">0xffffffffc08b261a</span> <span class="op">&lt;</span>nfs_do_writepage+0x1ba<span class="op">&gt;</span>:    callq  0xffffffffc08b1580 <span class="op">&lt;</span>nfs_write_error_remove_page<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb6-19" title="19"><span class="co"># fs/nfs/write.c: 679 return ret;</span></a>
<a class="sourceLine" id="cb6-20" title="20"><span class="ex">0xffffffffc08b261f</span> <span class="op">&lt;</span>nfs_do_writepage+0x1bf<span class="op">&gt;</span>:    mov    %r14d,%eax <span class="co"># 返回值放在eax</span></a>
<a class="sourceLine" id="cb6-21" title="21"><span class="ex">0xffffffffc08b2622</span> <span class="op">&lt;</span>nfs_do_writepage+0x1c2<span class="op">&gt;</span>:    pop    %rbx</a>
<a class="sourceLine" id="cb6-22" title="22"><span class="ex">0xffffffffc08b2623</span> <span class="op">&lt;</span>nfs_do_writepage+0x1c3<span class="op">&gt;</span>:    pop    %rbp</a>
<a class="sourceLine" id="cb6-23" title="23"><span class="ex">0xffffffffc08b2624</span> <span class="op">&lt;</span>nfs_do_writepage+0x1c4<span class="op">&gt;</span>:    pop    %r12</a>
<a class="sourceLine" id="cb6-24" title="24"><span class="ex">0xffffffffc08b2626</span> <span class="op">&lt;</span>nfs_do_writepage+0x1c6<span class="op">&gt;</span>:    pop    %r13</a>
<a class="sourceLine" id="cb6-25" title="25"><span class="ex">0xffffffffc08b2628</span> <span class="op">&lt;</span>nfs_do_writepage+0x1c8<span class="op">&gt;</span>:    pop    %r14</a>
<a class="sourceLine" id="cb6-26" title="26"><span class="ex">0xffffffffc08b262a</span> <span class="op">&lt;</span>nfs_do_writepage+0x1ca<span class="op">&gt;</span>:    pop    %r15</a>
<a class="sourceLine" id="cb6-27" title="27"><span class="ex">0xffffffffc08b262c</span> <span class="op">&lt;</span>nfs_do_writepage+0x1cc<span class="op">&gt;</span>:    retq   </a>
<a class="sourceLine" id="cb6-28" title="28"><span class="ex">...</span></a>
<a class="sourceLine" id="cb6-29" title="29"><span class="co"># fs/nfs/write.c: 675 redirty_page_for_writepage(wbc, page);</span></a>
<a class="sourceLine" id="cb6-30" title="30"><span class="ex">0xffffffffc08b2671</span> <span class="op">&lt;</span>nfs_do_writepage+0x211<span class="op">&gt;</span>:    mov    %rbx,%rsi</a>
<a class="sourceLine" id="cb6-31" title="31"><span class="ex">0xffffffffc08b2674</span> <span class="op">&lt;</span>nfs_do_writepage+0x214<span class="op">&gt;</span>:    mov    %r13,%rdi</a></code></pre></div>
<h1 id="代码分析"><span class="header-section-number">3</span> 代码分析</h1>
<p>在<code>sget_userns()</code>中，如果指定不一样的挂载选项时（比如加了<code>soft</code>），会生成新的超级块；而如果挂载选项和其他挂载点一样，就会尝试获取已有的超级块，但其他挂载点对应的同一超级块的锁已经被其他进程持有，所以就出现hung住的情况:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb7-1" title="1">mount</a>
<a class="sourceLine" id="cb7-2" title="2">  ksys_mount</a>
<a class="sourceLine" id="cb7-3" title="3">    do_mount</a>
<a class="sourceLine" id="cb7-4" title="4">      do_new_mount</a>
<a class="sourceLine" id="cb7-5" title="5">        vfs_kern_mount</a>
<a class="sourceLine" id="cb7-6" title="6">          mount_fs</a>
<a class="sourceLine" id="cb7-7" title="7">            nfs_fs_mount</a>
<a class="sourceLine" id="cb7-8" title="8">              nfs_try_mount</a>
<a class="sourceLine" id="cb7-9" title="9">                nfs_try_mount_request</a>
<a class="sourceLine" id="cb7-10" title="10">                  nfs<span class="dv">3</span><span class="er">_create_server</span></a>
<a class="sourceLine" id="cb7-11" title="11">                    nfs_create_server</a>
<a class="sourceLine" id="cb7-12" title="12">                      nfs_init_server</a>
<a class="sourceLine" id="cb7-13" title="13">                        nfs_get_client</a>
<a class="sourceLine" id="cb7-14" title="14">                          nfs_alloc_client</a>
<a class="sourceLine" id="cb7-15" title="15">                          nfs_init_client</a>
<a class="sourceLine" id="cb7-16" title="16">                nfs_fs_mount_common</a>
<a class="sourceLine" id="cb7-17" title="17">                  sget_userns</a>
<a class="sourceLine" id="cb7-18" title="18">                    grab_super <span class="co">// 当挂载选项一样时，尝试获取已有的超级块</span></a>
<a class="sourceLine" id="cb7-19" title="19">                      down_write <span class="co">// 其他挂载点对应的同一超级块的锁已经被其他进程持有</span></a>
<a class="sourceLine" id="cb7-20" title="20">                    alloc_super <span class="co">// 只有挂载选项不同时，才会分配新的超级块</span></a>
<a class="sourceLine" id="cb7-21" title="21"></a>
<a class="sourceLine" id="cb7-22" title="22">wb_workfn</a>
<a class="sourceLine" id="cb7-23" title="23">  wb_writeback</a>
<a class="sourceLine" id="cb7-24" title="24">    __writeback_inodes_wb</a>
<a class="sourceLine" id="cb7-25" title="25">      trylock_super(sb)</a>
<a class="sourceLine" id="cb7-26" title="26">        down_read_trylock(&amp;sb-&gt;s_umount) <span class="co">// 持有超级块读锁</span></a>
<a class="sourceLine" id="cb7-27" title="27">      writeback_sb_inodes</a>
<a class="sourceLine" id="cb7-28" title="28">        __writeback_single_inode</a>
<a class="sourceLine" id="cb7-29" title="29">          do_writepages</a>
<a class="sourceLine" id="cb7-30" title="30">            nfs_writepages</a>
<a class="sourceLine" id="cb7-31" title="31">              write_cache_pages</a>
<a class="sourceLine" id="cb7-32" title="32">                nfs_writepages_callback</a>
<a class="sourceLine" id="cb7-33" title="33">                  nfs_do_writepage</a>
<a class="sourceLine" id="cb7-34" title="34">                    nfs_page_async_flush</a>
<a class="sourceLine" id="cb7-35" title="35">                      nfs_write_error_remove_page</a>
<a class="sourceLine" id="cb7-36" title="36">                        nfs_release_request</a>
<a class="sourceLine" id="cb7-37" title="37">                          nfs_free_request</a>
<a class="sourceLine" id="cb7-38" title="38">                            __put_nfs_open_context</a>
<a class="sourceLine" id="cb7-39" title="39">                              dput</a>
<a class="sourceLine" id="cb7-40" title="40">                                dentry_kill</a>
<a class="sourceLine" id="cb7-41" title="41">                                  __dentry_kill</a>
<a class="sourceLine" id="cb7-42" title="42">                                    evict</a>
<a class="sourceLine" id="cb7-43" title="43">                                      inode_wait_for_writeback</a>
<a class="sourceLine" id="cb7-44" title="44"></a>
<a class="sourceLine" id="cb7-45" title="45">nfs_parse_mount_options</a>
<a class="sourceLine" id="cb7-46" title="46">  mnt-&gt;flags |= NFS_MOUNT_SOFT; <span class="co">// soft</span></a>
<a class="sourceLine" id="cb7-47" title="47">  mnt-&gt;acregmin = mnt-&gt;acregmax = mnt-&gt;acdirmin = mnt-&gt;acdirmax = option; <span class="co">// actimeo</span></a></code></pre></div>
<h1 id="构造"><span class="header-section-number">4</span> 构造</h1>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" title="1"><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></a>
<a class="sourceLine" id="cb8-5" title="5"></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="dt">int</span> main() {</a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="dt">const</span> <span class="dt">char</span> *filename = <span class="st">&quot;/mnt/file&quot;</span>; <span class="co">// NFS文件路径</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="dt">const</span> <span class="dt">char</span> *data = <span class="st">&quot;hello</span><span class="sc">\n</span><span class="st">&quot;</span>;       <span class="co">// 要写入的数据</span></a>
<a class="sourceLine" id="cb8-9" title="9"></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="co">// 打开文件（如果不存在则创建，只写模式）</span></a>
<a class="sourceLine" id="cb8-11" title="11">    <span class="dt">int</span> fd = open(filename, O_CREAT | O_WRONLY, <span class="bn">0644</span>);</a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="cf">if</span> (fd == -<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb8-13" title="13">        <span class="co">// 错误处理：无法打开文件</span></a>
<a class="sourceLine" id="cb8-14" title="14">        <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb8-15" title="15">    }</a>
<a class="sourceLine" id="cb8-16" title="16"></a>
<a class="sourceLine" id="cb8-17" title="17">    <span class="co">// 计算数据长度并写入文件</span></a>
<a class="sourceLine" id="cb8-18" title="18">    <span class="dt">ssize_t</span> bytes_written = write(fd, data, strlen(data));</a>
<a class="sourceLine" id="cb8-19" title="19">    <span class="cf">if</span> (bytes_written == -<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb8-20" title="20">        <span class="co">// 错误处理：写入失败</span></a>
<a class="sourceLine" id="cb8-21" title="21">        close(fd);</a>
<a class="sourceLine" id="cb8-22" title="22">        <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb8-23" title="23">    }</a>
<a class="sourceLine" id="cb8-24" title="24"></a>
<a class="sourceLine" id="cb8-25" title="25">    <span class="co">// 无限循环，保持程序运行且不关闭文件</span></a>
<a class="sourceLine" id="cb8-26" title="26">    <span class="cf">while</span> (<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb8-27" title="27">        sleep(<span class="dv">1</span>); <span class="co">// 每秒休眠一次，减少CPU占用</span></a>
<a class="sourceLine" id="cb8-28" title="28">    }</a>
<a class="sourceLine" id="cb8-29" title="29"></a>
<a class="sourceLine" id="cb8-30" title="30">    <span class="co">// 关闭文件</span></a>
<a class="sourceLine" id="cb8-31" title="31">    close(fd);</a>
<a class="sourceLine" id="cb8-32" title="32">    <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb8-33" title="33">}</a></code></pre></div>
<h1 id="规避方案"><span class="header-section-number">5</span> 规避方案</h1>
<p>默认选项值<code>acregmin=3,acregmax=60,acdirmin=30,acdirmax=60</code>，只需要更改其中一个选项，如<code>acdirmax=59</code>就能在挂载时生成新的超级块，从而挂载成功。</p>
</body>
</html>
