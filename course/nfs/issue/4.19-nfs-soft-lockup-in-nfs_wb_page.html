<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>4.19 nfs_wb_page() soft lockup的问题</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://chenxiaosong.com/stylesheet.css" />
</head>
<body>
<header id="title-block-header">
<!-- sign begin -->
<ul>
<li>作者: 陈孝松</li>
<li><a href="https://chenxiaosong.com/">主页: chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/video.html">哔哩哔哩教学视频: 陈孝松</a></li>
<li><a href="https://chenxiaosong.com/course.html">课程: chenxiaosong.com/course</a></li>
<li><a href="https://chenxiaosong.com/blog.html">博客: chenxiaosong.com/blog</a></li>
<li><a href="https://chenxiaosong.com/contribution.html">贡献: chenxiaosong.com/contribution</a></li>
<li>邮箱: <a href="mailto:chenxiaosong@chenxiaosong.com" class="email">chenxiaosong@chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/q.html">QQ交流群: 544216206, 点击查看群介绍</a></li>
</ul>
<!-- sign end -->
<h1 class="title">4.19 nfs_wb_page() soft lockup的问题</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#问题现象"><span class="toc-section-number">1</span> 问题现象</a></li>
<li><a href="#日志解析"><span class="toc-section-number">2</span> 日志解析</a></li>
<li><a href="#vmcore解析"><span class="toc-section-number">3</span> vmcore解析</a>
<ul>
<li><a href="#section"><span class="toc-section-number">3.1</span> 20241217</a></li>
<li><a href="#section-1"><span class="toc-section-number">3.2</span> 20241223</a></li>
<li><a href="#section-2"><span class="toc-section-number">3.3</span> 172</a></li>
<li><a href="#section-3"><span class="toc-section-number">3.4</span> 173</a></li>
<li><a href="#section-4"><span class="toc-section-number">3.5</span> 174</a></li>
</ul></li>
<li><a href="#调试"><span class="toc-section-number">4</span> 调试</a></li>
<li><a href="#代码分析和复现"><span class="toc-section-number">5</span> 代码分析和复现</a>
<ul>
<li><a href="#复现"><span class="toc-section-number">5.1</span> 复现</a></li>
<li><a href="#代码分析"><span class="toc-section-number">5.2</span> 代码分析</a></li>
<li><a href="#vmcore解析-1"><span class="toc-section-number">5.3</span> vmcore解析</a></li>
</ul></li>
</ul>
</nav>
<p><a href="https://chenxiaosong.com/course/nfs/video.html">点击这里查看配套的教学视频</a>。</p>
<p><a href="https://chenxiaosong.com/course/nfs/nfs.html">点击跳转到nfs课程所有目录</a>。</p>
<h1 data-number="1" id="问题现象"><span class="header-section-number">1</span> 问题现象</h1>
<p>4.19报soft lockup，日志如下:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>[<span class="ex">44257027.415633</span>] watchdog: BUG: soft lockup - CPU#73 stuck for 22s! [ICCCCEKF/ICCEqu:2649529]</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>[<span class="ex">44257027.505122</span>] CPU: 73 PID: 2649529 Comm: ICCCCEKF/ICCEqu Kdump: loaded Tainted: G        W  OEL    4.19.90-23.29.v2101.ky10.aarch64 #1</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>[<span class="ex">44257027.505123</span>] pstate: 40400009 (nZcv daif +PAN -UAO)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>[<span class="ex">44257027.505142</span>] pc : nfs_commit_end+0x28/0x48 [nfs]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>[<span class="ex">44257027.505147</span>] lr : 0x1</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>[<span class="ex">44257027.547172</span>] sp : fffffadb78c7b930</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>[<span class="ex">44257027.547173</span>] x29: fffffadb78c7b930 x28: 0000000000000000 </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>[<span class="ex">44257027.547175</span>] x27: fffffaa393635708 x26: ffff3d862f4bf000 </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>[<span class="ex">44257027.547175</span>] x25: 0000000000010000 x24: fffffaa393635598 </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>[<span class="ex">44257027.547177</span>] x23: 00000000fffffffe x22: 0000000000000000 </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>[<span class="ex">44257027.547178</span>] x21: fffffadb78c7b998 x20: 0000000000000000 </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>[<span class="ex">44257027.547179</span>] x19: fffffaa3936354b8 x18: 0000000000000000 </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>[<span class="ex">44257027.547180</span>] x17: 0000000000000000 x16: ffff3d8680813920 </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>[<span class="ex">44257027.547181</span>] x15: 0000000000000000 x14: d293b0140efe4f58 </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>[<span class="ex">44257027.547182</span>] x13: afa441f967f4fab6 x12: ffffffffffffff83 </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>[<span class="ex">44257027.547183</span>] x11: ffffffffffffff83 x10: fffffae27fffcec0 </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>[<span class="ex">44257027.547183</span>] x9 : 000000000000001a x8 : 0000000000000000 </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a>[<span class="ex">44257027.547184</span>] x7 : 0000000000000000 x6 : fffffae259a314c0 </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a>[<span class="ex">44257027.547185</span>] x5 : fffffadb78c7b898 x4 : ffff3d8681d905d8 </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a>[<span class="ex">44257027.547186</span>] x3 : 01ffffc00000102b x2 : ffff3d8629f81000 </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a>[<span class="ex">44257027.547187</span>] x1 : fffffaa3936354b8 x0 : 00000000ffffffff </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a>[<span class="ex">44257027.570469</span>] Call trace:</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a>[<span class="ex">44257027.570479</span>]  nfs_commit_end+0x28/0x48 [nfs]</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a>[<span class="ex">44257027.570489</span>]  __nfs_commit_inode+0x114/0x1a8 [nfs]</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a>[<span class="ex">44257027.570501</span>]  nfs_wb_page+0xc0/0x210 [nfs]</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a>[<span class="ex">44257027.581163</span>]  nfs_writepage_setup+0xb4/0x5c0 [nfs]</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a>[<span class="ex">44257027.581175</span>]  nfs_updatepage+0x144/0x420 [nfs]</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a>[<span class="ex">44257027.592961</span>]  nfs_write_end+0x80/0x348 [nfs]</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a>[<span class="ex">44257027.592966</span>]  generic_perform_write+0xfc/0x188</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a>[<span class="ex">44257027.592977</span>]  nfs_file_write+0xc8/0x260 [nfs]</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a>[<span class="ex">44257027.614899</span>]  __vfs_write+0x74/0x80</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a>[<span class="ex">44257027.614903</span>]  vfs_write+0xac/0x1c0</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a>[<span class="ex">44257027.626860</span>]  ksys_write+0x5c/0xc8</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true"></a>[<span class="ex">44257027.626862</span>]  __arm64_sys_write+0x24/0x30</span></code></pre></div>
<h1 data-number="2" id="日志解析"><span class="header-section-number">2</span> 日志解析</h1>
<p>soft lockup解析日志其实没啥卵用，但我还是习惯性的想解析一下，熟能生巧嘛，总有收获，这不发现了主线的脚本（2024.12.17）已经解析不了4.19的vmlinux了:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co"># 要用4.19的faddr2line，不能用主线的脚本</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="co"># PC 存储当前正在执行指令的地址</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="ex">faddr2line</span> vmlinux clear_page_dirty_for_io+0x1f8/0x3f0</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="ex">clear_page_dirty_for_io+0x1f8</span>/0x3f0:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="ex">unlocked_inode_to_wb_end</span> 于 include/linux/backing-dev.h:393</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="kw">(</span>已内连入<span class="kw">)</span><span class="ex">clear_page_dirty_for_io</span> 于 mm/page-writeback.c:2737 # unlocked_inode_to_wb_end(inode, <span class="kw">&amp;</span><span class="ex">cookie</span>);</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="co"># LR 用于保存函数调用的返回地址</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="ex">faddr2line</span> vmlinux clear_page_dirty_for_io+0x84/0x3f0</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="ex">clear_page_dirty_for_io+0x84</span>/0x3f0:</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="ex">clear_page_dirty_for_io</span> 于 mm/page-writeback.c:2720 # if (page_mkclean(page))</span></code></pre></div>
<h1 data-number="3" id="vmcore解析"><span class="header-section-number">3</span> vmcore解析</h1>
<h2 data-number="3.1" id="section"><span class="header-section-number">3.1</span> 20241217</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ex">md5sum</span> vmcore </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="ex">8931169f2c9a7e43ad917ecf73b24b25</span>  vmcore</span></code></pre></div>
<p>查看进程<code>2649529</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> bt 2649529</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="ex">PID</span>: 2649529  TASK: fffffae18c896480  CPU: 73  COMMAND: <span class="st">&quot;ICCCCEKF/ICCEqu&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a> <span class="co">#0 [fffffae259a2fe30] crash_save_cpu at ffff3d868073fb1c</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a> <span class="co">#1 [fffffae259a2ffe0] handle_IPI at ffff3d86806274f0</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a> <span class="co">#2 [fffffae259a30050] gic_handle_irq at ffff3d8680611740</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>     <span class="ex">PC</span>: 0000000040400009   LR: fffffadb78c7b810   SP: ffff3d868082f848</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>    <span class="ex">X29</span>: fffffae259a30080  X28: fffffae259a2c080  X27: fffffaa393635598</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>    <span class="ex">X26</span>: 0000000040400009  X25: ffff3d8629f67d60  X24: fffffadb78c7b7f0</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>    <span class="ex">X23</span>: 0000000000000003  X22: 0000000000000003  X21: ffff3d8680611744</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>    <span class="ex">X20</span>: fffffae259a30050  X19: 0000000000000000  X18: ffff3d8681980000</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    <span class="ex">X17</span>: ffff3d8680627534  X16: fffffae259a2ffe0  X15: 0000000000000000</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>    <span class="ex">X14</span>: 0000000000000049  X13: ffff3d8680620ab0  X12: fffffae259a2ffc0</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>    <span class="ex">X11</span>: ffff3d862f4bf000  X10: 0000000000000049   X9: 0000000000000003</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>     <span class="ex">X8</span>: 0000000000000000   X7: fffffadb78c7b7f0   X6: ffff3d8681a0c000</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>     <span class="ex">X5</span>: 0000000000000049   X4: 0000000000010000   X3: ffff3d8680f5fa08</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>     <span class="ex">X2</span>: fffffae259a2ffa0   X1: 0000000000000000   X0: fffffae259a2ff80</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>    <span class="ex">ORIG_X0</span>: fffffadb78c7b920  SYSCALLNO: ffff3d86806133b8  PSTATE: 00000000</span></code></pre></div>
<p>这个栈里看不出我们需要的page相关信息。</p>
<p>再来查看<code>ICCCCEKF/ICCEqu</code>名称的进程:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> ps ICCCCEKF/ICCEqu</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>   <span class="ex">PID</span>    PPID  CPU       TASK        ST  %MEM     VSZ    RSS  COMM</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>  <span class="ex">2395050</span>      1  66  fffffabb04ff3580  UN   0.0 12894528 1267776  ICCCCEKF/ICCEqu</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>  <span class="ex">2395054</span>      1  32  fffffae0e22c8b80  UN   0.0 13167744 1199168  ICCCCEKF/ICCEqu</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>  <span class="ex">2409446</span>      1  93  ffffdaa35b0c1f00  UN   0.0 10686784 1151232  ICCCCEKF/ICCEqu</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>  <span class="ex">2649513</span>      1  17  fffffad84ab0ba00  UN   0.0 12496000 1198976  ICCCCEKF/ICCEqu</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="op">&gt;</span> <span class="ex">2649529</span>      1  73  fffffae18c896480  RU   0.0 12493120 1187456  ICCCCEKF/ICCEqu</span></code></pre></div>
<p>前面4个进程的栈都类似，我们选取第一个<code>2395050</code>进程:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> bt 2395050</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="ex">PID</span>: 2395050  TASK: fffffabb04ff3580  CPU: 66  COMMAND: <span class="st">&quot;ICCCCEKF/ICCEqu&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a> <span class="co">#0 [fffffadb7cabba70] __switch_to at ffff3d8680618ba4</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a> <span class="co">#1 [fffffadb7cabba90] __schedule at ffff3d86811859ac</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a> <span class="co">#2 [fffffadb7cabbb10] schedule at ffff3d8681186098</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a> <span class="co">#3 [fffffadb7cabbb20] rwsem_down_write_failed at ffff3d8681189c00</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a> <span class="co">#4 [fffffadb7cabbbb0] down_write at ffff3d8681188e04</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a> <span class="co">#5 [fffffadb7cabbbd0] nfs_start_io_write at ffff3d8629f618cc [nfs]</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a> <span class="co">#6 [fffffadb7cabbbf0] nfs_file_write at ffff3d8629f59038 [nfs]</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a> <span class="co">#7 [fffffadb7cabbc30] new_sync_write at ffff3d86808bb4d0</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a> <span class="co">#8 [fffffadb7cabbcc0] __vfs_write at ffff3d86808be080</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a> <span class="co">#9 [fffffadb7cabbcf0] vfs_write at ffff3d86808be290</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a><span class="co">#10 [fffffadb7cabbd30] ksys_write at ffff3d86808be5c0</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a><span class="co">#11 [fffffadb7cabbd70] __arm64_sys_write at ffff3d86808be650</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a><span class="co">#12 [fffffadb7cabbd90] _MODULE_START_syshook_linux at ffff3d862a4514b0 [syshook_linux]</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a><span class="co">#13 [fffffadb7cabbdf0] _MODULE_START_syshook_linux at ffff3d862a453988 [syshook_linux]</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a><span class="co">#14 [fffffadb7cabbe60] el0_svc_common at ffff3d86806283ec</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a><span class="co">#15 [fffffadb7cabbea0] el0_svc_handler at ffff3d86806284dc</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a><span class="co">#16 [fffffadb7cabbff0] el0_svc at ffff3d8680614084</span></span></code></pre></div>
<p>这几个进程在<code>nfs_start_io_write()</code>中获取不到信号量，进入睡眠。</p>
<h2 data-number="3.2" id="section-1"><span class="header-section-number">3.2</span> 20241223</h2>
<p>加上以下修改:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>--- a/fs/nfs/write.c</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>+++ b/fs/nfs/write.c</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>@@ -<span class="dv">659</span>,<span class="dv">6</span> +<span class="dv">659</span>,<span class="dv">8</span> @@ <span class="dt">static</span> <span class="dt">int</span> nfs_page_async_flush(<span class="kw">struct</span> nfs_pageio_descriptor *pgio,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a> out:</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a> out_launder:</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>+       printk(<span class="st">&quot;%s:%d, err:%d</span><span class="sc">\n</span><span class="st">&quot;</span>, __func__, __LINE__, ret);</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>+       dump_stack();</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>        nfs_write_error_remove_page(req);</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>        <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a> }</span></code></pre></div>
<p>根据以下的日志分析，怀疑是由于<code>dump_stack()</code>执行太频繁导致的soft lockup。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ex">crash</span> vmcore usr/lib/debug/lib/modules/4.19.90-23.29v2.v2101.fortest.ky10.aarch64/vmlinux</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> mod -s nfs usr/lib/debug/lib/modules/4.19.90-23.29v2.v2101.fortest.ky10.aarch64/kernel/fs/nfs/nfs.ko.debug</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> mod -s nfsv3 usr/lib/debug/lib/modules/4.19.90-23.29v2.v2101.fortest.ky10.aarch64/kernel/fs/nfs/nfsv3.ko.debug</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> mod -s nfsv4 usr/lib/debug/lib/modules/4.19.90-23.29v2.v2101.fortest.ky10.aarch64/kernel/fs/nfs/nfsv4.ko.debug</span></code></pre></div>
<h2 data-number="3.3" id="section-2"><span class="header-section-number">3.3</span> 172</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="bu">[</span> 9364.083891] watchdog: BUG: soft lockup - CPU#37 stuck for 22s<span class="ot">!</span> [sftp:1081640]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>[ 9364.083908] watchdog: BUG: soft lockup - CPU#38 stuck for 22s<span class="ot">!</span> [sftp:1153283]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>[ 9364.083908] watchdog: BUG: soft lockup - CPU#38 stuck for 22s<span class="ot">!</span> [sftp:1153283]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>[ 9364.083971] CPU: 38 PID: 1153283 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>[ 9364.102984] CPU: 38 PID: 1153283 Comm: sftp Kdump: loaded Tainted: G             L    4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>[ 9365.456572] WARNING: CPU: 38 PID: 1153283 at arch/arm64/kernel/machine_kexec.c:160 machine_kexec+0x44/0x3d8</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>[ 9365.570709] CPU: 38 PID: 1153283 Comm: sftp Kdump: loaded Tainted: G             L    4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span></code></pre></div>
<p>脚本解析:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="ex">./scripts/faddr2line</span> usr/lib/debug/lib/modules/4.19.90-23.29v2.v2101.fortest.ky10.aarch64/kernel/fs/nfs/nfs.ko.debug nfs_do_writepage+0x32c/0x340</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="ex">nfs_do_writepage+0x32c</span>/0x340:</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="ex">nfs_page_async_flush</span> 于 /usr/src/debug/kernel-4.19.90/linux-4.19.90-23.29v2.v2101.fortest.ky10.aarch64/fs/nfs/write.c:665</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="kw">(</span>已内连入<span class="kw">)</span><span class="ex">nfs_do_writepage</span> 于 /usr/src/debug/kernel-4.19.90/linux-4.19.90-23.29v2.v2101.fortest.ky10.aarch64/fs/nfs/write.c:674</span></code></pre></div>
<h2 data-number="3.4" id="section-3"><span class="header-section-number">3.4</span> 173</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="bu">[</span> 9416.164235] watchdog: BUG: soft lockup - CPU#32 stuck for 22s<span class="ot">!</span> [sftp:862820]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>[ 9420.165200] watchdog: BUG: soft lockup - CPU#51 stuck for 23s<span class="ot">!</span> [sftp:862672]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>[ 9420.165530] watchdog: BUG: soft lockup - CPU#57 stuck for 23s<span class="ot">!</span> [sftp:868550]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>[ 9420.166692] watchdog: BUG: soft lockup - CPU#80 stuck for 23s<span class="ot">!</span> [sftp:851329]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>[ 9420.166785] watchdog: BUG: soft lockup - CPU#82 stuck for 23s<span class="ot">!</span> [sftp:567973]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>[ 9420.166881] watchdog: BUG: soft lockup - CPU#84 stuck for 23s<span class="ot">!</span> [sftp:862963]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>[ 9420.167079] watchdog: BUG: soft lockup - CPU#88 stuck for 23s<span class="ot">!</span> [sftp:851104]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>[ 9420.167228] watchdog: BUG: soft lockup - CPU#91 stuck for 23s<span class="ot">!</span> [sftp:868678]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>[ 9420.167286] watchdog: BUG: soft lockup - CPU#92 stuck for 23s<span class="ot">!</span> [sftp:875023]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a>[ 9424.166782] watchdog: BUG: soft lockup - CPU#83 stuck for 22s<span class="ot">!</span> [sftp:862591]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>[ 9424.167075] watchdog: BUG: soft lockup - CPU#89 stuck for 22s<span class="ot">!</span> [sftp:856681]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a>[ 9358.859194] CPU: 19 PID: 862820 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a>[ 9395.726988] CPU: 49 PID: 862820 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a>... # 省略29行类似的打印: CPU: 49 PID: 862820 Comm: sftp ...</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a>[ 9395.732020] CPU: 49 PID: 862820 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a>[ 9395.737886] CPU: 32 PID: 862820 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a>[ 9395.738152] CPU: 32 PID: 862820 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a>[ 9416.164235] watchdog: BUG: soft lockup - CPU#32 stuck for 22s<span class="ot">!</span> [sftp:862820]</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a>[ 9416.188502] CPU: 32 PID: 862820 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a>[ 9427.322468] CPU: 32 PID: 862820 Comm: sftp Kdump: loaded Tainted: G             L    4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true"></a>[ 9428.557618] WARNING: CPU: 32 PID: 862820 at arch/arm64/kernel/machine_kexec.c:160 machine_kexec+0x44/0x3d8</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true"></a>[ 9428.672716] CPU: 32 PID: 862820 Comm: sftp Kdump: loaded Tainted: G             L    4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span></code></pre></div>
<h2 data-number="3.5" id="section-4"><span class="header-section-number">3.5</span> 174</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="bu">[</span> 9204.132054] watchdog: BUG: soft lockup - CPU#89 stuck for 23s<span class="ot">!</span> [sftp:552169]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>[ 9204.132337] watchdog: BUG: soft lockup - CPU#95 stuck for 23s<span class="ot">!</span> [sftp:655671]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>[ 9208.131889] watchdog: BUG: soft lockup - CPU#87 stuck for 22s<span class="ot">!</span> [sftp:534440]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>[ 9174.199405] CPU: 89 PID: 552169 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>[ 9204.132054] watchdog: BUG: soft lockup - CPU#89 stuck for 23s<span class="ot">!</span> [sftp:552169]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>[ 9204.132124] CPU: 89 PID: 552169 Comm: sftp Kdump: loaded Not tainted 4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>[ 9209.461601] CPU: 89 PID: 552169 Comm: sftp Kdump: loaded Tainted: G             L    4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>[ 9210.705954] WARNING: CPU: 89 PID: 552169 at arch/arm64/kernel/machine_kexec.c:160 machine_kexec+0x44/0x3d8</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>[ 9210.820002] CPU: 89 PID: 552169 Comm: sftp Kdump: loaded Tainted: G             L    4.19.90-23.29v2.v2101.fortest.ky10.aarch64 #1</span></code></pre></div>
<h1 data-number="4" id="调试"><span class="header-section-number">4</span> 调试</h1>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="va">kprobe_func_name=</span>nfs_wb_page</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a><span class="va">kprobe_func_name=</span>nfs_writepage_locked</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a><span class="va">kprobe_func_name=</span>nfs_do_writepage</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="va">kprobe_func_name=</span>nfs_page_async_flush</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a><span class="va">kprobe_func_name=</span>nfs_error_is_fatal_on_server</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a><span class="bu">cd</span> /sys/kernel/debug/tracing/</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a><span class="co"># 可以用 kprobe 跟踪的函数</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a><span class="fu">cat</span> available_filter_functions <span class="kw">|</span> <span class="fu">grep</span> <span class="va">${kprobe_func_name}</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a><span class="bu">echo</span> 1 <span class="op">&gt;</span> tracing_on</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a><span class="co"># aarch64函数参数用到的寄存器: X0 ~ X7</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a><span class="bu">echo</span> <span class="st">&quot;p:p_</span><span class="va">${kprobe_func_name}</span><span class="st"> </span><span class="va">${kprobe_func_name}</span><span class="st"> err=%x0:x32&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a><span class="bu">echo</span> 1 <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/enable</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a><span class="bu">echo</span> stacktrace <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/trigger</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a><span class="bu">echo</span> <span class="st">&#39;!stacktrace&#39;</span> <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/trigger</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a><span class="bu">echo</span> 0 <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/enable</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a><span class="bu">echo</span> <span class="st">&quot;-:p_</span><span class="va">${kprobe_func_name}</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true"></a><span class="bu">echo</span> 0 <span class="op">&gt;</span> trace <span class="co"># 清除trace信息</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true"></a><span class="fu">cat</span> trace_pipe</span></code></pre></div>
<p>虽然<code>nfs_error_is_fatal_on_server()</code>函数能在<code>/sys/kernel/debug/tracing/available_filter_functions</code>文件中找到（表示可被kprobe跟踪），但在<code>nfs_page_async_flush() -&gt; nfs_error_is_fatal_on_server()</code>调用路径中，kprobe探测不到<code>nfs_error_is_fatal_on_server()</code>。</p>
<h1 data-number="5" id="代码分析和复现"><span class="header-section-number">5</span> 代码分析和复现</h1>
<p>请参考<a href="https://chenxiaosong.com/course/nfs/issue/4.19-null-ptr-deref-in-nfs_updatepage.html">《4.19 nfs_updatepage()空指针解引用问题》</a>。</p>
<h2 data-number="5.1" id="复现"><span class="header-section-number">5.1</span> 复现</h2>
<p>打上补丁 <a href="https://lore.kernel.org/all/20190407175912.23528-21-trond.myklebust@hammerspace.com/"><code>22876f540bdf ("NFS: Don't call generic_error_remove_page() while holding locks")</code></a>、<code>89047634f5ce NFS: Don't interrupt file writeout due to fatal errors</code>、构造补丁<a href="https://gitee.com/chenxiaosonggitee/blog/blob/master/course/nfs/src/0001-reproduce-4.19-null-ptr-deref-in-nfs_updatepage.patch">0001-reproduce-4.19-null-ptr-deref-in-nfs_updatepage.patch</a>，复现步骤:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="fu">mount</span> -t nfs -o vers=4.1 <span class="va">${nfs_server_ip}</span>:/server/export/dir /mnt</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a><span class="bu">echo</span> something <span class="op">&gt;</span> something</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a><span class="bu">echo</span> something_else <span class="op">&gt;</span> something_else</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a><span class="bu">echo</span> something_else_again <span class="op">&gt;</span> something_else_again</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a><span class="co"># 为什么不直接用 echo something &gt; /mnt/file 呢，因为用ps无法查看到echo进程</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a><span class="fu">cat</span> something <span class="op">&gt;</span> /mnt/file <span class="kw">&amp;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="fu">cat</span> something_else <span class="op">&gt;</span> /mnt/file <span class="kw">&amp;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a><span class="fu">cat</span> something_else_again <span class="op">&gt;</span> /mnt/file <span class="kw">&amp;</span></span></code></pre></div>
<p>可以看到:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="ex">root@syzkaller</span>:~# jobs</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a>[<span class="ex">1</span>]-  Running                 cat something <span class="op">&gt;</span> /mnt/file <span class="kw">&amp;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>[<span class="ex">3</span>]+  Running                 cat something_else_again <span class="op">&gt;</span> /mnt/file <span class="kw">&amp;</span></span></code></pre></div>
<p>查看进程的状态:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="ex">root@syzkaller</span>:~# ps aux <span class="kw">|</span> <span class="fu">grep</span> cat</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="ex">root</span>         448  100  0.0   4740   568 ttyS0    R    07:16   8:30 cat something</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a><span class="ex">root</span>         450  0.0  0.0   4740   504 ttyS0    D    07:16   0:00 cat something_else_again</span></code></pre></div>
<p>顺便从文件名查一下进程号（非必要步骤，就是记录一下曾经的尝试）:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="ex">root@syzkaller</span>:~# lsof /mnt/file</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="ex">COMMAND</span> PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="fu">cat</span>     448 root    1w   REG   0,35       15   12 /mnt/file</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a><span class="fu">cat</span>     450 root    1w   REG   0,35       15   12 /mnt/file</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a><span class="ex">root@syzkaller</span>:~# fuser /mnt/file</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a><span class="ex">/mnt</span>/file:             <span class="ex">448</span>   450</span></code></pre></div>
<p>查看进程栈:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="ex">root@syzkaller</span>:~# ls /proc/448/task/</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="ex">448</span> # 只有一个线程</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a><span class="ex">root@syzkaller</span>:~# cat /proc/448/stack</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">0xffffffffffffffff</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a><span class="ex">root@syzkaller</span>:~# ls /proc/450/task/</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a><span class="ex">450</span> # 只有一个线程</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a><span class="ex">root@syzkaller</span>:~# cat /proc/450/stack </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">call_rwsem_down_write_failed+0x13/0x20</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs_start_io_write+0x1a/0x2b</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">nfs_file_write+0x1be/0x6e5</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">new_sync_write+0x442/0x560</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">__vfs_write+0xda/0xef</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">vfs_write+0x176/0x48b</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">ksys_write+0x10a/0x1e9</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">__se_sys_write+0x24/0x29</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">__x64_sys_write+0x79/0x93</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">do_syscall_64+0x16d/0x4bb</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">entry_SYSCALL_64_after_hwframe+0x5c/0xc1</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true"></a>[<span class="op">&lt;0&gt;</span>] <span class="ex">0xffffffffffffffff</span></span></code></pre></div>
<h2 data-number="5.2" id="代码分析"><span class="header-section-number">5.2</span> 代码分析</h2>
<p>合入补丁<a href="https://lore.kernel.org/all/20190407175912.23528-21-trond.myklebust@hammerspace.com/"><code>22876f540bdf ("NFS: Don't call generic_error_remove_page() while holding locks")</code></a>后，<code>generic_error_remove_page</code>不执行，<code>page</code>的private标记不会被清除，所以在<code>nfs_wb_page</code>函数陷入死循环。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="co">// 其中一个先执行的cat进程，就是那个stack栈只有0xffffffffffffffff的进程</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>write</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>  ksys_write</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>    vfs_write</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>      __vfs_write</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>        new_sync_write</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>          nfs_file_write</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>            nfs_start_io_write</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a>              <span class="co">// 在这里加打印调试</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a>              <span class="cf">if</span> (!strcmp(inode-&gt;i_sb-&gt;s_type-&gt;name, <span class="st">&quot;nfs4&quot;</span>))</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true"></a>              printk(<span class="st">&quot;%s:%d, inode:%p</span><span class="sc">\n</span><span class="st">&quot;</span>, __func__, __LINE__, inode);</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true"></a>              dump_stack()</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true"></a>              down_write(&amp;inode-&gt;i_rwsem); <span class="co">// 这里获取了锁，另一个后执行的cat进程就获取锁失败</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true"></a>            generic_perform_write</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true"></a>              nfs_write_end</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true"></a>                nfs_updatepage</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true"></a>                  nfs_writepage_setup</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true"></a>                    nfs_setup_write_request</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true"></a>                      <span class="co">// 尝试搜索已经存在的request，如果已存在就更新，并返回非NULL</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true"></a>                      nfs_try_to_update_request <span class="co">// return NULL</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true"></a>                        nfs_wb_page <span class="co">// return 0</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true"></a>                          <span class="cf">if</span> (clear_page_dirty_for_io(page)) <span class="co">// 条件满足</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true"></a>                          nfs_writepage_locked <span class="co">// return 0</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true"></a>                            nfs_do_writepage <span class="co">// return 0</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true"></a>                              <span class="co">// 合入补丁 14bebe3c90b3 NFS: Don&#39;t interrupt file writeout due to fatal errors 后返回 0</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true"></a>                              nfs_page_async_flush <span class="co">// return 0</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true"></a>                                nfs_error_is_fatal_on_server <span class="co">// 发生致命错误时</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true"></a>                                nfs_write_error_remove_page</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true"></a>                                  <span class="co">// 合入22876f540bdf NFS: Don&#39;t call generic_error_remove_page() while holding locks后，</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true"></a>                                  <span class="co">// generic_error_remove_page()不执行，而是执行SetPageError()</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true"></a>                                  generic_error_remove_page</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true"></a>                                    truncate_inode_page</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true"></a>                                      truncate_cleanup_page</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true"></a>                                        do_invalidatepage</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true"></a>                                          nfs_invalidate_page</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true"></a>                                            nfs_wb_page_cancel</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true"></a>                                              nfs_inode_remove_request</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true"></a>                                                <span class="co">// 因为generic_error_remove_page()不执行，所以这里没执行到，</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true"></a>                                                <span class="co">// 后面的 if (!PagePrivate(page)) 条件不满足，陷入死循环</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true"></a>                                                ClearPagePrivate(head-&gt;wb_page) <span class="co">// 清除private标记</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true"></a>                                      delete_from_page_cache</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true"></a>                                        __delete_from_page_cache</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true"></a>                                          page_cache_tree_delete</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true"></a>                                            page-&gt;mapping = NULL</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true"></a>                          <span class="cf">continue</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true"></a>                          <span class="co">// 开始循环</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true"></a>                          <span class="cf">if</span> (clear_page_dirty_for_io(page)) <span class="co">// 条件不满足</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true"></a>                          <span class="cf">if</span> (!PagePrivate(page)) <span class="co">// 条件不满足，因为没执行generic_error_remove_page，没清除private标记</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true"></a>                          ret = nfs_commit_inode = <span class="dv">0</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true"></a>                          <span class="co">// 进行下一次循环，永远不会结束</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true"></a>            nfs_end_io_write <span class="co">// 未执行到</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true"></a><span class="co">// 另一个后执行的cat进程</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true"></a>write</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true"></a>  ksys_write</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true"></a>    vfs_write</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true"></a>      __vfs_write</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true"></a>        new_sync_write</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true"></a>          nfs_file_write</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true"></a>            nfs_start_io_write</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true"></a>              down_write(&amp;inode-&gt;i_rwsem);</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true"></a>                call_rwsem_down_write_failed <span class="co">// 获取锁失败</span></span></code></pre></div>
<h2 data-number="5.3" id="vmcore解析-1"><span class="header-section-number">5.3</span> vmcore解析</h2>
<p>按上述文章中的步骤复现，虽然进入了死循环，但并没有出现软锁的情况，导出vmcore分析一下。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> ps cat</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>      <span class="ex">PID</span>    PPID  CPU       TASK        ST  %MEM      VSZ      RSS  COMM</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a><span class="op">&gt;</span>     <span class="ex">528</span>       1  14  ffff88813b1c0000  RU   0.0     4800     1824  cat</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>      <span class="ex">529</span>       1   3  ffff88813b1c2f00  UN   0.0     4800     1688  cat</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> bt 528</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a><span class="ex">PID</span>: 528      TASK: ffff88813b1c0000  CPU: 14   COMMAND: <span class="st">&quot;cat&quot;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a>    [<span class="ex">exception</span> RIP: page_mapping+50]</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>    <span class="ex">RIP</span>: ffffffff81258672  RSP: ffffc900010abb70  RFLAGS: 00000246</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>    <span class="ex">RAX</span>: ffffea0004cbebc0  RBX: ffff88812a8cc380  RCX: 0000000000000000</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>    <span class="ex">RDX</span>: 0017ffffc000002b  RSI: 0000000000000001  RDI: ffffea0004cbebc0</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a>    <span class="ex">RBP</span>: ffffc900010abb70   R8: ffffffff82606600   R9: ffff88813bdaa778</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a>    <span class="ex">R10</span>: 0000000000000000  R11: 0000000002d6ac5c  R12: 0000000000000000</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a>    <span class="ex">R13</span>: ffffc900010abbd0  R14: ffffea0004cbebc0  R15: ffffea0004cbebc0</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a>    <span class="ex">CS</span>: 0010  SS: 0018</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a> <span class="co">#0 [ffffc900010abb78] clear_page_dirty_for_io at ffffffff8123dc3e</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a> <span class="co">#1 [ffffc900010abbc8] nfs_wb_page at ffffffff81429077</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true"></a> <span class="co">#2 [ffffc900010abc70] nfs_writepage_setup at ffffffff814293a0</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true"></a> <span class="co">#3 [ffffc900010abcb0] nfs_updatepage at ffffffff8142966e</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true"></a> <span class="co">#4 [ffffc900010abcf8] nfs_write_end at ffffffff81416d17</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true"></a> <span class="co">#5 [ffffc900010abd40] generic_perform_write at ffffffff8122df1a</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true"></a> <span class="co">#6 [ffffc900010abdd0] nfs_file_write at ffffffff81417972</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true"></a> <span class="co">#7 [ffffc900010abe08] new_sync_write at ffffffff812dfea7</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true"></a> <span class="co">#8 [ffffc900010abe90] __vfs_write at ffffffff812e33a9</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true"></a> <span class="co">#9 [ffffc900010abea0] vfs_write at ffffffff812e356d</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true"></a><span class="co">#10 [ffffc900010abed8] ksys_write at ffffffff812e39ae</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true"></a><span class="co">#11 [ffffc900010abf18] __x64_sys_write at ffffffff812e3a49</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true"></a><span class="co">#12 [ffffc900010abf28] do_syscall_64 at ffffffff81004384</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true"></a><span class="co">#13 [ffffc900010abf50] entry_SYSCALL_64_after_hwframe at ffffffff81c00088</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true"></a>    <span class="ex">RIP</span>: 00007f07cbd624b3  RSP: 00007ffdbdd43748  RFLAGS: 00000246</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true"></a>    <span class="ex">RAX</span>: ffffffffffffffda  RBX: 000000000000000a  RCX: 00007f07cbd624b3</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true"></a>    <span class="ex">RDX</span>: 000000000000000a  RSI: 00007f07cba25000  RDI: 0000000000000001</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true"></a>    <span class="ex">RBP</span>: 00007f07cba25000   R8: 00007f07cba24010   R9: 0000000000000000</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true"></a>    <span class="ex">R10</span>: fffffffffffffbc5  R11: 0000000000000246  R12: 0000000000000001</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true"></a>    <span class="ex">R13</span>: 0000000000000001  R14: 0000000000080000  R15: 0000000000080000</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true"></a>    <span class="ex">ORIG_RAX</span>: 0000000000000001  CS: 0033  SS: 002b</span></code></pre></div>
<p>反汇编:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../mm</span>/util.c: <span class="ex">529</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a><span class="ex">0xffffffff81258640</span> <span class="op">&lt;</span>page_mapping<span class="op">&gt;</span>:      nopl   0x0(%rax,%rax,1) [<span class="ex">FTRACE</span> NOP]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../include/linux</span>/compiler.h: <span class="ex">294</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a><span class="ex">0xffffffff81258645</span> <span class="op">&lt;</span>page_mapping+<span class="op">5&gt;</span>:    mov    0x8(%rdi),<span class="ex">%rdx</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../include/linux</span>/page-flags.h: <span class="ex">144</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a><span class="ex">0xffffffff81258649</span> <span class="op">&lt;</span>page_mapping+<span class="op">9&gt;</span>:    mov    %rdi,%rax</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../mm</span>/util.c: <span class="ex">529</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a><span class="ex">0xffffffff8125864c</span> <span class="op">&lt;</span>page_mapping+<span class="op">12&gt;</span>:   push   %rbp</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../include/linux</span>/page-flags.h: <span class="ex">145</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a><span class="ex">0xffffffff8125864d</span> <span class="op">&lt;</span>page_mapping+<span class="op">13&gt;</span>:   lea    -0x1(%rdx),<span class="ex">%rcx</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true"></a><span class="ex">0xffffffff81258651</span> <span class="op">&lt;</span>page_mapping+<span class="op">17&gt;</span>:   and    <span class="va">$0</span>x1,%edx</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true"></a><span class="ex">0xffffffff81258654</span> <span class="op">&lt;</span>page_mapping+<span class="op">20&gt;</span>:   cmovne %rcx,%rax</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../include/linux</span>/compiler.h: <span class="ex">294</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true"></a><span class="ex">0xffffffff81258658</span> <span class="op">&lt;</span>page_mapping+<span class="op">24&gt;</span>:   mov    %rsp,%rbp</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true"></a><span class="ex">0xffffffff8125865b</span> <span class="op">&lt;</span>page_mapping+<span class="op">27&gt;</span>:   mov    0x8(%rax),<span class="ex">%rcx</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../include/linux</span>/page-flags.h: <span class="ex">144</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true"></a><span class="ex">0xffffffff8125865f</span> <span class="op">&lt;</span>page_mapping+<span class="op">31&gt;</span>:   lea    -0x1(%rcx),<span class="ex">%rdx</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true"></a><span class="ex">0xffffffff81258663</span> <span class="op">&lt;</span>page_mapping+<span class="op">35&gt;</span>:   and    <span class="va">$0</span>x1,%ecx</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true"></a><span class="ex">0xffffffff81258666</span> <span class="op">&lt;</span>page_mapping+<span class="op">38&gt;</span>:   cmove  %rax,%rdx</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../arch/x86/include/asm</span>/bitops.h: <span class="ex">317</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true"></a><span class="ex">0xffffffff8125866a</span> <span class="op">&lt;</span>page_mapping+<span class="op">42&gt;</span>:   mov    (%rdx),<span class="ex">%rdx</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../mm</span>/util.c: <span class="ex">535</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true"></a><span class="ex">0xffffffff8125866d</span> <span class="op">&lt;</span>page_mapping+<span class="op">45&gt;</span>:   and    <span class="va">$0</span>x1,%dh</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true"></a><span class="ex">0xffffffff81258670</span> <span class="op">&lt;</span>page_mapping+<span class="op">48&gt;</span>:   jne    0xffffffff812586e5 <span class="op">&lt;</span>page_mapping+<span class="op">165&gt;</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../include/linux</span>/compiler.h: <span class="ex">294</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true"></a><span class="ex">0xffffffff81258672</span> <span class="op">&lt;</span>page_mapping+<span class="op">50&gt;</span>:   mov    0x8(%rax),<span class="ex">%rcx</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true"></a><span class="ex">/home/sonvhi/chenxiaosong/code/klinux-4.19/x86_64-build/../include/linux</span>/page-flags.h: <span class="ex">144</span></span></code></pre></div>
<p>可以看到保存<code>page_mapping()</code>函数第一个参数的<code>rdi</code>的值并没有被覆盖，所以<code>RDI: ffffea0004cbebc0</code>就是page的指针:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="ex">crash</span><span class="op">&gt;</span> kmem ffffea0004cbebc0</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>      <span class="ex">PAGE</span>       PHYSICAL      MAPPING       INDEX CNT FLAGS</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a><span class="ex">ffffea0004cbebc0</span> 132faf000 ffff88812a8cc4f0        0  3 17ffffc000102b locked,error,uptodate,lru,private</span></code></pre></div>
</body>
</html>
