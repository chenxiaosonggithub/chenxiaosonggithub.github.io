<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>nfs client数据结构</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://chenxiaosong.com/stylesheet.css" />
</head>
<body>
<header id="title-block-header">
<!-- sign begin -->
<ul>
<li>作者: 陈孝松</li>
<li><a href="https://chenxiaosong.com/">中文主页: chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/en">英文主页: chenxiaosong.com/en</a></li>
<li><a href="https://chenxiaosong.com/video.html">哔哩哔哩教学视频: 陈孝松</a></li>
<li><a href="https://chenxiaosong.com/course.html">课程: chenxiaosong.com/course</a></li>
<li><a href="https://chenxiaosong.com/blog.html">博客: chenxiaosong.com/blog</a></li>
<li><a href="https://chenxiaosong.com/contribution.html">贡献: chenxiaosong.com/contribution</a></li>
<li>邮箱: <a href="mailto:chenxiaosong@chenxiaosong.com" class="email">chenxiaosong@chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/q.html">QQ交流群: 544216206, 点击查看群介绍</a></li>
</ul>
<!-- sign end -->
<h1 class="title">nfs client数据结构</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#超级块"><span class="toc-section-number">1</span> 超级块</a><ul>
<li><a href="#struct-nfs_server"><span class="toc-section-number">1.1</span> <code>struct nfs_server</code></a></li>
<li><a href="#struct-nfs_client"><span class="toc-section-number">1.2</span> <code>struct nfs_client</code></a></li>
</ul></li>
<li><a href="#超级块操作"><span class="toc-section-number">2</span> 超级块操作</a></li>
<li><a href="#索引节点"><span class="toc-section-number">3</span> 索引节点</a></li>
<li><a href="#索引节点操作"><span class="toc-section-number">4</span> 索引节点操作</a><ul>
<li><a href="#常规文件"><span class="toc-section-number">4.1</span> 常规文件</a></li>
<li><a href="#目录"><span class="toc-section-number">4.2</span> 目录</a></li>
<li><a href="#符号链接"><span class="toc-section-number">4.3</span> 符号链接</a></li>
<li><a href="#命名空间"><span class="toc-section-number">4.4</span> 命名空间</a></li>
</ul></li>
<li><a href="#dentry操作"><span class="toc-section-number">5</span> <code>dentry</code>操作</a></li>
<li><a href="#file操作"><span class="toc-section-number">6</span> <code>file</code>操作</a><ul>
<li><a href="#常规文件-1"><span class="toc-section-number">6.1</span> 常规文件</a></li>
<li><a href="#目录-1"><span class="toc-section-number">6.2</span> 目录</a></li>
</ul></li>
<li><a href="#address_space操作"><span class="toc-section-number">7</span> <code>address_space</code>操作</a><ul>
<li><a href="#常规文件-2"><span class="toc-section-number">7.1</span> 常规文件</a></li>
<li><a href="#目录-2"><span class="toc-section-number">7.2</span> 目录</a></li>
</ul></li>
<li><a href="#文件系统类型"><span class="toc-section-number">8</span> 文件系统类型</a></li>
<li><a href="#模块加载卸载方法"><span class="toc-section-number">9</span> 模块加载卸载方法</a></li>
</ul>
</nav>
<p><a href="https://chenxiaosong.com/course/nfs/video.html">点击这里查看配套的教学视频</a>。</p>
<p><a href="https://chenxiaosong.com/course/nfs/nfs.html">点击跳转到nfs课程所有目录</a>。</p>
<p>我们通过开发一个新操作系统需要的步骤，来切入学习nfs client。</p>
<ol type="1">
<li>定义磁盘和内存的超级块结构。</li>
<li>实现超级块操作方法。</li>
<li>定义磁盘和内存的索引节点结构。</li>
<li>实现各种类型文件的索引节点操作方法，常规文件、目录、快速符号链接、普通符号链接、其他类型。</li>
<li>实现<code>dentry</code>操作方法。</li>
<li>实现各种类型文件的<code>file</code>操作方法，常规文件、目录、快速符号链接、普通符号链接、其他类型。</li>
<li>实现各种类型文件的<code>address_space</code>操作方法，常规文件、其他类型。</li>
<li>定义文件系统类型。</li>
<li>模块加载卸载方法。</li>
</ol>
<h1 id="超级块"><span class="header-section-number">1</span> 超级块</h1>
<h2 id="struct-nfs_server"><span class="header-section-number">1.1</span> <code>struct nfs_server</code></h2>
<p>由于nfs client没有磁盘超级块，所以只有内存超级块结构体，在<code>nfs_get_tree_common()</code>函数中赋值<code>fc-&gt;s_fs_info = server</code>。</p>
<p>这个结构体太长了。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb1-1" title="1"><span class="co">/*</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co"> * &quot;存储在超级块中的 NFS 客户端参数&quot;. 挂载参数不同时每挂载一次创建一个nfs_server，请看 nfs_compare_super()</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co"> */</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">struct</span> nfs_server {</a>
<a class="sourceLine" id="cb1-5" title="5">        <span class="kw">struct</span> nfs_client *     nfs_client;     <span class="co">/* 共享客户端和 NFS4 状态，多个 nfs_server 对应一个 nfs_client */</span></a>
<a class="sourceLine" id="cb1-6" title="6">        <span class="kw">struct</span> list_head        client_link;    <span class="co">/* 共享同一个客户端的其他 nfs_server 结构的列表 */</span></a>
<a class="sourceLine" id="cb1-7" title="7">        <span class="kw">struct</span> list_head        master_link;    <span class="co">/* 主服务器列表中的链接 */</span></a>
<a class="sourceLine" id="cb1-8" title="8">        <span class="kw">struct</span> rpc_clnt *       client;         <span class="co">/* RPC 客户端句柄 */</span></a>
<a class="sourceLine" id="cb1-9" title="9">        <span class="kw">struct</span> rpc_clnt *       client_acl;     <span class="co">/* ACL RPC 客户端句柄 */</span></a>
<a class="sourceLine" id="cb1-10" title="10">        <span class="kw">struct</span> nlm_host         *nlm_host;      <span class="co">/* NLM 客户端句柄，v2 v3 文件锁 */</span></a>
<a class="sourceLine" id="cb1-11" title="11">        <span class="kw">struct</span> nfs_iostats __percpu *io_stats;  <span class="co">/* I/O 统计信息 */</span></a>
<a class="sourceLine" id="cb1-12" title="12">        atomic_long_t           writeback;      <span class="co">/* 正在向服务器写入的页的个数 */</span></a>
<a class="sourceLine" id="cb1-13" title="13">        <span class="dt">unsigned</span> <span class="dt">int</span>            write_congested;<span class="co">/* 当写回过高时设置的标志 */</span></a>
<a class="sourceLine" id="cb1-14" title="14">        <span class="dt">unsigned</span> <span class="dt">int</span>            flags;          <span class="co">/* 各种标志，挂载选项 */</span></a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co">/* 以下仅供内部使用。另见 uapi/linux/nfs_mount.h */</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="pp">#define NFS_MOUNT_LOOKUP_CACHE_NONEG    0x10000</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="pp">#define NFS_MOUNT_LOOKUP_CACHE_NONE     0x20000</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="pp">#define NFS_MOUNT_NORESVPORT            0x40000</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="pp">#define NFS_MOUNT_LEGACY_INTERFACE      0x80000</span></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="pp">#define NFS_MOUNT_LOCAL_FLOCK           0x100000</span></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="pp">#define NFS_MOUNT_LOCAL_FCNTL           0x200000</span></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="pp">#define NFS_MOUNT_SOFTERR               0x400000</span></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="pp">#define NFS_MOUNT_SOFTREVAL             0x800000</span></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="pp">#define NFS_MOUNT_WRITE_EAGER           0x01000000</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="pp">#define NFS_MOUNT_WRITE_WAIT            0x02000000</span></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="pp">#define NFS_MOUNT_TRUNK_DISCOVERY       0x04000000</span></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="pp">#define NFS_MOUNT_SHUTDOWN              0x08000000</span></a>
<a class="sourceLine" id="cb1-29" title="29"></a>
<a class="sourceLine" id="cb1-30" title="30">        <span class="dt">unsigned</span> <span class="dt">int</span>            fattr_valid;    <span class="co">/* 有效的属性 */</span></a>
<a class="sourceLine" id="cb1-31" title="31">        <span class="dt">unsigned</span> <span class="dt">int</span>            caps;           <span class="co">/* 服务器功能，getattr 请求获取的 */</span></a>
<a class="sourceLine" id="cb1-32" title="32">        <span class="dt">unsigned</span> <span class="dt">int</span>            rsize;          <span class="co">/* 读取大小，read 请求数据最大值 */</span></a>
<a class="sourceLine" id="cb1-33" title="33">        <span class="dt">unsigned</span> <span class="dt">int</span>            rpages;         <span class="co">/* 读取大小（以页为单位） */</span></a>
<a class="sourceLine" id="cb1-34" title="34">        <span class="dt">unsigned</span> <span class="dt">int</span>            wsize;          <span class="co">/* 写入大小，write 请求数据最大值 */</span></a>
<a class="sourceLine" id="cb1-35" title="35">        <span class="dt">unsigned</span> <span class="dt">int</span>            wpages;         <span class="co">/* 写入大小（以页为单位） */</span></a>
<a class="sourceLine" id="cb1-36" title="36">        <span class="dt">unsigned</span> <span class="dt">int</span>            wtmult;         <span class="co">/* 服务器磁盘块大小 */</span></a>
<a class="sourceLine" id="cb1-37" title="37">        <span class="dt">unsigned</span> <span class="dt">int</span>            dtsize;         <span class="co">/* readdir 大小，readdir 请求 */</span></a>
<a class="sourceLine" id="cb1-38" title="38">        <span class="dt">unsigned</span> <span class="dt">short</span>          port;           <span class="co">/* &quot;port=&quot; 设置，服务器端口 */</span></a>
<a class="sourceLine" id="cb1-39" title="39">        <span class="dt">unsigned</span> <span class="dt">int</span>            bsize;          <span class="co">/* 服务器块大小 */</span></a>
<a class="sourceLine" id="cb1-40" title="40"><span class="pp">#ifdef CONFIG_NFS_V4_2</span></a>
<a class="sourceLine" id="cb1-41" title="41">        <span class="dt">unsigned</span> <span class="dt">int</span>            gxasize;        <span class="co">/* getxattr 大小 */</span></a>
<a class="sourceLine" id="cb1-42" title="42">        <span class="dt">unsigned</span> <span class="dt">int</span>            sxasize;        <span class="co">/* setxattr 大小 */</span></a>
<a class="sourceLine" id="cb1-43" title="43">        <span class="dt">unsigned</span> <span class="dt">int</span>            lxasize;        <span class="co">/* listxattr 大小 */</span></a>
<a class="sourceLine" id="cb1-44" title="44"><span class="pp">#endif</span></a>
<a class="sourceLine" id="cb1-45" title="45">        <span class="dt">unsigned</span> <span class="dt">int</span>            acregmin;       <span class="co">/* 属性缓存超时时间，普通文件缓存超时时间 */</span></a>
<a class="sourceLine" id="cb1-46" title="46">        <span class="dt">unsigned</span> <span class="dt">int</span>            acregmax;</a>
<a class="sourceLine" id="cb1-47" title="47">        <span class="dt">unsigned</span> <span class="dt">int</span>            acdirmin;       <span class="co">/* 目录缓存超时时间 */</span></a>
<a class="sourceLine" id="cb1-48" title="48">        <span class="dt">unsigned</span> <span class="dt">int</span>            acdirmax;</a>
<a class="sourceLine" id="cb1-49" title="49">        <span class="dt">unsigned</span> <span class="dt">int</span>            namelen;        <span class="co">/* 文件名最大长度 */</span></a>
<a class="sourceLine" id="cb1-50" title="50">        <span class="dt">unsigned</span> <span class="dt">int</span>            options;        <span class="co">/* 挂载启用的额外选项 */</span></a>
<a class="sourceLine" id="cb1-51" title="51">        <span class="dt">unsigned</span> <span class="dt">int</span>            clone_blksize;  <span class="co">/* CLONE 操作的粒度 */</span></a>
<a class="sourceLine" id="cb1-52" title="52"><span class="pp">#define NFS_OPTION_FSCACHE      0x00000001      </span><span class="co">/* - 本地缓存启用 */</span></a>
<a class="sourceLine" id="cb1-53" title="53"><span class="pp">#define NFS_OPTION_MIGRATION    0x00000002      </span><span class="co">/* - NFSv4 迁移启用 */</span></a>
<a class="sourceLine" id="cb1-54" title="54"></a>
<a class="sourceLine" id="cb1-55" title="55">        <span class="kw">enum</span> nfs<span class="dv">4</span><span class="er">_change_attr_type</span></a>
<a class="sourceLine" id="cb1-56" title="56">                                change_attr_type;<span class="co">/* 变更属性描述 */</span></a>
<a class="sourceLine" id="cb1-57" title="57"></a>
<a class="sourceLine" id="cb1-58" title="58">        <span class="kw">struct</span> nfs_fsid         fsid;</a>
<a class="sourceLine" id="cb1-59" title="59">        <span class="dt">int</span>                     s_sysfs_id;     <span class="co">/* sysfs dentry 索引 */</span></a>
<a class="sourceLine" id="cb1-60" title="60">        __u64                   maxfilesize;    <span class="co">/* 最大文件大小 */</span></a>
<a class="sourceLine" id="cb1-61" title="61">        <span class="kw">struct</span> timespec64       time_delta;     <span class="co">/* 最小时间粒度 */</span></a>
<a class="sourceLine" id="cb1-62" title="62">        <span class="dt">unsigned</span> <span class="dt">long</span>           mount_time;     <span class="co">/* 文件系统挂载时间 */</span></a>
<a class="sourceLine" id="cb1-63" title="63">        <span class="kw">struct</span> super_block      *super;         <span class="co">/* VFS 超级块 */</span></a>
<a class="sourceLine" id="cb1-64" title="64">        dev_t                   s_dev;          <span class="co">/* 超级块设备编号 */</span></a>
<a class="sourceLine" id="cb1-65" title="65">        <span class="kw">struct</span> nfs_auth_info    auth_info;      <span class="co">/* 解析的认证方式 */</span></a>
<a class="sourceLine" id="cb1-66" title="66"></a>
<a class="sourceLine" id="cb1-67" title="67"><span class="pp">#ifdef CONFIG_NFS_FSCACHE</span></a>
<a class="sourceLine" id="cb1-68" title="68">        <span class="kw">struct</span> fscache_volume   *fscache;       <span class="co">/* 超级块 cookie */</span></a>
<a class="sourceLine" id="cb1-69" title="69">        <span class="dt">char</span>                    *fscache_uniq;  <span class="co">/* 唯一标识符（或 NULL） */</span></a>
<a class="sourceLine" id="cb1-70" title="70"><span class="pp">#endif</span></a>
<a class="sourceLine" id="cb1-71" title="71"></a>
<a class="sourceLine" id="cb1-72" title="72">        u32                     pnfs_blksize;   <span class="co">/* layout_blksize 属性，仅 block layout 使用 */</span></a>
<a class="sourceLine" id="cb1-73" title="73"><span class="pp">#if IS_ENABLED(CONFIG_NFS_V4)</span></a>
<a class="sourceLine" id="cb1-74" title="74">        u32                     attr_bitmask[<span class="dv">3</span>];<span class="co">/* V4 位掩码，表示此文件系统上支持的一组属性 */</span></a>
<a class="sourceLine" id="cb1-75" title="75">        u32                     attr_bitmask_nl[<span class="dv">3</span>];</a>
<a class="sourceLine" id="cb1-76" title="76">                                                <span class="co">/* V4 位掩码，表示此文件系统上支持的一组属性，</span></a>
<a class="sourceLine" id="cb1-77" title="77"><span class="co">                                                   不包括标签支持位。 */</span></a>
<a class="sourceLine" id="cb1-78" title="78">        u32                     exclcreat_bitmask[<span class="dv">3</span>];</a>
<a class="sourceLine" id="cb1-79" title="79">                                                <span class="co">/* V4 位掩码，表示此文件系统上支持的排他创建属性 */</span></a>
<a class="sourceLine" id="cb1-80" title="80">        u32                     cache_consistency_bitmask[<span class="dv">3</span>];</a>
<a class="sourceLine" id="cb1-81" title="81">                                                <span class="co">/* V4 位掩码，表示服务器支持的变更属性、大小、</span></a>
<a class="sourceLine" id="cb1-82" title="82"><span class="co">                                                   ctime 和 mtime 属性的子集 */</span></a>
<a class="sourceLine" id="cb1-83" title="83">        u32                     acl_bitmask;    <span class="co">/* V4 位掩码，表示此文件系统上支持的 ACEs */</span></a>
<a class="sourceLine" id="cb1-84" title="84">        u32                     fh_expire_type; <span class="co">/* V4 位掩码，表示此文件系统的文件句柄过期类型 */</span></a>
<a class="sourceLine" id="cb1-85" title="85">        <span class="kw">struct</span> pnfs_layoutdriver_type  *pnfs_curr_ld; <span class="co">/* 活动布局驱动，有 3 种: block layout、file layout、object layout */</span></a>
<a class="sourceLine" id="cb1-86" title="86">        <span class="kw">struct</span> rpc_wait_queue   roc_rpcwaitq;   <span class="co">// rpc 任务等待队列</span></a>
<a class="sourceLine" id="cb1-87" title="87">        <span class="dt">void</span>                    *pnfs_ld_data;  <span class="co">/* 每个挂载点的数据 */</span></a>
<a class="sourceLine" id="cb1-88" title="88"></a>
<a class="sourceLine" id="cb1-89" title="89">        <span class="co">/* 以下字段由 nfs_client-&gt;cl_lock 保护 */</span></a>
<a class="sourceLine" id="cb1-90" title="90">        <span class="kw">struct</span> rb_root          state_owners;</a>
<a class="sourceLine" id="cb1-91" title="91"><span class="pp">#endif</span></a>
<a class="sourceLine" id="cb1-92" title="92">        <span class="kw">struct</span> ida              openowner_id;</a>
<a class="sourceLine" id="cb1-93" title="93">        <span class="kw">struct</span> ida              lockowner_id;</a>
<a class="sourceLine" id="cb1-94" title="94">        <span class="kw">struct</span> list_head        state_owners_lru; <span class="co">// 空闲的 nfs4_state_owner (表示客户端的用户)</span></a>
<a class="sourceLine" id="cb1-95" title="95">        <span class="kw">struct</span> list_head        layouts;        <span class="co">// pnfs_layout_hdr 链表</span></a>
<a class="sourceLine" id="cb1-96" title="96">        <span class="kw">struct</span> list_head        delegations;    <span class="co">// nfs_delegation 链表</span></a>
<a class="sourceLine" id="cb1-97" title="97">        <span class="kw">struct</span> list_head        ss_copies;</a>
<a class="sourceLine" id="cb1-98" title="98"></a>
<a class="sourceLine" id="cb1-99" title="99">        <span class="dt">unsigned</span> <span class="dt">long</span>           mig_gen;</a>
<a class="sourceLine" id="cb1-100" title="100">        <span class="dt">unsigned</span> <span class="dt">long</span>           mig_status;</a>
<a class="sourceLine" id="cb1-101" title="101"><span class="pp">#define NFS_MIG_IN_TRANSITION           (1)</span></a>
<a class="sourceLine" id="cb1-102" title="102"><span class="pp">#define NFS_MIG_FAILED                  (2)</span></a>
<a class="sourceLine" id="cb1-103" title="103"><span class="pp">#define NFS_MIG_TSM_POSSIBLE            (3)</span></a>
<a class="sourceLine" id="cb1-104" title="104"></a>
<a class="sourceLine" id="cb1-105" title="105">        <span class="dt">void</span> (*destroy)(<span class="kw">struct</span> nfs_server *);   <span class="co">// nfs_destroy_server 和 nfs4_destroy_server</span></a>
<a class="sourceLine" id="cb1-106" title="106"></a>
<a class="sourceLine" id="cb1-107" title="107">        atomic_t active; <span class="co">/* 保持对该服务器的任何活动的追踪，引用计数 */</span></a>
<a class="sourceLine" id="cb1-108" title="108"></a>
<a class="sourceLine" id="cb1-109" title="109">        <span class="co">/* mountd 相关的挂载选项 */</span></a>
<a class="sourceLine" id="cb1-110" title="110">        <span class="kw">struct</span> sockaddr_storage mountd_address; <span class="co">// mount 服务器地址</span></a>
<a class="sourceLine" id="cb1-111" title="111">        <span class="dt">size_t</span>                  mountd_addrlen; <span class="co">// mount 服务器地址长度</span></a>
<a class="sourceLine" id="cb1-112" title="112">        u32                     mountd_version; <span class="co">// mount 协议版本</span></a>
<a class="sourceLine" id="cb1-113" title="113">        <span class="dt">unsigned</span> <span class="dt">short</span>          mountd_port;    <span class="co">// mount 协议端口</span></a>
<a class="sourceLine" id="cb1-114" title="114">        <span class="dt">unsigned</span> <span class="dt">short</span>          mountd_protocol;<span class="co">// 传输层协议，默认 tcp</span></a>
<a class="sourceLine" id="cb1-115" title="115">        <span class="kw">struct</span> rpc_wait_queue   uoc_rpcwaitq;</a>
<a class="sourceLine" id="cb1-116" title="116"></a>
<a class="sourceLine" id="cb1-117" title="117">        <span class="co">/* XDR 相关信息 */</span></a>
<a class="sourceLine" id="cb1-118" title="118">        <span class="dt">unsigned</span> <span class="dt">int</span>            read_hdrsize;</a>
<a class="sourceLine" id="cb1-119" title="119"></a>
<a class="sourceLine" id="cb1-120" title="120">        <span class="co">/* 用户命名空间信息 */</span></a>
<a class="sourceLine" id="cb1-121" title="121">        <span class="dt">const</span> <span class="kw">struct</span> cred       *cred;</a>
<a class="sourceLine" id="cb1-122" title="122">        <span class="dt">bool</span>                    has_sec_mnt_opts;</a>
<a class="sourceLine" id="cb1-123" title="123">        <span class="kw">struct</span> kobject          kobj;</a>
<a class="sourceLine" id="cb1-124" title="124">};</a></code></pre></div>
<h2 id="struct-nfs_client"><span class="header-section-number">1.2</span> <code>struct nfs_client</code></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb2-1" title="1"><span class="co">/*                                                                                                 </span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co"> * nfs_client 标识我们的客户端状态到服务器。                                       </span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co"> */</span>                                                                                                </a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">struct</span> nfs_client {                                                                                </a>
<a class="sourceLine" id="cb2-5" title="5">        refcount_t              cl_count;       <span class="co">// 引用计数</span></a>
<a class="sourceLine" id="cb2-6" title="6">        atomic_t                cl_mds_count;   <span class="co">//</span></a>
<a class="sourceLine" id="cb2-7" title="7">        <span class="dt">int</span>                     cl_cons_state;  <span class="co">/* 当前构建状态 (-ve: 初始化错误)，下面的 3 种状态 */</span> </a>
<a class="sourceLine" id="cb2-8" title="8"><span class="pp">#define NFS_CS_READY            0               </span><span class="co">/* 准备使用 */</span><span class="pp">                             </span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="pp">#define NFS_CS_INITING          1               </span><span class="co">/* 正在初始化 */</span><span class="pp">                            </span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="pp">#define NFS_CS_SESSION_INITING  2               </span><span class="co">/* 正在初始化会话 */</span><span class="pp">                   </span></a>
<a class="sourceLine" id="cb2-11" title="11">        <span class="dt">unsigned</span> <span class="dt">long</span>           cl_res_state;   <span class="co">/* NFS 资源状态 */</span>                          </a>
<a class="sourceLine" id="cb2-12" title="12"><span class="pp">#define NFS_CS_CALLBACK         1               </span><span class="co">/* - 回调已启动 */</span><span class="pp">                           </span></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="pp">#define NFS_CS_IDMAP            2               </span><span class="co">/* - idmap 已启动 */</span><span class="pp">                              </span></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="pp">#define NFS_CS_RENEWD           3               </span><span class="co">/* - renewd 已启动 */</span><span class="pp">                             </span></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="pp">#define NFS_CS_STOP_RENEW       4               </span><span class="co">/* 不再需要续约状态 */</span><span class="pp">                       </span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="pp">#define NFS_CS_CHECK_LEASE_TIME 5               </span><span class="co">/* 需要检查租约时间 */</span><span class="pp">                     </span></a>
<a class="sourceLine" id="cb2-17" title="17">        <span class="dt">unsigned</span> <span class="dt">long</span>           cl_flags;       <span class="co">/* 行为开关 */</span>                            </a>
<a class="sourceLine" id="cb2-18" title="18"><span class="pp">#define NFS_CS_NORESVPORT       0               </span><span class="co">/* - 使用临时源端口 */</span><span class="pp">                     </span></a>
<a class="sourceLine" id="cb2-19" title="19"><span class="pp">#define NFS_CS_DISCRTRY         1               </span><span class="co">/* - 在 RPC 重试时断开连接 */</span><span class="pp">                    </span></a>
<a class="sourceLine" id="cb2-20" title="20"><span class="pp">#define NFS_CS_MIGRATION        2               </span><span class="co">/* - 透明状态迁移 */</span><span class="pp">                     </span></a>
<a class="sourceLine" id="cb2-21" title="21"><span class="pp">#define NFS_CS_INFINITE_SLOTS   3               </span><span class="co">/* - 不限制 TCP 槽 */</span><span class="pp">                      </span></a>
<a class="sourceLine" id="cb2-22" title="22"><span class="pp">#define NFS_CS_NO_RETRANS_TIMEOUT       4       </span><span class="co">/* - 禁用重传超时 */</span><span class="pp">                </span></a>
<a class="sourceLine" id="cb2-23" title="23"><span class="pp">#define NFS_CS_TSM_POSSIBLE     5               </span><span class="co">/* - 可能状态迁移 */</span><span class="pp">                      </span></a>
<a class="sourceLine" id="cb2-24" title="24"><span class="pp">#define NFS_CS_NOPING           6               </span><span class="co">/* - 连接时不进行 ping */</span><span class="pp">                      </span></a>
<a class="sourceLine" id="cb2-25" title="25"><span class="pp">#define NFS_CS_DS               7               </span><span class="co">/* - 服务器是 DS */</span><span class="pp">                             </span></a>
<a class="sourceLine" id="cb2-26" title="26"><span class="pp">#define NFS_CS_REUSEPORT        8               </span><span class="co">/* - 重新连接时重用源端口 */</span><span class="pp">                </span></a>
<a class="sourceLine" id="cb2-27" title="27"><span class="pp">#define NFS_CS_PNFS             9               </span><span class="co">/* - 服务器用于 pnfs */</span><span class="pp">                       </span></a>
<a class="sourceLine" id="cb2-28" title="28">        <span class="kw">struct</span> sockaddr_storage cl_addr;        <span class="co">/* 服务器标识，服务器 ip 和端口 */</span></a>
<a class="sourceLine" id="cb2-29" title="29">        <span class="dt">size_t</span>                  cl_addrlen;     <span class="co">// cl_addr 的长度</span></a>
<a class="sourceLine" id="cb2-30" title="30">        <span class="dt">char</span> *                  cl_hostname;    <span class="co">/* 服务器的主机名 */</span>                           </a>
<a class="sourceLine" id="cb2-31" title="31">        <span class="dt">char</span> *                  cl_acceptor;    <span class="co">/* GSSAPI 接收者名称 */</span>                         </a>
<a class="sourceLine" id="cb2-32" title="32">        <span class="kw">struct</span> list_head        cl_share_link;  <span class="co">/* 全局客户端列表中的链接 */</span>                   </a>
<a class="sourceLine" id="cb2-33" title="33">        <span class="kw">struct</span> list_head        cl_superblocks; <span class="co">/* nfs_server 结构体列表，一个 nfs_client 包含多个 nfs_server */</span>                   </a>
<a class="sourceLine" id="cb2-34" title="34">                                                                                                   </a>
<a class="sourceLine" id="cb2-35" title="35">        <span class="kw">struct</span> rpc_clnt *       cl_rpcclient;   <span class="co">// 与 nfs_server 无关的 RPC 请求时使用</span></a>
<a class="sourceLine" id="cb2-36" title="36">        <span class="dt">const</span> <span class="kw">struct</span> nfs_rpc_ops *rpc_ops;      <span class="co">/* NFS 协议向量，有 nfs_v2_clientops、nfs_v3_clientops、nfs_v4_clientops */</span>                          </a>
<a class="sourceLine" id="cb2-37" title="37">        <span class="dt">int</span>                     cl_proto;       <span class="co">/* 网络传输协议，默认 tcp */</span></a>
<a class="sourceLine" id="cb2-38" title="38">        <span class="kw">struct</span> nfs_subversion * cl_nfs_mod;     <span class="co">/* 指向 nfs 版本模块的指针 */</span>                </a>
<a class="sourceLine" id="cb2-39" title="39">                                                                                                   </a>
<a class="sourceLine" id="cb2-40" title="40">        u32                     cl_minorversion;<span class="co">/* NFSv4 次要版本 */</span>                           </a>
<a class="sourceLine" id="cb2-41" title="41">        <span class="dt">unsigned</span> <span class="dt">int</span>            cl_nconnect;    <span class="co">/* 连接数 */</span>                        </a>
<a class="sourceLine" id="cb2-42" title="42">        <span class="dt">unsigned</span> <span class="dt">int</span>            cl_max_connect; <span class="co">/* 允许的最大传输数 */</span>                  </a>
<a class="sourceLine" id="cb2-43" title="43">        <span class="dt">const</span> <span class="dt">char</span> *            cl_principal;   <span class="co">/* 用于机器凭证 */</span>                        </a>
<a class="sourceLine" id="cb2-44" title="44">        <span class="kw">struct</span> xprtsec_parms    cl_xprtsec;     <span class="co">/* 传输安全策略 */</span>                         </a>
<a class="sourceLine" id="cb2-45" title="45">                                                                                                   </a>
<a class="sourceLine" id="cb2-46" title="46"><span class="pp">#if IS_ENABLED(CONFIG_NFS_V4)                                                                      </span></a>
<a class="sourceLine" id="cb2-47" title="47">        <span class="kw">struct</span> list_head        cl_ds_clients; <span class="co">/* 认证方式的服务器数据 */</span>                      </a>
<a class="sourceLine" id="cb2-48" title="48">        u64                     cl_clientid;    <span class="co">/* 常量 */</span>                                     </a>
<a class="sourceLine" id="cb2-49" title="49">        nfs4_verifier           cl_confirm;     <span class="co">/* 客户端 ID 验证器 */</span>                            </a>
<a class="sourceLine" id="cb2-50" title="50">        <span class="dt">unsigned</span> <span class="dt">long</span>           cl_state;                                                          </a>
<a class="sourceLine" id="cb2-51" title="51">                                                                                                   </a>
<a class="sourceLine" id="cb2-52" title="52">        spinlock_t              cl_lock;                                                           </a>
<a class="sourceLine" id="cb2-53" title="53">                                                                              </a>
<a class="sourceLine" id="cb2-54" title="54">        <span class="dt">unsigned</span> <span class="dt">long</span>           cl_lease_time;  <span class="co">// 一般为 90s</span></a>
<a class="sourceLine" id="cb2-55" title="55">        <span class="dt">unsigned</span> <span class="dt">long</span>           cl_last_renewal;</a>
<a class="sourceLine" id="cb2-56" title="56">        <span class="kw">struct</span> delayed_work     cl_renewd;      <span class="co">// 超时调用 nfs4_renew_state()</span></a>
<a class="sourceLine" id="cb2-57" title="57">                                                                              </a>
<a class="sourceLine" id="cb2-58" title="58">        <span class="kw">struct</span> rpc_wait_queue   cl_rpcwaitq;                                  </a>
<a class="sourceLine" id="cb2-59" title="59">                                                                              </a>
<a class="sourceLine" id="cb2-60" title="60">        <span class="co">/* idmapper */</span>                                                        </a>
<a class="sourceLine" id="cb2-61" title="61">        <span class="kw">struct</span> idmap *          cl_idmap;                                     </a>
<a class="sourceLine" id="cb2-62" title="62">                                                                              </a>
<a class="sourceLine" id="cb2-63" title="63">        <span class="co">/* 客户端所有者标识符 */</span>                                         </a>
<a class="sourceLine" id="cb2-64" title="64">        <span class="dt">const</span> <span class="dt">char</span> *            cl_owner_id;                                  </a>
<a class="sourceLine" id="cb2-65" title="65">                                                                              </a>
<a class="sourceLine" id="cb2-66" title="66">        u32                     cl_cb_ident;    <span class="co">/* v4.0 回调标识符 */</span></a>
<a class="sourceLine" id="cb2-67" title="67">        <span class="dt">const</span> <span class="kw">struct</span> nfs4_minor_version_ops *cl_mvops;                        </a>
<a class="sourceLine" id="cb2-68" title="68">        <span class="dt">unsigned</span> <span class="dt">long</span>           cl_mig_gen;                                   </a>
<a class="sourceLine" id="cb2-69" title="69">                                                                              </a>
<a class="sourceLine" id="cb2-70" title="70">        <span class="co">/* NFSv4.0 传输阻塞 */</span>                                      </a>
<a class="sourceLine" id="cb2-71" title="71">        <span class="kw">struct</span> nfs4_slot_table  *cl_slot_tbl;                                 </a>
<a class="sourceLine" id="cb2-72" title="72">                                                                              </a>
<a class="sourceLine" id="cb2-73" title="73">        <span class="co">/* 用于下一个 CREATE_SESSION 的序列 ID */</span>              </a>
<a class="sourceLine" id="cb2-74" title="74">        u32                     cl_seqid;                                     </a>
<a class="sourceLine" id="cb2-75" title="75">        <span class="co">/* 在 EXCHANGE_ID 期间用于获取客户端 ID 的标志 */</span>    </a>
<a class="sourceLine" id="cb2-76" title="76">        u32                     cl_exchange_flags;                            </a>
<a class="sourceLine" id="cb2-77" title="77">        <span class="kw">struct</span> nfs4_session     *cl_session;    <span class="co">/* 共享会话 */</span>          </a>
<a class="sourceLine" id="cb2-78" title="78">        <span class="dt">bool</span>                    cl_preserve_clid;                             </a>
<a class="sourceLine" id="cb2-79" title="79">        <span class="kw">struct</span> nfs41_server_owner *cl_serverowner;                            </a>
<a class="sourceLine" id="cb2-80" title="80">        <span class="kw">struct</span> nfs41_server_scope *cl_serverscope;                            </a>
<a class="sourceLine" id="cb2-81" title="81">        <span class="kw">struct</span> nfs41_impl_id    *cl_implid;                                   </a>
<a class="sourceLine" id="cb2-82" title="82">        <span class="co">/* nfs 4.1+ 状态保护模式: */</span>                                </a>
<a class="sourceLine" id="cb2-83" title="83">        <span class="dt">unsigned</span> <span class="dt">long</span>           cl_sp4_flags;                                 </a>
<a class="sourceLine" id="cb2-84" title="84"><span class="pp">#define NFS_SP4_MACH_CRED_MINIMAL  1    </span><span class="co">/* 最小 sp4_mach_cred - 状态操作  </span></a>
<a class="sourceLine" id="cb2-85" title="85"><span class="co">                                         * 必须使用机器凭证 */</span><span class="pp">           </span></a>
<a class="sourceLine" id="cb2-86" title="86"><span class="pp">#define NFS_SP4_MACH_CRED_CLEANUP  2    </span><span class="co">/* CLOSE 和 LOCKU */</span><span class="pp">                 </span></a>
<a class="sourceLine" id="cb2-87" title="87"><span class="pp">#define NFS_SP4_MACH_CRED_SECINFO  3    </span><span class="co">/* SECINFO 和 SECINFO_NO_NAME */</span><span class="pp">     </span></a>
<a class="sourceLine" id="cb2-88" title="88"><span class="pp">#define NFS_SP4_MACH_CRED_STATEID  4    </span><span class="co">/* TEST_STATEID 和 FREE_STATEID */</span><span class="pp">   </span></a>
<a class="sourceLine" id="cb2-89" title="89"><span class="pp">#define NFS_SP4_MACH_CRED_WRITE    5    </span><span class="co">/* WRITE */</span><span class="pp">                           </span></a>
<a class="sourceLine" id="cb2-90" title="90"><span class="pp">#define NFS_SP4_MACH_CRED_COMMIT   6    </span><span class="co">/* COMMIT */</span><span class="pp">                           </span></a>
<a class="sourceLine" id="cb2-91" title="91"><span class="pp">#define NFS_SP4_MACH_CRED_PNFS_CLEANUP  7 </span><span class="co">/* LAYOUTRETURN */</span><span class="pp">                  </span></a>
<a class="sourceLine" id="cb2-92" title="92"><span class="pp">#if IS_ENABLED(CONFIG_NFS_V4_1)                                               </span></a>
<a class="sourceLine" id="cb2-93" title="93">        wait_queue_head_t       cl_lock_waitq;                                </a>
<a class="sourceLine" id="cb2-94" title="94"><span class="pp">#endif </span><span class="co">/* CONFIG_NFS_V4_1 */</span><span class="pp">                                                  </span></a>
<a class="sourceLine" id="cb2-95" title="95"><span class="pp">#endif </span><span class="co">/* CONFIG_NFS_V4 */</span><span class="pp">                                                    </span></a>
<a class="sourceLine" id="cb2-96" title="96">                                                                              </a>
<a class="sourceLine" id="cb2-97" title="97">        <span class="co">/* 我们自己的 IP 地址，作为一个以 null 结尾的字符串。                   </span></a>
<a class="sourceLine" id="cb2-98" title="98"><span class="co">         * 这用于生成 mv0 回调地址。                 </span></a>
<a class="sourceLine" id="cb2-99" title="99"><span class="co">         */</span>                                                                   </a>
<a class="sourceLine" id="cb2-100" title="100">        <span class="dt">char</span>                    cl_ipaddr[<span class="dv">48</span>];                                </a>
<a class="sourceLine" id="cb2-101" title="101">        <span class="kw">struct</span> net              *cl_net; <span class="co">// 网络命名空间</span></a>
<a class="sourceLine" id="cb2-102" title="102">        <span class="kw">struct</span> list_head        pending_cb_stateids;                          </a>
<a class="sourceLine" id="cb2-103" title="103">};                                                </a></code></pre></div>
<h1 id="超级块操作"><span class="header-section-number">2</span> 超级块操作</h1>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// nfsv2, nfsv3</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="dt">const</span> <span class="kw">struct</span> super_operations nfs_sops = { </a>
<a class="sourceLine" id="cb3-3" title="3">        .alloc_inode    = nfs_alloc_inode, </a>
<a class="sourceLine" id="cb3-4" title="4">        .free_inode     = nfs_free_inode,  </a>
<a class="sourceLine" id="cb3-5" title="5">        .write_inode    = nfs_write_inode, </a>
<a class="sourceLine" id="cb3-6" title="6">        .drop_inode     = nfs_drop_inode,  </a>
<a class="sourceLine" id="cb3-7" title="7">        .statfs         = nfs_statfs,      </a>
<a class="sourceLine" id="cb3-8" title="8">        .evict_inode    = nfs_evict_inode, </a>
<a class="sourceLine" id="cb3-9" title="9">        .umount_begin   = nfs_umount_begin,</a>
<a class="sourceLine" id="cb3-10" title="10">        .show_options   = nfs_show_options,</a>
<a class="sourceLine" id="cb3-11" title="11">        .show_devname   = nfs_show_devname,</a>
<a class="sourceLine" id="cb3-12" title="12">        .show_path      = nfs_show_path,   </a>
<a class="sourceLine" id="cb3-13" title="13">        .show_stats     = nfs_show_stats,  </a>
<a class="sourceLine" id="cb3-14" title="14">};                                         </a>
<a class="sourceLine" id="cb3-15" title="15"></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co">// nfsv4</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> super_operations nfs4_sops = { </a>
<a class="sourceLine" id="cb3-18" title="18">        .alloc_inode    = nfs_alloc_inode,         </a>
<a class="sourceLine" id="cb3-19" title="19">        .free_inode     = nfs_free_inode,          </a>
<a class="sourceLine" id="cb3-20" title="20">        .write_inode    = nfs4_write_inode,        </a>
<a class="sourceLine" id="cb3-21" title="21">        .drop_inode     = nfs_drop_inode,          </a>
<a class="sourceLine" id="cb3-22" title="22">        .statfs         = nfs_statfs,              </a>
<a class="sourceLine" id="cb3-23" title="23">        .evict_inode    = nfs4_evict_inode,        </a>
<a class="sourceLine" id="cb3-24" title="24">        .umount_begin   = nfs_umount_begin,        </a>
<a class="sourceLine" id="cb3-25" title="25">        .show_options   = nfs_show_options,        </a>
<a class="sourceLine" id="cb3-26" title="26">        .show_devname   = nfs_show_devname,        </a>
<a class="sourceLine" id="cb3-27" title="27">        .show_path      = nfs_show_path,           </a>
<a class="sourceLine" id="cb3-28" title="28">        .show_stats     = nfs_show_stats,          </a>
<a class="sourceLine" id="cb3-29" title="29">};                                                 </a></code></pre></div>
<h1 id="索引节点"><span class="header-section-number">3</span> 索引节点</h1>
<p>nfs没有磁盘索引节点，只有内存索引节点。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" title="1"><span class="co">/*</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co"> * nfs fs inode 内存中的数据</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co"> */</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">struct</span> nfs_inode {</a>
<a class="sourceLine" id="cb4-5" title="5">        <span class="co">/*</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">         * 64位 &#39;索引节点编号&#39;</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">         */</span></a>
<a class="sourceLine" id="cb4-8" title="8">        __u64 fileid; <span class="co">// 索引节点编号</span></a>
<a class="sourceLine" id="cb4-9" title="9">        <span class="co">/*</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">         * NFS 文件句柄</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co">         */</span></a>
<a class="sourceLine" id="cb4-12" title="12">        <span class="kw">struct</span> nfs_fh           fh; <span class="co">// 文件句柄</span></a>
<a class="sourceLine" id="cb4-13" title="13">        <span class="co">/*</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="co">         * 各种标志</span></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">         */</span></a>
<a class="sourceLine" id="cb4-16" title="16">        <span class="dt">unsigned</span> <span class="dt">long</span>           flags;                  <span class="co">/* 原子位操作 */</span></a>
<a class="sourceLine" id="cb4-17" title="17">        <span class="dt">unsigned</span> <span class="dt">long</span>           cache_validity;         <span class="co">/* 位掩码 */</span></a>
<a class="sourceLine" id="cb4-18" title="18">        <span class="co">/*</span></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="co">         * read_cache_jiffies 是我们开始读取缓存这个索引节点的时间。</span></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="co">         * attrtimeo 是缓存信息被认为有效的时间。成功的属性重新验证将使</span></a>
<a class="sourceLine" id="cb4-21" title="21"><span class="co">         * attrtimeo 翻倍（最多到 acregmax/acdirmax），失败会将其重置为</span></a>
<a class="sourceLine" id="cb4-22" title="22"><span class="co">         * acregmin/acdirmin。</span></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="co">         *</span></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="co">         * 如果以下条件成立，我们需要重新验证这个索引节点的缓存属性</span></a>
<a class="sourceLine" id="cb4-25" title="25"><span class="co">         *</span></a>
<a class="sourceLine" id="cb4-26" title="26"><span class="co">         *      jiffies - read_cache_jiffies &gt;= attrtimeo</span></a>
<a class="sourceLine" id="cb4-27" title="27"><span class="co">         *</span></a>
<a class="sourceLine" id="cb4-28" title="28"><span class="co">         * 请注意比较是大于等于，这样可以指定零超时值。</span></a>
<a class="sourceLine" id="cb4-29" title="29"><span class="co">         */</span></a>
<a class="sourceLine" id="cb4-30" title="30">        <span class="dt">unsigned</span> <span class="dt">long</span>           read_cache_jiffies;     <span class="co">// 文件属性更新时间</span></a>
<a class="sourceLine" id="cb4-31" title="31">        <span class="dt">unsigned</span> <span class="dt">long</span>           attrtimeo;              <span class="co">// 文件属性超时时间</span></a>
<a class="sourceLine" id="cb4-32" title="32">        <span class="dt">unsigned</span> <span class="dt">long</span>           attrtimeo_timestamp;    <span class="co">// attrtimeo最后更新时间</span></a>
<a class="sourceLine" id="cb4-33" title="33"></a>
<a class="sourceLine" id="cb4-34" title="34">        <span class="dt">unsigned</span> <span class="dt">long</span>           attr_gencount;          <span class="co">// 文件属性相关计数</span></a>
<a class="sourceLine" id="cb4-35" title="35"></a>
<a class="sourceLine" id="cb4-36" title="36">        <span class="kw">struct</span> rb_root          access_cache;           <span class="co">// nfs_access_entry链表</span></a>
<a class="sourceLine" id="cb4-37" title="37">        <span class="kw">struct</span> list_head        access_cache_entry_lru;</a>
<a class="sourceLine" id="cb4-38" title="38">        <span class="kw">struct</span> list_head        access_cache_inode_lru;</a>
<a class="sourceLine" id="cb4-39" title="39"></a>
<a class="sourceLine" id="cb4-40" title="40">        <span class="kw">union</span> {</a>
<a class="sourceLine" id="cb4-41" title="41">                <span class="co">/* 目录 */</span></a>
<a class="sourceLine" id="cb4-42" title="42">                <span class="kw">struct</span> {</a>
<a class="sourceLine" id="cb4-43" title="43">                        <span class="co">/* 属性缓存的“生成计数器”。</span></a>
<a class="sourceLine" id="cb4-44" title="44"><span class="co">                         * 每当我们更新服务器上的元数据时，都会增加这个计数器。</span></a>
<a class="sourceLine" id="cb4-45" title="45"><span class="co">                         */</span></a>
<a class="sourceLine" id="cb4-46" title="46">                        <span class="dt">unsigned</span> <span class="dt">long</span>   cache_change_attribute;</a>
<a class="sourceLine" id="cb4-47" title="47">                        <span class="co">/*</span></a>
<a class="sourceLine" id="cb4-48" title="48"><span class="co">                         * 这是用于 NFSv3 readdir 操作的 cookie 验证器</span></a>
<a class="sourceLine" id="cb4-49" title="49"><span class="co">                         */</span></a>
<a class="sourceLine" id="cb4-50" title="50">                        __be32          cookieverf[NFS_DIR_VERIFIER_SIZE];</a>
<a class="sourceLine" id="cb4-51" title="51">                        <span class="co">/* 读操作: 正在进行的 sillydelete RPC 调用 */</span></a>
<a class="sourceLine" id="cb4-52" title="52">                        <span class="co">/* 写操作: rmdir */</span></a>
<a class="sourceLine" id="cb4-53" title="53">                        <span class="kw">struct</span> rw_semaphore     rmdir_sem;</a>
<a class="sourceLine" id="cb4-54" title="54">                };</a>
<a class="sourceLine" id="cb4-55" title="55">                <span class="co">/* 常规文件 */</span></a>
<a class="sourceLine" id="cb4-56" title="56">                <span class="kw">struct</span> {</a>
<a class="sourceLine" id="cb4-57" title="57">                        atomic_long_t   nrequests;</a>
<a class="sourceLine" id="cb4-58" title="58">                        atomic_long_t   redirtied_pages;</a>
<a class="sourceLine" id="cb4-59" title="59">                        <span class="kw">struct</span> nfs_mds_commit_info commit_info;</a>
<a class="sourceLine" id="cb4-60" title="60">                        <span class="kw">struct</span> mutex    commit_mutex;</a>
<a class="sourceLine" id="cb4-61" title="61">                };</a>
<a class="sourceLine" id="cb4-62" title="62">        };</a>
<a class="sourceLine" id="cb4-63" title="63"></a>
<a class="sourceLine" id="cb4-64" title="64">        <span class="co">/* 共享 mmap 写操作的打开上下文 */</span></a>
<a class="sourceLine" id="cb4-65" title="65">        <span class="kw">struct</span> list_head        open_files;</a>
<a class="sourceLine" id="cb4-66" title="66"></a>
<a class="sourceLine" id="cb4-67" title="67">        <span class="co">/* 跟踪乱序回复。</span></a>
<a class="sourceLine" id="cb4-68" title="68"><span class="co">         * ooo 数组包含来自 changeid 序列的开始/结束对，当索引节点的</span></a>
<a class="sourceLine" id="cb4-69" title="69"><span class="co">         * iversion 已更新时。它还包含从服务器回复中看到的 changeid 序列的</span></a>
<a class="sourceLine" id="cb4-70" title="70"><span class="co">         * 结束/开始对（即反向顺序）。</span></a>
<a class="sourceLine" id="cb4-71" title="71"><span class="co">         * 通常这些应该匹配，当 A:B 和 B:A 都在 ooo 中时，它们都会被移除。</span></a>
<a class="sourceLine" id="cb4-72" title="72"><span class="co">         * 如果回复中的 A:B 导致 iversion 更新为 A:B，则不会添加。</span></a>
<a class="sourceLine" id="cb4-73" title="73"><span class="co">         * 当回复的 pre_change 不匹配 iversion 时，则会添加 changeid 对和</span></a>
<a class="sourceLine" id="cb4-74" title="74"><span class="co">         * 任何随之而来的 iversion 变化。稍后的回复可能会填补空白，或者</span></a>
<a class="sourceLine" id="cb4-75" title="75"><span class="co">         * 可能由于另一个客户端的更改导致出现空白。</span></a>
<a class="sourceLine" id="cb4-76" title="76"><span class="co">         * 当文件或目录被打开时，如果 ooo 表不为空，则我们假定这些空白是由</span></a>
<a class="sourceLine" id="cb4-77" title="77"><span class="co">         * 另一个客户端造成的，并且我们会使缓存数据无效。</span></a>
<a class="sourceLine" id="cb4-78" title="78"><span class="co">         *</span></a>
<a class="sourceLine" id="cb4-79" title="79"><span class="co">         * 我们只能跟踪有限数量的并发空白。目前限制是 16。</span></a>
<a class="sourceLine" id="cb4-80" title="80"><span class="co">         * 我们按需分配表。如果内存不足，那么我们可能无法缓存文件，所以也</span></a>
<a class="sourceLine" id="cb4-81" title="81"><span class="co">         * 不会有损失。</span></a>
<a class="sourceLine" id="cb4-82" title="82"><span class="co">         */</span></a>
<a class="sourceLine" id="cb4-83" title="83">        <span class="kw">struct</span> {</a>
<a class="sourceLine" id="cb4-84" title="84">                <span class="dt">int</span> cnt;</a>
<a class="sourceLine" id="cb4-85" title="85">                <span class="kw">struct</span> {</a>
<a class="sourceLine" id="cb4-86" title="86">                        u64 start, end;</a>
<a class="sourceLine" id="cb4-87" title="87">                } gap[<span class="dv">16</span>];</a>
<a class="sourceLine" id="cb4-88" title="88">        } *ooo;</a>
<a class="sourceLine" id="cb4-89" title="89"></a>
<a class="sourceLine" id="cb4-90" title="90"><span class="pp">#if IS_ENABLED(CONFIG_NFS_V4)</span></a>
<a class="sourceLine" id="cb4-91" title="91">        <span class="kw">struct</span> nfs4_cached_acl  *nfs4_acl;</a>
<a class="sourceLine" id="cb4-92" title="92">        <span class="co">/* NFSv4 状态 */</span></a>
<a class="sourceLine" id="cb4-93" title="93">        <span class="kw">struct</span> list_head        open_states;</a>
<a class="sourceLine" id="cb4-94" title="94">        <span class="kw">struct</span> nfs_delegation __rcu *delegation;</a>
<a class="sourceLine" id="cb4-95" title="95">        <span class="kw">struct</span> rw_semaphore     rwsem;</a>
<a class="sourceLine" id="cb4-96" title="96"></a>
<a class="sourceLine" id="cb4-97" title="97">        <span class="co">/* pNFS 布局信息 */</span></a>
<a class="sourceLine" id="cb4-98" title="98">        <span class="kw">struct</span> pnfs_layout_hdr *layout;</a>
<a class="sourceLine" id="cb4-99" title="99"><span class="pp">#endif </span><span class="co">/* CONFIG_NFS_V4*/</span></a>
<a class="sourceLine" id="cb4-100" title="100">        <span class="co">/* 已经读写的数据量 */</span></a>
<a class="sourceLine" id="cb4-101" title="101">        __u64 write_io;</a>
<a class="sourceLine" id="cb4-102" title="102">        __u64 read_io;</a>
<a class="sourceLine" id="cb4-103" title="103"><span class="pp">#ifdef CONFIG_NFS_V4_2</span></a>
<a class="sourceLine" id="cb4-104" title="104">        <span class="kw">struct</span> nfs4_xattr_cache *xattr_cache;</a>
<a class="sourceLine" id="cb4-105" title="105"><span class="pp">#endif</span></a>
<a class="sourceLine" id="cb4-106" title="106">        <span class="kw">union</span> {</a>
<a class="sourceLine" id="cb4-107" title="107">                <span class="kw">struct</span> inode            vfs_inode;</a>
<a class="sourceLine" id="cb4-108" title="108"><span class="pp">#ifdef CONFIG_NFS_FSCACHE</span></a>
<a class="sourceLine" id="cb4-109" title="109">                <span class="kw">struct</span> netfs_inode      netfs; <span class="co">/* netfs 上下文和 VFS 索引节点 */</span></a>
<a class="sourceLine" id="cb4-110" title="110"><span class="pp">#endif</span></a>
<a class="sourceLine" id="cb4-111" title="111">        };</a>
<a class="sourceLine" id="cb4-112" title="112">};</a></code></pre></div>
<h1 id="索引节点操作"><span class="header-section-number">4</span> 索引节点操作</h1>
<h2 id="常规文件"><span class="header-section-number">4.1</span> 常规文件</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// nfsv2</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs_file_inode_operations = {</a>
<a class="sourceLine" id="cb5-3" title="3">        .permission     = nfs_permission,                         </a>
<a class="sourceLine" id="cb5-4" title="4">        .getattr        = nfs_getattr,                            </a>
<a class="sourceLine" id="cb5-5" title="5">        .setattr        = nfs_setattr,                            </a>
<a class="sourceLine" id="cb5-6" title="6">};                                                                </a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co">// nfsv3</span></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs3_file_inode_operations = {</a>
<a class="sourceLine" id="cb5-10" title="10">        .permission     = nfs_permission,                          </a>
<a class="sourceLine" id="cb5-11" title="11">        .getattr        = nfs_getattr,                             </a>
<a class="sourceLine" id="cb5-12" title="12">        .setattr        = nfs_setattr,                             </a>
<a class="sourceLine" id="cb5-13" title="13"><span class="pp">#ifdef CONFIG_NFS_V3_ACL                                           </span></a>
<a class="sourceLine" id="cb5-14" title="14">        .listxattr      = nfs3_listxattr,                          </a>
<a class="sourceLine" id="cb5-15" title="15">        .get_inode_acl  = nfs3_get_acl,                            </a>
<a class="sourceLine" id="cb5-16" title="16">        .set_acl        = nfs3_set_acl,                            </a>
<a class="sourceLine" id="cb5-17" title="17"><span class="pp">#endif                                                             </span></a>
<a class="sourceLine" id="cb5-18" title="18">};                                                                 </a>
<a class="sourceLine" id="cb5-19" title="19"></a>
<a class="sourceLine" id="cb5-20" title="20"><span class="co">// nfsv4</span></a>
<a class="sourceLine" id="cb5-21" title="21"><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs4_file_inode_operations = {</a>
<a class="sourceLine" id="cb5-22" title="22">        .permission     = nfs_permission,                          </a>
<a class="sourceLine" id="cb5-23" title="23">        .getattr        = nfs_getattr,                             </a>
<a class="sourceLine" id="cb5-24" title="24">        .setattr        = nfs_setattr,                             </a>
<a class="sourceLine" id="cb5-25" title="25">        .listxattr      = nfs4_listxattr,                          </a>
<a class="sourceLine" id="cb5-26" title="26">};                                                                 </a></code></pre></div>
<h2 id="目录"><span class="header-section-number">4.2</span> 目录</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// nfsv2</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs_dir_inode_operations = {</a>
<a class="sourceLine" id="cb6-3" title="3">        .create         = nfs_create,                            </a>
<a class="sourceLine" id="cb6-4" title="4">        .lookup         = nfs_lookup,                            </a>
<a class="sourceLine" id="cb6-5" title="5">        .link           = nfs_link,                              </a>
<a class="sourceLine" id="cb6-6" title="6">        .unlink         = nfs_unlink,                            </a>
<a class="sourceLine" id="cb6-7" title="7">        .symlink        = nfs_symlink,                           </a>
<a class="sourceLine" id="cb6-8" title="8">        .mkdir          = nfs_mkdir,                             </a>
<a class="sourceLine" id="cb6-9" title="9">        .rmdir          = nfs_rmdir,                             </a>
<a class="sourceLine" id="cb6-10" title="10">        .mknod          = nfs_mknod,                             </a>
<a class="sourceLine" id="cb6-11" title="11">        .rename         = nfs_rename,                            </a>
<a class="sourceLine" id="cb6-12" title="12">        .permission     = nfs_permission,                        </a>
<a class="sourceLine" id="cb6-13" title="13">        .getattr        = nfs_getattr,                           </a>
<a class="sourceLine" id="cb6-14" title="14">        .setattr        = nfs_setattr,                           </a>
<a class="sourceLine" id="cb6-15" title="15">};                                                               </a>
<a class="sourceLine" id="cb6-16" title="16"></a>
<a class="sourceLine" id="cb6-17" title="17"><span class="co">// nfsv3</span></a>
<a class="sourceLine" id="cb6-18" title="18"><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs3_dir_inode_operations = {</a>
<a class="sourceLine" id="cb6-19" title="19">        .create         = nfs_create,                             </a>
<a class="sourceLine" id="cb6-20" title="20">        .lookup         = nfs_lookup,                             </a>
<a class="sourceLine" id="cb6-21" title="21">        .link           = nfs_link,                               </a>
<a class="sourceLine" id="cb6-22" title="22">        .unlink         = nfs_unlink,                             </a>
<a class="sourceLine" id="cb6-23" title="23">        .symlink        = nfs_symlink,                            </a>
<a class="sourceLine" id="cb6-24" title="24">        .mkdir          = nfs_mkdir,                              </a>
<a class="sourceLine" id="cb6-25" title="25">        .rmdir          = nfs_rmdir,                              </a>
<a class="sourceLine" id="cb6-26" title="26">        .mknod          = nfs_mknod,                              </a>
<a class="sourceLine" id="cb6-27" title="27">        .rename         = nfs_rename,                             </a>
<a class="sourceLine" id="cb6-28" title="28">        .permission     = nfs_permission,                         </a>
<a class="sourceLine" id="cb6-29" title="29">        .getattr        = nfs_getattr,                            </a>
<a class="sourceLine" id="cb6-30" title="30">        .setattr        = nfs_setattr,                            </a>
<a class="sourceLine" id="cb6-31" title="31"><span class="pp">#ifdef CONFIG_NFS_V3_ACL                                          </span></a>
<a class="sourceLine" id="cb6-32" title="32">        .listxattr      = nfs3_listxattr,                         </a>
<a class="sourceLine" id="cb6-33" title="33">        .get_inode_acl  = nfs3_get_acl,                           </a>
<a class="sourceLine" id="cb6-34" title="34">        .set_acl        = nfs3_set_acl,                           </a>
<a class="sourceLine" id="cb6-35" title="35"><span class="pp">#endif                                                            </span></a>
<a class="sourceLine" id="cb6-36" title="36">};                                                                </a>
<a class="sourceLine" id="cb6-37" title="37"></a>
<a class="sourceLine" id="cb6-38" title="38"><span class="co">// nfsv4</span></a>
<a class="sourceLine" id="cb6-39" title="39"><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs4_dir_inode_operations = {</a>
<a class="sourceLine" id="cb6-40" title="40">        .create         = nfs_create,                             </a>
<a class="sourceLine" id="cb6-41" title="41">        .lookup         = nfs_lookup,                             </a>
<a class="sourceLine" id="cb6-42" title="42">        .atomic_open    = nfs_atomic_open,                        </a>
<a class="sourceLine" id="cb6-43" title="43">        .link           = nfs_link,                               </a>
<a class="sourceLine" id="cb6-44" title="44">        .unlink         = nfs_unlink,                             </a>
<a class="sourceLine" id="cb6-45" title="45">        .symlink        = nfs_symlink,                            </a>
<a class="sourceLine" id="cb6-46" title="46">        .mkdir          = nfs_mkdir,                              </a>
<a class="sourceLine" id="cb6-47" title="47">        .rmdir          = nfs_rmdir,                              </a>
<a class="sourceLine" id="cb6-48" title="48">        .mknod          = nfs_mknod,                              </a>
<a class="sourceLine" id="cb6-49" title="49">        .rename         = nfs_rename,                             </a>
<a class="sourceLine" id="cb6-50" title="50">        .permission     = nfs_permission,                         </a>
<a class="sourceLine" id="cb6-51" title="51">        .getattr        = nfs_getattr,                            </a>
<a class="sourceLine" id="cb6-52" title="52">        .setattr        = nfs_setattr,                            </a>
<a class="sourceLine" id="cb6-53" title="53">        .listxattr      = nfs4_listxattr,                         </a>
<a class="sourceLine" id="cb6-54" title="54">};                                                                </a></code></pre></div>
<h2 id="符号链接"><span class="header-section-number">4.3</span> 符号链接</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb7-1" title="1"><span class="co">/*                                                            </span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co"> * symlinks can&#39;t do much...                                  </span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co"> */</span>                                                           </a>
<a class="sourceLine" id="cb7-4" title="4"><span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs_symlink_inode_operations = {</a>
<a class="sourceLine" id="cb7-5" title="5">        .get_link       = nfs_get_link,                       </a>
<a class="sourceLine" id="cb7-6" title="6">        .getattr        = nfs_getattr,                        </a>
<a class="sourceLine" id="cb7-7" title="7">        .setattr        = nfs_setattr,                        </a>
<a class="sourceLine" id="cb7-8" title="8">};                                                            </a></code></pre></div>
<h2 id="命名空间"><span class="header-section-number">4.4</span> 命名空间</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" title="1"><span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs_mountpoint_inode_operations = {</a>
<a class="sourceLine" id="cb8-2" title="2">        .getattr        = nfs_getattr,                           </a>
<a class="sourceLine" id="cb8-3" title="3">        .setattr        = nfs_setattr,                           </a>
<a class="sourceLine" id="cb8-4" title="4">};                                                               </a>
<a class="sourceLine" id="cb8-5" title="5">                                                                 </a>
<a class="sourceLine" id="cb8-6" title="6"><span class="dt">const</span> <span class="kw">struct</span> inode_operations nfs_referral_inode_operations = {  </a>
<a class="sourceLine" id="cb8-7" title="7">        .getattr        = nfs_namespace_getattr,                 </a>
<a class="sourceLine" id="cb8-8" title="8">        .setattr        = nfs_namespace_setattr,                 </a>
<a class="sourceLine" id="cb8-9" title="9">};                                                               </a></code></pre></div>
<h1 id="dentry操作"><span class="header-section-number">5</span> <code>dentry</code>操作</h1>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb9-1" title="1"><span class="co">// nfsv2 nfsv3</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="dt">const</span> <span class="kw">struct</span> dentry_operations nfs_dentry_operations = {</a>
<a class="sourceLine" id="cb9-3" title="3">        .d_revalidate   = nfs_lookup_revalidate,        </a>
<a class="sourceLine" id="cb9-4" title="4">        .d_weak_revalidate      = nfs_weak_revalidate,  </a>
<a class="sourceLine" id="cb9-5" title="5">        .d_delete       = nfs_dentry_delete,            </a>
<a class="sourceLine" id="cb9-6" title="6">        .d_iput         = nfs_dentry_iput,              </a>
<a class="sourceLine" id="cb9-7" title="7">        .d_automount    = nfs_d_automount,              </a>
<a class="sourceLine" id="cb9-8" title="8">        .d_release      = nfs_d_release,                </a>
<a class="sourceLine" id="cb9-9" title="9">}; </a>
<a class="sourceLine" id="cb9-10" title="10"></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">// nfsv4</span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="dt">const</span> <span class="kw">struct</span> dentry_operations nfs4_dentry_operations = {</a>
<a class="sourceLine" id="cb9-13" title="13">        .d_revalidate   = nfs4_lookup_revalidate,        </a>
<a class="sourceLine" id="cb9-14" title="14">        .d_weak_revalidate      = nfs_weak_revalidate,   </a>
<a class="sourceLine" id="cb9-15" title="15">        .d_delete       = nfs_dentry_delete,             </a>
<a class="sourceLine" id="cb9-16" title="16">        .d_iput         = nfs_dentry_iput,               </a>
<a class="sourceLine" id="cb9-17" title="17">        .d_automount    = nfs_d_automount,               </a>
<a class="sourceLine" id="cb9-18" title="18">        .d_release      = nfs_d_release,                 </a>
<a class="sourceLine" id="cb9-19" title="19">};                                                       </a></code></pre></div>
<h1 id="file操作"><span class="header-section-number">6</span> <code>file</code>操作</h1>
<h2 id="常规文件-1"><span class="header-section-number">6.1</span> 常规文件</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb10-1" title="1"><span class="co">// nfsv2 nfsv3</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="dt">const</span> <span class="kw">struct</span> file_operations nfs_file_operations = {</a>
<a class="sourceLine" id="cb10-3" title="3">        .llseek         = nfs_file_llseek,          </a>
<a class="sourceLine" id="cb10-4" title="4">        .read_iter      = nfs_file_read,            </a>
<a class="sourceLine" id="cb10-5" title="5">        .write_iter     = nfs_file_write,           </a>
<a class="sourceLine" id="cb10-6" title="6">        .mmap           = nfs_file_mmap,            </a>
<a class="sourceLine" id="cb10-7" title="7">        .open           = nfs_file_open,            </a>
<a class="sourceLine" id="cb10-8" title="8">        .flush          = nfs_file_flush,           </a>
<a class="sourceLine" id="cb10-9" title="9">        .release        = nfs_file_release,         </a>
<a class="sourceLine" id="cb10-10" title="10">        .fsync          = nfs_file_fsync,           </a>
<a class="sourceLine" id="cb10-11" title="11">        .lock           = nfs_lock,                 </a>
<a class="sourceLine" id="cb10-12" title="12">        .flock          = nfs_flock,                </a>
<a class="sourceLine" id="cb10-13" title="13">        .splice_read    = nfs_file_splice_read,     </a>
<a class="sourceLine" id="cb10-14" title="14">        .splice_write   = iter_file_splice_write,   </a>
<a class="sourceLine" id="cb10-15" title="15">        .check_flags    = nfs_check_flags,          </a>
<a class="sourceLine" id="cb10-16" title="16">        .setlease       = simple_nosetlease,        </a>
<a class="sourceLine" id="cb10-17" title="17">};                                                  </a>
<a class="sourceLine" id="cb10-18" title="18"></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">// nfsv4</span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="dt">const</span> <span class="kw">struct</span> file_operations nfs4_file_operations = {</a>
<a class="sourceLine" id="cb10-21" title="21">        .read_iter      = nfs_file_read,             </a>
<a class="sourceLine" id="cb10-22" title="22">        .write_iter     = nfs_file_write,            </a>
<a class="sourceLine" id="cb10-23" title="23">        .mmap           = nfs_file_mmap,             </a>
<a class="sourceLine" id="cb10-24" title="24">        .open           = nfs4_file_open,            </a>
<a class="sourceLine" id="cb10-25" title="25">        .flush          = nfs4_file_flush,           </a>
<a class="sourceLine" id="cb10-26" title="26">        .release        = nfs_file_release,          </a>
<a class="sourceLine" id="cb10-27" title="27">        .fsync          = nfs_file_fsync,            </a>
<a class="sourceLine" id="cb10-28" title="28">        .lock           = nfs_lock,                  </a>
<a class="sourceLine" id="cb10-29" title="29">        .flock          = nfs_flock,                 </a>
<a class="sourceLine" id="cb10-30" title="30">        .splice_read    = nfs_file_splice_read,      </a>
<a class="sourceLine" id="cb10-31" title="31">        .splice_write   = iter_file_splice_write,    </a>
<a class="sourceLine" id="cb10-32" title="32">        .check_flags    = nfs_check_flags,           </a>
<a class="sourceLine" id="cb10-33" title="33">        .setlease       = nfs4_setlease,             </a>
<a class="sourceLine" id="cb10-34" title="34"><span class="pp">#ifdef CONFIG_NFS_V4_2                               </span></a>
<a class="sourceLine" id="cb10-35" title="35">        .copy_file_range = nfs4_copy_file_range,     </a>
<a class="sourceLine" id="cb10-36" title="36">        .llseek         = nfs4_file_llseek,          </a>
<a class="sourceLine" id="cb10-37" title="37">        .fallocate      = nfs42_fallocate,           </a>
<a class="sourceLine" id="cb10-38" title="38">        .remap_file_range = nfs42_remap_file_range,  </a>
<a class="sourceLine" id="cb10-39" title="39"><span class="pp">#else                                                </span></a>
<a class="sourceLine" id="cb10-40" title="40">        .llseek         = nfs_file_llseek,           </a>
<a class="sourceLine" id="cb10-41" title="41"><span class="pp">#endif                                               </span></a>
<a class="sourceLine" id="cb10-42" title="42">};                                                   </a></code></pre></div>
<h2 id="目录-1"><span class="header-section-number">6.2</span> 目录</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb11-1" title="1"><span class="dt">const</span> <span class="kw">struct</span> file_operations nfs_dir_operations = {</a>
<a class="sourceLine" id="cb11-2" title="2">        .llseek         = nfs_llseek_dir,          </a>
<a class="sourceLine" id="cb11-3" title="3">        .read           = generic_read_dir,        </a>
<a class="sourceLine" id="cb11-4" title="4">        .iterate_shared = nfs_readdir,             </a>
<a class="sourceLine" id="cb11-5" title="5">        .open           = nfs_opendir,             </a>
<a class="sourceLine" id="cb11-6" title="6">        .release        = nfs_closedir,            </a>
<a class="sourceLine" id="cb11-7" title="7">        .fsync          = nfs_fsync_dir,           </a>
<a class="sourceLine" id="cb11-8" title="8">};                                                 </a></code></pre></div>
<h1 id="address_space操作"><span class="header-section-number">7</span> <code>address_space</code>操作</h1>
<h2 id="常规文件-2"><span class="header-section-number">7.1</span> 常规文件</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb12-1" title="1"><span class="dt">const</span> <span class="kw">struct</span> address_space_operations nfs_file_aops = { </a>
<a class="sourceLine" id="cb12-2" title="2">        .read_folio = nfs_read_folio,                   </a>
<a class="sourceLine" id="cb12-3" title="3">        .readahead = nfs_readahead,                     </a>
<a class="sourceLine" id="cb12-4" title="4">        .dirty_folio = filemap_dirty_folio,             </a>
<a class="sourceLine" id="cb12-5" title="5">        .writepage = nfs_writepage,                     </a>
<a class="sourceLine" id="cb12-6" title="6">        .writepages = nfs_writepages,                   </a>
<a class="sourceLine" id="cb12-7" title="7">        .write_begin = nfs_write_begin,                 </a>
<a class="sourceLine" id="cb12-8" title="8">        .write_end = nfs_write_end,                     </a>
<a class="sourceLine" id="cb12-9" title="9">        .invalidate_folio = nfs_invalidate_folio,       </a>
<a class="sourceLine" id="cb12-10" title="10">        .release_folio = nfs_release_folio,             </a>
<a class="sourceLine" id="cb12-11" title="11">        .migrate_folio = nfs_migrate_folio,             </a>
<a class="sourceLine" id="cb12-12" title="12">        .launder_folio = nfs_launder_folio,             </a>
<a class="sourceLine" id="cb12-13" title="13">        .is_dirty_writeback = nfs_check_dirty_writeback,</a>
<a class="sourceLine" id="cb12-14" title="14">        .error_remove_page = generic_error_remove_page, </a>
<a class="sourceLine" id="cb12-15" title="15">        .swap_activate = nfs_swap_activate,             </a>
<a class="sourceLine" id="cb12-16" title="16">        .swap_deactivate = nfs_swap_deactivate,         </a>
<a class="sourceLine" id="cb12-17" title="17">        .swap_rw = nfs_swap_rw,                         </a>
<a class="sourceLine" id="cb12-18" title="18">};                                                      </a></code></pre></div>
<h2 id="目录-2"><span class="header-section-number">7.2</span> 目录</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb13-1" title="1"><span class="dt">const</span> <span class="kw">struct</span> address_space_operations nfs_dir_aops = {</a>
<a class="sourceLine" id="cb13-2" title="2">        .free_folio = nfs_readdir_clear_array,        </a>
<a class="sourceLine" id="cb13-3" title="3">};                                                    </a></code></pre></div>
<h1 id="文件系统类型"><span class="header-section-number">8</span> 文件系统类型</h1>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb14-1" title="1"><span class="co">// nfsv2 nfsv3</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw">struct</span> file_system_type nfs_fs_type = {                                     </a>
<a class="sourceLine" id="cb14-3" title="3">        .owner                  = THIS_MODULE,                              </a>
<a class="sourceLine" id="cb14-4" title="4">        .name                   = <span class="st">&quot;nfs&quot;</span>,                                    </a>
<a class="sourceLine" id="cb14-5" title="5">        .init_fs_context        = nfs_init_fs_context,                      </a>
<a class="sourceLine" id="cb14-6" title="6">        .parameters             = nfs_fs_parameters,                        </a>
<a class="sourceLine" id="cb14-7" title="7">        .kill_sb                = nfs_kill_super,                           </a>
<a class="sourceLine" id="cb14-8" title="8">        .fs_flags               = FS_RENAME_DOES_D_MOVE|FS_BINARY_MOUNTDATA,</a>
<a class="sourceLine" id="cb14-9" title="9">};                                                                          </a>
<a class="sourceLine" id="cb14-10" title="10"></a>
<a class="sourceLine" id="cb14-11" title="11"><span class="co">// nfsv4                                       </span></a>
<a class="sourceLine" id="cb14-12" title="12"><span class="kw">struct</span> file_system_type nfs4_fs_type = {                                    </a>
<a class="sourceLine" id="cb14-13" title="13">        .owner                  = THIS_MODULE,                              </a>
<a class="sourceLine" id="cb14-14" title="14">        .name                   = <span class="st">&quot;nfs4&quot;</span>,                                   </a>
<a class="sourceLine" id="cb14-15" title="15">        .init_fs_context        = nfs_init_fs_context,                      </a>
<a class="sourceLine" id="cb14-16" title="16">        .parameters             = nfs_fs_parameters,                        </a>
<a class="sourceLine" id="cb14-17" title="17">        .kill_sb                = nfs_kill_super,                           </a>
<a class="sourceLine" id="cb14-18" title="18">        .fs_flags               = FS_RENAME_DOES_D_MOVE|FS_BINARY_MOUNTDATA,</a>
<a class="sourceLine" id="cb14-19" title="19">};                                                                          </a></code></pre></div>
<h1 id="模块加载卸载方法"><span class="header-section-number">9</span> 模块加载卸载方法</h1>
<p><code>init_nfs_fs()</code>和<code>exit_nfs_fs()</code>。</p>
</body>
</html>
