<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>内核调试方法</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://chenxiaosong.com/stylesheet.css" />
</head>
<body>
<header id="title-block-header">
<!-- sign begin -->
<ul>
<li>作者: 陈孝松</li>
<li><a href="https://chenxiaosong.com/">中文主页: chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/en">英文主页: chenxiaosong.com/en</a></li>
<li><a href="https://chenxiaosong.com/video.html">哔哩哔哩教学视频: 陈孝松</a></li>
<li><a href="https://chenxiaosong.com/course.html">课程: chenxiaosong.com/course</a></li>
<li><a href="https://chenxiaosong.com/blog.html">博客: chenxiaosong.com/blog</a></li>
<li><a href="https://chenxiaosong.com/contribution.html">贡献: chenxiaosong.com/contribution</a></li>
<li>邮箱: <a href="mailto:chenxiaosong@chenxiaosong.com" class="email">chenxiaosong@chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/q.html">QQ交流群: 544216206, 点击查看群介绍</a></li>
</ul>
<!-- sign end -->
<h1 class="title">内核调试方法</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#安装调试相关软件"><span class="toc-section-number">1</span> 安装调试相关软件</a><ul>
<li><a href="#ubuntu"><span class="toc-section-number">1.1</span> ubuntu</a></li>
<li><a href="#fedora"><span class="toc-section-number">1.2</span> fedora</a></li>
<li><a href="#qemu"><span class="toc-section-number">1.3</span> qemu</a></li>
</ul></li>
<li><a href="#ftrace"><span class="toc-section-number">2</span> <code>ftrace</code></a><ul>
<li><a href="#irqsoff"><span class="toc-section-number">2.1</span> <code>irqsoff</code></a></li>
<li><a href="#function和function_graph"><span class="toc-section-number">2.2</span> <code>function</code>和<code>function_graph</code></a></li>
<li><a href="#tracepoint"><span class="toc-section-number">2.3</span> <code>tracepoint</code></a></li>
<li><a href="#trace-cmd-和kernelshark"><span class="toc-section-number">2.4</span> <code>trace-cmd</code> 和<code>kernelshark</code></a></li>
<li><a href="#trace_marker"><span class="toc-section-number">2.5</span> <code>trace_marker</code></a></li>
</ul></li>
<li><a href="#kprobe"><span class="toc-section-number">3</span> <code>kprobe</code></a><ul>
<li><a href="#kprobe-trace"><span class="toc-section-number">3.1</span> <code>kprobe trace</code></a></li>
<li><a href="#kprobe-module"><span class="toc-section-number">3.2</span> 插入<code>kprobe</code>模块</a></li>
</ul></li>
<li><a href="#打印"><span class="toc-section-number">4</span> 打印</a><ul>
<li><a href="#printk"><span class="toc-section-number">4.1</span> <code>printk</code></a></li>
<li><a href="#dynamic_print"><span class="toc-section-number">4.2</span> 动态打印</a></li>
</ul></li>
<li><a href="#mydebug"><span class="toc-section-number">5</span> <code>mydebug</code>模块</a></li>
<li><a href="#kdump-crash"><span class="toc-section-number">6</span> <code>kdump</code>和<code>crash</code></a><ul>
<li><a href="#源码安装crash"><span class="toc-section-number">6.1</span> 源码安装crash</a></li>
<li><a href="#fedora环境"><span class="toc-section-number">6.2</span> fedora环境</a></li>
<li><a href="#ubuntu环境"><span class="toc-section-number">6.3</span> ubuntu环境</a></li>
<li><a href="#qemu环境"><span class="toc-section-number">6.4</span> qemu环境</a></li>
<li><a href="#crash常用命令"><span class="toc-section-number">6.5</span> <code>crash</code>常用命令</a></li>
<li><a href="#例子1"><span class="toc-section-number">6.6</span> 例子1</a><ul>
<li><a href="#查看崩溃在哪一行"><span class="toc-section-number">6.6.1</span> 查看崩溃在哪一行</a></li>
<li><a href="#file-f_pos在结构体中的偏移量"><span class="toc-section-number">6.6.2</span> <code>file-&gt;f_pos</code>在结构体中的偏移量</a></li>
<li><a href="#分析slab-cache"><span class="toc-section-number">6.6.3</span> 分析slab cache</a></li>
<li><a href="#分析汇编"><span class="toc-section-number">6.6.4</span> 分析汇编</a></li>
</ul></li>
</ul></li>
<li><a href="#systemtap"><span class="toc-section-number">7</span> <code>systemtap</code></a><ul>
<li><a href="#fedora40测试环境"><span class="toc-section-number">7.1</span> fedora40测试环境</a></li>
<li><a href="#源码安装"><span class="toc-section-number">7.2</span> 源码安装</a></li>
<li><a href="#跟踪函数"><span class="toc-section-number">7.3</span> 跟踪函数</a></li>
</ul></li>
<li><a href="#bpftrace"><span class="toc-section-number">8</span> bpftrace</a></li>
</ul>
</nav>
<p><a href="https://chenxiaosong.com/course/kernel/kernel.html">点击跳转到内核课程所有目录</a>。</p>
<p><a href="https://chenxiaosong.com/course/kernel/video.html">点击这里查看配套的教学视频</a>。</p>
<p>内核开发环境章节我们介绍过的<a href="https://chenxiaosong.com/course/kernel/environment.html#gdb">GDB调试方法</a>只适用于虚拟机中， 我们平时看代码学习时可以用一下，如果是在工作中客户遇到的问题，GDB调试方法就用不上了，这时就需要用到其他调试方法了。</p>
<h1 id="安装调试相关软件"><span class="header-section-number">1</span> 安装调试相关软件</h1>
<h2 id="ubuntu"><span class="header-section-number">1.1</span> ubuntu</h2>
<p>编译相关软件包:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">sudo</span> apt install build-essential -y</a></code></pre></div>
<p>安装<code>kernel-debuginfo</code>软件包（必须要是ubuntu server才能找到对应内核版本的软件包），参考<a href="https://ubuntu.com/server/docs/debug-symbol-packages">Debug symbol packages</a>，如果安装时下载很慢，<a href="http://ddebs.ubuntu.com/pool/main/l/linux/">也可以在仓库先下载好</a>，放到<code>/var/cache/apt/archives/partial/</code>目录再安装:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">sudo</span> apt install ubuntu-dbgsym-keyring -y</a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="bu">echo</span> <span class="st">&quot;deb http://ddebs.ubuntu.com </span><span class="va">$(</span><span class="ex">lsb_release</span> -cs<span class="va">)</span><span class="st"> main restricted universe multiverse</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="st">deb http://ddebs.ubuntu.com </span><span class="va">$(</span><span class="ex">lsb_release</span> -cs<span class="va">)</span><span class="st">-updates main restricted universe multiverse</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="st">deb http://ddebs.ubuntu.com </span><span class="va">$(</span><span class="ex">lsb_release</span> -cs<span class="va">)</span><span class="st">-proposed main restricted universe multiverse&quot;</span> <span class="kw">|</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="fu">sudo</span> tee -a /etc/apt/sources.list.d/ddebs.list</a>
<a class="sourceLine" id="cb2-7" title="7"></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="fu">sudo</span> apt-get update -y</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="fu">sudo</span> apt install linux-image-<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span>-dbgsym -y</a></code></pre></div>
<p>或者<a href="http://ddebs.ubuntu.com/pool/main/l/linux/">先下载<code>ddeb</code>文件</a>，然后:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">sudo</span> dpkg -i xxx.ddeb</a></code></pre></div>
<p>如果要编译外部模块，需要复制<code>vmlinux</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="fu">cp</span> /usr/lib/debug/boot/vmlinux-<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span> /usr/lib/modules/<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span>/build/vmlinux</a></code></pre></div>
<p>安装内核源码:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="ex">apt</span> search linux-source <span class="co"># 查看版本信息</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="ex">apt</span> install linux-source -y</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="bu">cd</span> /usr/src/linux-source-5.15.0/</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="fu">tar</span> xvf linux-source-5.15.0.tar.bz2</a></code></pre></div>
<h2 id="fedora"><span class="header-section-number">1.2</span> fedora</h2>
<p>编译相关软件包:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="fu">sudo</span> dnf groupinstall <span class="st">&quot;Development Tools&quot;</span> -y <span class="co"># 这里安装的 kernel-devel 对应的内核版本可能不一致</span></a></code></pre></div>
<p>安装<code>kernel-debuginfo</code>软件包:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="fu">sudo</span> dnf --enablerepo=fedora-debuginfo install kernel-debuginfo</a></code></pre></div>
<p>安装<code>kernel-devel</code>软件包:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">sudo</span> dnf install kernel-devel-<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span> -y <span class="co">#  kernel-headers-`uname -r` 可能会找不到</span></a></code></pre></div>
<p>如果要编译外部模块，需要复制<code>vmlinux</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="fu">cp</span> /usr/lib/debug/lib/modules/<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span>/vmlinux /usr/lib/modules/<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span>/build/</a></code></pre></div>
<p>下载内核源码:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1"><span class="co"># 如果下载太慢，可以先在其他地方下载好</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="fu">wget</span> https://kojipkgs.fedoraproject.org/packages/kernel/6.8.5/301.fc40/src/kernel-6.8.5-301.fc40.src.rpm</a>
<a class="sourceLine" id="cb10-3" title="3"><span class="fu">mkdir</span> sources</a>
<a class="sourceLine" id="cb10-4" title="4"><span class="bu">cd</span> sources/</a>
<a class="sourceLine" id="cb10-5" title="5"><span class="ex">rpm2cpio</span> ../kernel-6.8.5-301.fc40.src.rpm <span class="kw">|</span> <span class="fu">cpio</span> -idmv</a>
<a class="sourceLine" id="cb10-6" title="6"><span class="fu">tar</span> xvf linux-6.8.5.tar.xz </a></code></pre></div>
<h2 id="qemu"><span class="header-section-number">1.3</span> qemu</h2>
<p>内核编译时打开<a href="https://wiki.qemu.org/Documentation/9psetup">Documentation/9psetup</a>中的配置。虚拟机中执行脚本 <a href="https://gitee.com/chenxiaosonggitee/blog/blob/master/course/kernel/src/script/parse-cmdline.sh"><code>parse-cmdline.sh</code></a></p>
<h1 id="ftrace"><span class="header-section-number">2</span> <code>ftrace</code></h1>
<ul>
<li><a href="https://github.com/torvalds/linux/tree/master/Documentation/trace">Documentation/trace</a></li>
</ul>
<p>名字来源于 function trace。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" title="1"><span class="va">CONFIG_FTRACE=</span>y</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="va">CONFIG_HAVE_FUNCTION_TRACER=</span>y</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="va">CONFIG_HAVE_FUNCTION_GRAPH_TRACER=</span>y</a>
<a class="sourceLine" id="cb11-4" title="4"><span class="va">CONFIG_HAVE_DYNAMIC_FTRACE=</span>y</a>
<a class="sourceLine" id="cb11-5" title="5"><span class="va">CONFIG_FUNCTION_TRACER=</span>y</a>
<a class="sourceLine" id="cb11-6" title="6"><span class="va">CONFIG_IRQSOFF_TRACER=</span>y</a>
<a class="sourceLine" id="cb11-7" title="7"><span class="va">CONFIG_SCHED_TRACER=</span>y</a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co"># CONFIG_ENABLE_DEFAULT_TRACERS # 这个好像必须要关闭</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="va">CONFIG_FTRACE_SYSCALLS=</span>y</a>
<a class="sourceLine" id="cb11-10" title="10"><span class="va">CONFIG_PREEMPT_TRACER=</span>y</a>
<a class="sourceLine" id="cb11-11" title="11"><span class="va">CONFIG_DYNAMIC_FTRACE=</span>y</a></code></pre></div>
<p><code>/sys/kernel/debug/tracing/</code>目录下的常见tracer和event如下:</p>
<ul>
<li><code>available_tracers</code>: 支持的跟踪器。</li>
<li><code>available_events</code>: 支持的事件。</li>
<li><code>current_tracer</code>: 当前正在使用的跟踪器，默认为<code>nop</code>。</li>
<li><code>trace</code>: 用<code>cat</code>命令查看跟踪信息。</li>
<li><code>tracing_on</code>: 开启或暂停。</li>
<li><code>options</code>: 选项。</li>
</ul>
<h2 id="irqsoff"><span class="header-section-number">2.1</span> <code>irqsoff</code></h2>
<p>跟踪中断延迟。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1"><span class="bu">cd</span> /sys/kernel/debug/tracing/</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="bu">echo</span> 0 <span class="op">&gt;</span> options/function-trace <span class="co"># 为了减少延迟</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="bu">echo</span> irqsoff <span class="op">&gt;</span> current_tracer</a>
<a class="sourceLine" id="cb12-4" title="4"><span class="bu">echo</span> 1 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb12-5" title="5"><span class="ex">...</span> <span class="co"># 停一会儿，收集日志</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="bu">echo</span> 0 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb12-7" title="7"><span class="fu">cat</span> trace_pipe <span class="kw">|</span> <span class="fu">less</span></a></code></pre></div>
<h2 id="function和function_graph"><span class="header-section-number">2.2</span> <code>function</code>和<code>function_graph</code></h2>
<p>跟踪函数。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" title="1"><span class="bu">cd</span> /sys/kernel/debug/tracing/</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="fu">cat</span> available_filter_functions <span class="co"># 查看可跟踪的函数</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="bu">echo</span> 0 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb13-4" title="4"><span class="fu">cat</span> set_ftrace_pid</a>
<a class="sourceLine" id="cb13-5" title="5"><span class="bu">echo</span> 1234 <span class="op">&gt;</span> set_ftrace_pid <span class="co"># 指定pid</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="bu">echo</span> ext2_readdir <span class="op">&gt;</span> set_graph_function <span class="co"># 跟踪某个函数</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co"># echo function &gt; current_tracer</span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="bu">echo</span> function_graph <span class="op">&gt;</span> current_tracer <span class="co"># 更加直观</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="bu">echo</span> 1 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb13-10" title="10"><span class="ex">...</span> <span class="co"># 收集日志</span></a>
<a class="sourceLine" id="cb13-11" title="11"><span class="bu">echo</span> 0 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb13-12" title="12"><span class="fu">cat</span> trace_pipe <span class="kw">|</span> <span class="fu">less</span></a></code></pre></div>
<p>还可以指定要跟踪和不跟踪的函数，需要打开配置<code>CONFIG_DYNAMIC_FTRACE</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" title="1"><span class="bu">echo</span> func1 func2 <span class="op">&gt;</span> set_ftrace_filter <span class="co"># 要跟踪的函数</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="bu">echo</span> func3 func4 <span class="op">&gt;</span> set_ftrace_notrace <span class="co"># 不跟踪的函数</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="bu">echo</span> <span class="st">&#39;ext2_*&#39;</span> <span class="op">&gt;&gt;</span> set_ftrace_filter <span class="co"># ext2_ 开头的函数</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="bu">echo</span> <span class="st">&#39;*ext4*&#39;</span> <span class="op">&gt;&gt;</span> set_ftrace_notrace <span class="co"># 包含ext4的函数</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="bu">echo</span> <span class="op">&gt;</span> set_ftrace_notrace <span class="co"># 清空</span></a></code></pre></div>
<h2 id="tracepoint"><span class="header-section-number">2.3</span> <code>tracepoint</code></h2>
<p>比如我们要打开<code>ext2_dio_read_iter()</code>函数的<code>ext2_dio_read_begin</code>的tracepoint:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" title="1"><span class="bu">cd</span> /sys/kernel/debug/tracing/</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="bu">echo</span> nop <span class="op">&gt;</span> current_tracer</a>
<a class="sourceLine" id="cb15-3" title="3"><span class="bu">echo</span> 1 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb15-4" title="4"><span class="fu">cat</span> available_events  <span class="kw">|</span> <span class="fu">grep</span> ext2</a>
<a class="sourceLine" id="cb15-5" title="5"><span class="bu">echo</span> ext2:ext2_dio_read_begin <span class="op">&gt;</span> set_event <span class="co"># 打开某个tracepoint</span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="bu">echo</span> ext2:* <span class="op">&gt;</span> set_event <span class="co"># 打开所有的ext2跟踪点</span></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="co"># find events/ -name &quot;*ext2*&quot; # 也可以通过find查找tracepoint所在位置，比较慢</span></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="co"># echo 1 &gt; events/ext2/ext2_dio_read_begin/enable # 打开某个tracepoint</span></a>
<a class="sourceLine" id="cb15-9" title="9"><span class="co"># echo 1 &gt; events/ext2/enable # 打开所有的ext2跟踪点</span></a>
<a class="sourceLine" id="cb15-10" title="10"></a>
<a class="sourceLine" id="cb15-11" title="11"><span class="ex">fallocate</span> -l 10M ~/image</a>
<a class="sourceLine" id="cb15-12" title="12"><span class="ex">mkfs.ext2</span> -F image</a>
<a class="sourceLine" id="cb15-13" title="13"><span class="fu">mount</span> image /mnt</a>
<a class="sourceLine" id="cb15-14" title="14"><span class="bu">echo</span> 1234567890 <span class="op">&gt;</span> /mnt/file-in</a>
<a class="sourceLine" id="cb15-15" title="15"><span class="fu">dd</span> if=/mnt/file-in of=~/file-out iflag=direct bs=512 count=1 <span class="co"># bs不能随意指定</span></a>
<a class="sourceLine" id="cb15-16" title="16"><span class="bu">echo</span> 0 <span class="op">&gt;</span> trace <span class="co"># 清除trace信息</span></a>
<a class="sourceLine" id="cb15-17" title="17"><span class="fu">cat</span> trace_pipe</a></code></pre></div>
<p>到相应<code>tracepoint</code>的目录下，设置跟踪条件:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" title="1"><span class="bu">cd</span> /sys/kernel/debug/tracing/</a>
<a class="sourceLine" id="cb16-2" title="2"><span class="bu">cd</span> events/ext2/ext2_dio_read_begin</a>
<a class="sourceLine" id="cb16-3" title="3"><span class="fu">ls</span> <span class="co"># enable  filter  format  hist  id  trigger</span></a></code></pre></div>
<h2 id="trace-cmd-和kernelshark"><span class="header-section-number">2.4</span> <code>trace-cmd</code> 和<code>kernelshark</code></h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb17-1" title="1"><span class="fu">sudo</span> apt install trace-cmd -y</a></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" title="1"><span class="fu">sudo</span> apt install kernelshark -y <span class="co"># 图形界面</span></a></code></pre></div>
<p>使用按照<code>reset -&gt; record -&gt; stop -&gt; report</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" title="1"><span class="ex">trace-cmd</span> record -h <span class="co"># 查看帮助</span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="ex">trace-cmd</span> record -e <span class="st">&#39;ext2_dio_read_begin&#39;</span> <span class="co"># 输出文件 trace.dat</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="ex">trace-cmd</span> report trace.dat <span class="co"># 字符界面解析数据</span></a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" title="1"><span class="ex">kernelshark</span> trace.dat <span class="co">#  图形化查看数据</span></a></code></pre></div>
<h2 id="trace_marker"><span class="header-section-number">2.5</span> <code>trace_marker</code></h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" title="1"><span class="bu">cd</span> /sys/kernel/debug/tracing/</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="bu">echo</span> nop <span class="op">&gt;</span> current_tracer <span class="co"># 必须要是nop</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="bu">echo</span> 1 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb21-4" title="4"><span class="bu">echo</span> <span class="st">&quot;hello trace_marker&quot;</span> <span class="op">&gt;</span> trace_marker</a>
<a class="sourceLine" id="cb21-5" title="5"><span class="bu">echo</span> 0 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb21-6" title="6"><span class="fu">cat</span> trace_pipe <span class="kw">|</span> <span class="fu">less</span></a></code></pre></div>
<h1 id="kprobe"><span class="header-section-number">3</span> <code>kprobe</code></h1>
<ul>
<li><a href="https://github.com/torvalds/linux/tree/master/Documentation/trace">Documentation/trace</a></li>
<li><a href="https://blog.csdn.net/luckyapple1028?type=blog">csdn luckyapple1028</a></li>
</ul>
<h2 id="kprobe-trace"><span class="header-section-number">3.1</span> <code>kprobe trace</code></h2>
<p>kprobe的使用如下:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" title="1"><span class="va">kprobe_func_name=</span>ext2_readdir</a>
<a class="sourceLine" id="cb22-2" title="2"></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="bu">cd</span> /sys/kernel/debug/tracing/</a>
<a class="sourceLine" id="cb22-4" title="4"><span class="co"># 可以用 kprobe 跟踪的函数</span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="fu">cat</span> available_filter_functions <span class="kw">|</span> <span class="fu">grep</span> <span class="va">${kprobe_func_name}</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="bu">echo</span> 1 <span class="op">&gt;</span> tracing_on</a>
<a class="sourceLine" id="cb22-7" title="7"></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="bu">echo</span> <span class="st">&quot;p:p_</span><span class="va">${kprobe_func_name}</span><span class="st"> </span><span class="va">${kprobe_func_name}</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events <span class="co"># 不打印函数参数</span></a>
<a class="sourceLine" id="cb22-9" title="9"><span class="co"># x86_64函数参数用到的寄存器: RDI, RSI, RDX, RCX, R8, R9</span></a>
<a class="sourceLine" id="cb22-10" title="10"><span class="co"># aarch64函数参数用到的寄存器: X0 ~ X7</span></a>
<a class="sourceLine" id="cb22-11" title="11"><span class="co"># f_mode 在 file 结构体中的偏移为 20, x32代表32位（4字节），注意 rdi 寄存器要写成 di</span></a>
<a class="sourceLine" id="cb22-12" title="12"><span class="bu">echo</span> <span class="st">&quot;p:p_</span><span class="va">${kprobe_func_name}</span><span class="st"> </span><span class="va">${kprobe_func_name}</span><span class="st"> err=+20(%di):x32&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events <span class="co"># x86_64</span></a>
<a class="sourceLine" id="cb22-13" title="13"><span class="bu">echo</span> <span class="st">&quot;p:p_</span><span class="va">${kprobe_func_name}</span><span class="st"> </span><span class="va">${kprobe_func_name}</span><span class="st"> err=+20(%x0):x32&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events <span class="co"># aarch64</span></a>
<a class="sourceLine" id="cb22-14" title="14"><span class="bu">echo</span> 1 <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/enable</a>
<a class="sourceLine" id="cb22-15" title="15"><span class="bu">echo</span> stacktrace <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/trigger <span class="co"># 打印栈</span></a>
<a class="sourceLine" id="cb22-16" title="16"><span class="bu">echo</span> <span class="st">&#39;!stacktrace&#39;</span> <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/trigger <span class="co"># 关闭栈</span></a>
<a class="sourceLine" id="cb22-17" title="17"><span class="bu">echo</span> 0 <span class="op">&gt;</span> events/kprobes/p_<span class="va">${kprobe_func_name}</span>/enable</a>
<a class="sourceLine" id="cb22-18" title="18"><span class="bu">echo</span> <span class="st">&quot;-:p_</span><span class="va">${kprobe_func_name}</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events</a>
<a class="sourceLine" id="cb22-19" title="19"></a>
<a class="sourceLine" id="cb22-20" title="20"><span class="co"># kretprobe，可以跟踪函数返回值</span></a>
<a class="sourceLine" id="cb22-21" title="21"><span class="bu">echo</span> <span class="st">&quot;r:r_</span><span class="va">${kprobe_func_name}</span><span class="st"> </span><span class="va">${kprobe_func_name}</span><span class="st"> ret=</span><span class="dt">\$</span><span class="st">retval&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events <span class="co"># 双绰号要用 \$</span></a>
<a class="sourceLine" id="cb22-22" title="22"><span class="bu">echo</span> <span class="st">&#39;r:r_&#39;</span><span class="va">${kprobe_func_name}</span><span class="st">&#39; &#39;</span><span class="va">${kprobe_func_name}</span><span class="st">&#39; ret=$retval&#39;</span> <span class="op">&gt;&gt;</span> kprobe_events <span class="co"># 注意这里是单引号</span></a>
<a class="sourceLine" id="cb22-23" title="23"><span class="bu">echo</span> 1 <span class="op">&gt;</span> events/kprobes/r_<span class="va">${kprobe_func_name}</span>/enable</a>
<a class="sourceLine" id="cb22-24" title="24"><span class="bu">echo</span> stacktrace <span class="op">&gt;</span> events/kprobes/r_<span class="va">${kprobe_func_name}</span>/trigger</a>
<a class="sourceLine" id="cb22-25" title="25"><span class="bu">echo</span> <span class="st">&#39;!stacktrace&#39;</span> <span class="op">&gt;</span> events/kprobes/r_<span class="va">${kprobe_func_name}</span>/trigger</a>
<a class="sourceLine" id="cb22-26" title="26"><span class="bu">echo</span> 0 <span class="op">&gt;</span> events/kprobes/r_<span class="va">${kprobe_func_name}</span>/enable</a>
<a class="sourceLine" id="cb22-27" title="27"><span class="bu">echo</span> <span class="st">&quot;-:r_</span><span class="va">${kprobe_func_name}</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> kprobe_events</a>
<a class="sourceLine" id="cb22-28" title="28"></a>
<a class="sourceLine" id="cb22-29" title="29"><span class="bu">echo</span> 0 <span class="op">&gt;</span> trace <span class="co"># 清除trace信息</span></a>
<a class="sourceLine" id="cb22-30" title="30"><span class="fu">cat</span> trace_pipe</a></code></pre></div>
<h2 id="kprobe-module"><span class="header-section-number">3.2</span> 插入<code>kprobe</code>模块</h2>
<p>参考 <a href="https://gitee.com/chenxiaosonggitee/blog/blob/master/course/kernel/src/kprobe">kprobes</a> 里的例子。</p>
<h1 id="打印"><span class="header-section-number">4</span> 打印</h1>
<h2 id="printk"><span class="header-section-number">4.1</span> <code>printk</code></h2>
<ul>
<li><a href="https://www.kernel.org/doc/html/latest/translations/zh_CN/core-api/printk-basics.html">使用printk记录消息</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/translations/zh_CN/core-api/printk-formats.html">如何获得正确的printk格式占位符</a></li>
</ul>
<p>8个打印等级:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb23-1" title="1"><span class="pp">#define KERN_EMERG      KERN_SOH &quot;0&quot;    </span><span class="co">/* 系统不可用 */</span><span class="pp">              </span></a>
<a class="sourceLine" id="cb23-2" title="2"><span class="pp">#define KERN_ALERT      KERN_SOH &quot;1&quot;    </span><span class="co">/* 需要立刻处理 */</span></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="pp">#define KERN_CRIT       KERN_SOH &quot;2&quot;    </span><span class="co">/* 紧急 */</span><span class="pp">             </span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="pp">#define KERN_ERR        KERN_SOH &quot;3&quot;    </span><span class="co">/* 错误 */</span><span class="pp">                </span></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="pp">#define KERN_WARNING    KERN_SOH &quot;4&quot;    </span><span class="co">/* 警告 */</span><span class="pp">              </span></a>
<a class="sourceLine" id="cb23-6" title="6"><span class="pp">#define KERN_NOTICE     KERN_SOH &quot;5&quot;    </span><span class="co">/* 重要提示 */</span></a>
<a class="sourceLine" id="cb23-7" title="7"><span class="pp">#define KERN_INFO       KERN_SOH &quot;6&quot;    </span><span class="co">/* 提示 */</span><span class="pp">                   </span></a>
<a class="sourceLine" id="cb23-8" title="8"><span class="pp">#define KERN_DEBUG      KERN_SOH &quot;7&quot;    </span><span class="co">/* 调试信息 */</span><span class="pp">            </span></a></code></pre></div>
<p>默认配置是等级高于<code>CONFIG_CONSOLE_LOGLEVEL_DEFAULT</code>会打印，qemu启动时可以指定<code>append="... loglevel=8</code>。</p>
<p><code>/proc/sys/kernel/printk</code>文件中的内容含义如下:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb24-1" title="1"><span class="dt">int</span> console_printk[<span class="dv">4</span>] = {                                             </a>
<a class="sourceLine" id="cb24-2" title="2">        CONSOLE_LOGLEVEL_DEFAULT,       <span class="co">/* 控制台输出等级 */</span>        </a>
<a class="sourceLine" id="cb24-3" title="3">        MESSAGE_LOGLEVEL_DEFAULT,       <span class="co">/* 默认消息输出等级 */</span></a>
<a class="sourceLine" id="cb24-4" title="4">        CONSOLE_LOGLEVEL_MIN,           <span class="co">/* 最低输出等级 */</span></a>
<a class="sourceLine" id="cb24-5" title="5">        CONSOLE_LOGLEVEL_DEFAULT,       <span class="co">/* 默认控制台输出等级，启动时 */</span></a>
<a class="sourceLine" id="cb24-6" title="6">};                                                                    </a></code></pre></div>
<p>常用的输出函数有<code>print_hex_dump()</code>和<code>dump_stack()</code>。</p>
<p><code>include/asm-generic/bug.h</code>文件中的<code>BUG_ON(condition)</code>当满足条件（<code>condition == true</code>）时会panic。<code>WARN_ON(condition)</code>当满足条件（<code>condition == true</code>）时不会panic，只会打印信息。</p>
<h2 id="dynamic_print"><span class="header-section-number">4.2</span> 动态打印</h2>
<p>打开配置<code>CONFIG_DYNAMIC_DEBUG</code>。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb25-1" title="1"><span class="bu">cd</span> /sys/kernel/debug/dynamic_debug/</a>
<a class="sourceLine" id="cb25-2" title="2"><span class="fu">cat</span> control <span class="kw">|</span> <span class="fu">less</span> <span class="co"># 查看所有的动态打印</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="bu">echo</span> <span class="st">&#39;file fs/ext4/extents.c +p&#39;</span> <span class="op">&gt;</span> control <span class="co"># 打开文件中所有的动态打印</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="bu">echo</span> <span class="st">&#39;module ext4 -p&#39;</span> <span class="op">&gt;</span> control <span class="co"># 关闭ext4模块所有动态打印</span></a>
<a class="sourceLine" id="cb25-5" title="5"><span class="bu">echo</span> <span class="st">&#39;func ext4_ext_binsearch +p&#39;</span> <span class="op">&gt;</span> control <span class="co"># 打开某个函数的打印</span></a>
<a class="sourceLine" id="cb25-6" title="6"><span class="bu">echo</span> -n <span class="st">&#39;*ext4* -p&#39;</span> <span class="op">&gt;</span> control <span class="co"># 关闭文件路径中包含ext4的打印</span></a>
<a class="sourceLine" id="cb25-7" title="7"><span class="bu">echo</span> -n <span class="st">&#39;+p&#39;</span> <span class="op">&gt;</span> control <span class="co"># 所有打印</span></a></code></pre></div>
<p>系统启动相关的代码（如<code>smpboot</code>），需要在启动时传递参数:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb26-1" title="1"><span class="co"># p: 打开</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="co"># f: 函数名</span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="co"># l: 行号</span></a>
<a class="sourceLine" id="cb26-4" title="4"><span class="co"># m: 模块名</span></a>
<a class="sourceLine" id="cb26-5" title="5"><span class="co"># t: 线程id</span></a>
<a class="sourceLine" id="cb26-6" title="6"><span class="ex">qemu-system-x86_64</span> -append <span class="st">&quot;... smpboot.dyndbg=+plftm&quot;</span></a></code></pre></div>
<p>也可以修改子系统的<code>Makefile</code>，添加以下内容:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb27-1" title="1"><span class="ex">ccflags-y</span> += -DDEBUG</a>
<a class="sourceLine" id="cb27-2" title="2"><span class="ex">ccflags-y</span> += -DVERBOSE_DEBUG</a></code></pre></div>
<h1 id="mydebug"><span class="header-section-number">5</span> <code>mydebug</code>模块</h1>
<p>为了方便调试，我自己写了一个<a href="https://gitee.com/chenxiaosonggitee/blog/tree/master/course/kernel/src/mydebug"><code>mydebug</code>模块</a>， 4.19内核合入<a href="https://gitee.com/chenxiaosonggitee/blog/blob/master/course/kernel/src/mydebug/0001-mydebug-common.patch"><code>0001-mydebug-common.patch</code></a>和 <a href="https://gitee.com/chenxiaosonggitee/blog/blob/master/course/kernel/src/mydebug/0002-mydebug-4.19.patch"><code>0002-mydebug-4.19.patch</code></a>， 主线最新代码合入<a href="https://gitee.com/chenxiaosonggitee/blog/blob/master/course/kernel/src/mydebug/0001-mydebug-common.patch"><code>0001-mydebug-common.patch</code></a>和 <a href="https://gitee.com/chenxiaosonggitee/blog/blob/master/course/kernel/src/mydebug/0002-mydebug-mainline.patch"><code>0002-mydebug-mainline.patch</code></a>。</p>
<p>改变<code>/sys/class/mydebug-ctrl/debug</code>文件的值就能控制调试开关:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb28-1" title="1"><span class="fu">cat</span> /sys/class/mydebug-ctrl/debug <span class="co"># 开机时默认打开第0个开关</span></a>
<a class="sourceLine" id="cb28-2" title="2"><span class="bu">echo</span> 31 <span class="op">&gt;</span> /sys/class/mydebug-ctrl/debug <span class="co"># 打开第31个开关</span></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="bu">echo</span> 32 <span class="op">&gt;</span> /sys/class/mydebug-ctrl/debug <span class="co"># 无效，总共32个开关（0 ~ 31）</span></a>
<a class="sourceLine" id="cb28-4" title="4"><span class="bu">echo</span> all <span class="op">&gt;</span> /sys/class/mydebug-ctrl/debug <span class="co"># 打开全部开头</span></a>
<a class="sourceLine" id="cb28-5" title="5"><span class="bu">echo</span> all <span class="op">&gt;</span> /sys/class/mydebug-ctrl/debug <span class="co"># 再执行一次就是关闭全部开头</span></a></code></pre></div>
<p>代码使用示例:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb29-1" title="1">...</a>
<a class="sourceLine" id="cb29-2" title="2"><span class="pp">#include </span><span class="im">&lt;mydebug.h&gt;</span></a>
<a class="sourceLine" id="cb29-3" title="3">...</a>
<a class="sourceLine" id="cb29-4" title="4"><span class="dt">int</span> this_is_func(<span class="dt">int</span> arg0, <span class="dt">int</span> arg1)</a>
<a class="sourceLine" id="cb29-5" title="5">{</a>
<a class="sourceLine" id="cb29-6" title="6">        ...</a>
<a class="sourceLine" id="cb29-7" title="7">        mydebug_print(<span class="st">&quot;mydebug_print()</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb29-8" title="8">        ...</a>
<a class="sourceLine" id="cb29-9" title="9">        <span class="cf">if</span> (mydebug_on_types &amp; BIT(<span class="dv">2</span>)) {</a>
<a class="sourceLine" id="cb29-10" title="10">                ...</a>
<a class="sourceLine" id="cb29-11" title="11">                printk(<span class="st">&quot;%s:%d, BIT(2)</span><span class="sc">\n</span><span class="st">&quot;</span>, __func__, __LINE__);</a>
<a class="sourceLine" id="cb29-12" title="12">        }</a>
<a class="sourceLine" id="cb29-13" title="13">        ...</a>
<a class="sourceLine" id="cb29-14" title="14">        mydebug_dump_stack();</a>
<a class="sourceLine" id="cb29-15" title="15">}</a></code></pre></div>
<p><code>mydebug_dump_stack()</code>打印的函数调用栈不会输出到<code>dmesg</code>中（因为函数调用栈内容太多，怕淹没其他打印信息），可以在 <code>/sys/kernel/debug/tracing/trace_pipe</code> 文件查看:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb30-1" title="1"><span class="fu">cat</span> /sys/kernel/debug/tracing/trace_pipe</a></code></pre></div>
<h1 id="kdump-crash"><span class="header-section-number">6</span> <code>kdump</code>和<code>crash</code></h1>
<h2 id="源码安装crash"><span class="header-section-number">6.1</span> 源码安装crash</h2>
<p>如果内核版本不是最新的（比如4.19或5.10等），那么发行版的包管理器安装的crash就可以用，但如果内核版本是最新的，可能就需要通过源码安装crash:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb31-1" title="1"><span class="fu">git</span> clone https://github.com/crash-utility/crash.git</a>
<a class="sourceLine" id="cb31-2" title="2"><span class="fu">sudo</span> apt-get install autoconf automake libtool texinfo -y</a>
<a class="sourceLine" id="cb31-3" title="3"><span class="fu">sudo</span> apt install libgmp-dev libmpfr-dev -y <span class="co"># 编译gdb需要</span></a>
<a class="sourceLine" id="cb31-4" title="4"><span class="bu">cd</span> crash</a>
<a class="sourceLine" id="cb31-5" title="5"><span class="fu">make</span> -j64 <span class="co"># 如果下载gdb很慢，可以先在其他地方先下载好（如 http://ftp.gnu.org/gnu/gdb/gdb-xx.xx.tar.gz），放到相应的位置</span></a>
<a class="sourceLine" id="cb31-6" title="6"><span class="co"># make target=ARM64 -j64 # 交叉编译能解析arm64 vmcore的crash</span></a></code></pre></div>
<h2 id="fedora环境"><span class="header-section-number">6.2</span> fedora环境</h2>
<p>以fedora40为例。</p>
<p>安装工具:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb32-1" title="1"><span class="fu">sudo</span> dnf install kexec-tools -y</a>
<a class="sourceLine" id="cb32-2" title="2"><span class="fu">sudo</span> dnf install crash -y</a></code></pre></div>
<p>修改<code>/etc/default/grub</code>文件，在<code>GRUB_CMDLINE_LINUX=</code>一行的最后添加以下内容:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb33-1" title="1"><span class="va">GRUB_CMDLINE_LINUX=</span><span class="st">&quot;... crashkernel=512M&quot;</span> <span class="co"># 根据内存大小来决定</span></a></code></pre></div>
<p>然后重新生成grub配置:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb34-1" title="1"><span class="fu">sudo</span> grub2-mkconfig -o /boot/grub2/grub.cfg</a>
<a class="sourceLine" id="cb34-2" title="2"><span class="fu">sudo</span> reboot <span class="co"># 重启才会生效</span></a></code></pre></div>
<p>开启kdump服务:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb35-1" title="1"><span class="fu">sudo</span> systemctl enable kdump.service <span class="co"># 设置成开机启动</span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="fu">sudo</span> systemctl start kdump.service <span class="co"># 启动</span></a>
<a class="sourceLine" id="cb35-3" title="3"><span class="fu">sudo</span> systemctl status kdump.service <span class="co"># 查看状态</span></a></code></pre></div>
<p>如果系统有问题发生崩溃，会在<code>/var/crash</code>目录下生成<code>vmcore</code>文件。</p>
<p>为了验证kdump功能是否可用，我们可以手动触发:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb36-1" title="1"><span class="fu">sudo</span> su root</a>
<a class="sourceLine" id="cb36-2" title="2"><span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/sysrq</a>
<a class="sourceLine" id="cb36-3" title="3"><span class="bu">echo</span> c <span class="op">&gt;</span> /proc/sysrq-trigger</a></code></pre></div>
<p>启动crash:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb37-1" title="1"><span class="ex">crash</span> /var/crash/<span class="va">${ip}</span>-<span class="va">${date-</span>time<span class="va">}</span>/vmcore /usr/lib/debug/lib/modules/<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span>/vmlinux</a></code></pre></div>
<h2 id="ubuntu环境"><span class="header-section-number">6.3</span> ubuntu环境</h2>
<p>以ubuntu24.04为例。</p>
<p>安装工具:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb38-1" title="1"><span class="fu">sudo</span> apt-get update -y</a>
<a class="sourceLine" id="cb38-2" title="2"><span class="fu">sudo</span> apt install linux-crashdump -y</a>
<a class="sourceLine" id="cb38-3" title="3"><span class="fu">sudo</span> apt install crash -y</a></code></pre></div>
<p>修改<code>/etc/default/grub</code>文件，在<code>GRUB_CMDLINE_LINUX=</code>一行的最后添加以下内容:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb39-1" title="1"><span class="va">GRUB_CMDLINE_LINUX=</span><span class="st">&quot;... crashkernel=512M&quot;</span> <span class="co"># 根据内存大小来决定</span></a></code></pre></div>
<p>然后重新生成grub配置:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb40-1" title="1"><span class="fu">sudo</span> grub-mkconfig -o /boot/grub/grub.cfg</a></code></pre></div>
<p>注意ubuntu server（如ubuntu22.04.4）的<code>/boot/grub/grub.cfg</code>中的<code>crashkernel</code>后的值是<code>512M-:192M</code>，要删掉后面的<code>-:192M</code>，否则无法生成<code>vmcore</code>。</p>
<p>再重启系统:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb41-1" title="1"><span class="fu">sudo</span> reboot <span class="co"># 重启才会生效</span></a></code></pre></div>
<p>开启kdump服务:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb42-1" title="1"><span class="fu">sudo</span> systemctl enable kdump-tools.service <span class="co"># 设置成开机启动</span></a>
<a class="sourceLine" id="cb42-2" title="2"><span class="fu">sudo</span> systemctl start kdump-tools.service <span class="co"># 启动</span></a>
<a class="sourceLine" id="cb42-3" title="3"><span class="fu">sudo</span> systemctl status kdump-tools.service <span class="co"># 查看状态</span></a></code></pre></div>
<p>如果系统有问题发生崩溃，会在<code>/var/crash</code>目录下生成<code>vmcore</code>文件。</p>
<p>为了验证kdump功能是否可用，我们可以手动触发:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb43-1" title="1"><span class="fu">sudo</span> su root</a>
<a class="sourceLine" id="cb43-2" title="2"><span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/sysrq</a>
<a class="sourceLine" id="cb43-3" title="3"><span class="bu">echo</span> c <span class="op">&gt;</span> /proc/sysrq-trigger</a></code></pre></div>
<p>启动crash:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb44-1" title="1"><span class="ex">crash</span> /var/crash/<span class="va">${date-</span>time<span class="va">}</span>/dump.<span class="va">${date-</span>time<span class="va">}</span> /usr/lib/debug/boot/vmlinux-<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span></a></code></pre></div>
<h2 id="qemu环境"><span class="header-section-number">6.4</span> qemu环境</h2>
<p>qemu启动的命令行最好指定<code>-append "nokaslr ..."</code>。</p>
<p>在qemu环境中运行，不需要安装<code>kdump</code>工具。有些发行版默认发生oops时不会panic，需要修改配置（注意这样修改重启后会还原）:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb45-1" title="1"><span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/panic_on_oops <span class="co"># 注意不能用 vim 编辑</span></a>
<a class="sourceLine" id="cb45-2" title="2"><span class="fu">cat</span> /proc/sys/kernel/panic_on_oops <span class="co"># 确认是否生效</span></a>
<a class="sourceLine" id="cb45-3" title="3"><span class="bu">echo</span> 3000 <span class="op">&gt;</span> /proc/sys/kernel/panic <span class="co"># panic之后多久重启</span></a></code></pre></div>
<p>按<code>ctrl + a c</code>打开QEMU控制台，使用以下命令导出vmcore:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb46-1" title="1"><span class="kw">(</span><span class="ex">qemu</span><span class="kw">)</span> <span class="ex">dump-guest-memory</span> /your_path/vmcore</a>
<a class="sourceLine" id="cb46-2" title="2"><span class="kw">(</span><span class="ex">qemu</span><span class="kw">)</span> <span class="ex">dump-guest-memory</span> -z /your_path/vmcore <span class="co"># 压缩</span></a></code></pre></div>
<p>除了panic时导出vmcore，还可以手动触发导出vmcore，这在一些场景下收集信息非常有用:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb47-1" title="1"><span class="co"># 这个命令启用了 Magic SysRq 键。Magic SysRq 键提供了一组能够直接与内核进行交互的调试和故障排除功能。</span></a>
<a class="sourceLine" id="cb47-2" title="2"><span class="co"># 当启用 Magic SysRq 后，您可以使用 Magic SysRq 键与其他键组合来触发特定的操作</span></a>
<a class="sourceLine" id="cb47-3" title="3"><span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/sysrq</a>
<a class="sourceLine" id="cb47-4" title="4"><span class="co"># 这个命令触发了 Magic SysRq 键中的 &quot;c&quot; 操作。在 Magic SysRq 中，&quot;c&quot; 表示让内核立即进行系统内核转储。</span></a>
<a class="sourceLine" id="cb47-5" title="5"><span class="co"># 这对于在系统发生严重故障时收集调试信息非常有用。</span></a>
<a class="sourceLine" id="cb47-6" title="6"><span class="bu">echo</span> c <span class="op">&gt;</span> /proc/sysrq-trigger <span class="co"># 相当于Alt + SysRq + c</span></a></code></pre></div>
<p>如果要让内核在hungtask或softlockup等情况触发panic，可以执行以下操作:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb48-1" title="1"><span class="ex">sysctl</span> -w kernel.softlockup_panic=1 <span class="co"># -w：表示“写”操作，用来修改内核参数</span></a>
<a class="sourceLine" id="cb48-2" title="2"><span class="ex">sysctl</span> -w kernel.hung_task_panic=0</a>
<a class="sourceLine" id="cb48-3" title="3"><span class="ex">sysctl</span> kernel.softlockup_panic <span class="co"># 查看</span></a>
<a class="sourceLine" id="cb48-4" title="4"><span class="co"># 或者用以下命令</span></a>
<a class="sourceLine" id="cb48-5" title="5"><span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/softlockup_panic <span class="co"># 和sysctl命令效果一样</span></a>
<a class="sourceLine" id="cb48-6" title="6"><span class="bu">echo</span> 0 <span class="op">&gt;</span> /proc/sys/kernel/hung_task_panic</a>
<a class="sourceLine" id="cb48-7" title="7"><span class="fu">cat</span> /proc/sys/kernel/softlockup_panic <span class="co"># 查看</span></a></code></pre></div>
<p>可以用以下命令在线导出vmcore（但不确定是否会有问题）:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb49-1" title="1"><span class="co"># -c： 启用压缩。它使用 zlib 或 lzo 等压缩算法来压缩转储文件中的数据，从而显著减小最终生成的 vmcore 文件的大小。</span></a>
<a class="sourceLine" id="cb49-2" title="2"><span class="co"># -d 31： 指定要过滤掉（不保存） 的内存页类型。这个数字是“dump level”，它是不同位掩码值的组合（通过按位或操作组合）。</span></a>
<a class="sourceLine" id="cb49-3" title="3"><span class="co">#     1： 过滤掉所有的零页（充满零的内存页）。</span></a>
<a class="sourceLine" id="cb49-4" title="4"><span class="co">#     2： 过滤掉所有的缓存页（Cache pages）。</span></a>
<a class="sourceLine" id="cb49-5" title="5"><span class="co">#     4： 过滤掉所有的用户进程数据页（User data pages）。</span></a>
<a class="sourceLine" id="cb49-6" title="6"><span class="co">#     8： 过滤掉所有的空闲页（Free pages）。</span></a>
<a class="sourceLine" id="cb49-7" title="7"><span class="co">#    16： 过滤掉大部分用于存储内核模块代码和调试信息的内存页（Huge pages, 具体看版本）。</span></a>
<a class="sourceLine" id="cb49-8" title="8"><span class="co">#    31 = 1 + 2 + 4 + 8 + 16。这意味着它会过滤掉上述所有类型的内存页，只保留最重要的内核数据结构。这是最激进的过滤级别，能生成最小的转储文件，通常足以进行崩溃原因分析（如查看崩溃时的进程列表、内核堆栈跟踪等）。</span></a>
<a class="sourceLine" id="cb49-9" title="9"><span class="ex">makedumpfile</span> -c -d 31 /proc/kcore vmcore</a></code></pre></div>
<p><code>x86_64</code>启动<code>crash</code>:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb50-1" title="1"><span class="ex">crash</span> vmlinux vmcore</a></code></pre></div>
<p><code>aarch64</code>启动<code>crash</code>要特殊处理:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb51-1" title="1"><span class="co"># 先启动gdb打印变量值</span></a>
<a class="sourceLine" id="cb51-2" title="2"><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">target</span> remote:5555</a>
<a class="sourceLine" id="cb51-3" title="3"><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">p</span> /x kimage_voffset <span class="co"># 在我的虚拟机中值为 0xffff80003fe00000</span></a>
<a class="sourceLine" id="cb51-4" title="4"><span class="ex">crash</span> vmlinux vmcore -m vabits_actual=48 -m kimage_voffset=0xffff80003fe00000</a></code></pre></div>
<p>加载ko模块:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb52-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> help mod <span class="co"># 帮助命令</span></a>
<a class="sourceLine" id="cb52-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> mod -s <span class="op">&lt;</span>module name<span class="op">&gt;</span> <span class="op">&lt;</span>ko path<span class="op">&gt;</span> <span class="co"># 加载</span></a>
<a class="sourceLine" id="cb52-3" title="3"><span class="ex">crash</span><span class="op">&gt;</span> mod -d <span class="op">&lt;</span>module name<span class="op">&gt;</span> <span class="co"># 删除</span></a></code></pre></div>
<h2 id="crash常用命令"><span class="header-section-number">6.5</span> <code>crash</code>常用命令</h2>
<p>启动<code>crash</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb53-1" title="1"><span class="ex">crash</span> vmlinux vmcore</a>
<a class="sourceLine" id="cb53-2" title="2"><span class="ex">crash</span> vmlinux <span class="co"># 在线调试，vmcore是/proc/kcore，注意这个文件无法复制</span></a></code></pre></div>
<p><code>help</code>命令:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb54-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> help <span class="co"># 查看支持的所有命令</span></a>
<a class="sourceLine" id="cb54-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> help bt <span class="co"># 查看具体命令（bt）的用法</span></a></code></pre></div>
<p><code>sys</code>命令查看系统信息:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb55-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> sys</a></code></pre></div>
<p><code>bt</code>命令:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb56-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> bt <span class="co"># 查看崩溃瞬间正在运行的进程的内核栈</span></a>
<a class="sourceLine" id="cb56-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> bt <span class="op">&lt;</span>pid<span class="op">&gt;</span> <span class="co"># 查看指定pid进程的栈</span></a>
<a class="sourceLine" id="cb56-3" title="3"><span class="co"># -F[F]: 类似于 -f，不同之处在于当适用时以符号方式显示堆栈数据；如果堆栈数据引用了 slab cache 对象，将在方括号内显示 slab cache 的名称；在 ia64 架构上，将以符号方式替代参数寄存器的内容。如果输入 -F 两次，并且堆栈数据引用了 slab cache 对象，将同时显示地址和 slab cache 的名称在方括号中。</span></a>
<a class="sourceLine" id="cb56-4" title="4"><span class="ex">crash</span><span class="op">&gt;</span> bt -F</a>
<a class="sourceLine" id="cb56-5" title="5"><span class="ex">crash</span><span class="op">&gt;</span> bt -FF</a>
<a class="sourceLine" id="cb56-6" title="6"><span class="co"># -f: 显示堆栈帧中包含的所有数据；此选项可用于确定传递给每个函数的参数；在 ia64 架构上，将显示参数寄存器的内容。</span></a>
<a class="sourceLine" id="cb56-7" title="7"><span class="ex">crash</span><span class="op">&gt;</span> bt -f</a>
<a class="sourceLine" id="cb56-8" title="8"><span class="co"># 其他选项:</span></a>
<a class="sourceLine" id="cb56-9" title="9"><span class="ex">-t</span>: 显示文本符号。</a>
<a class="sourceLine" id="cb56-10" title="10"><span class="ex">-l</span>: 显示文件名、行号。</a></code></pre></div>
<p><code>dis</code>命令:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb57-1" title="1"><span class="co"># -l: 显示源代码行号</span></a>
<a class="sourceLine" id="cb57-2" title="2"><span class="co"># -s: 显示源代码</span></a>
<a class="sourceLine" id="cb57-3" title="3"><span class="ex">crash</span><span class="op">&gt;</span> dis function_name <span class="co"># 输出函数的反汇编结果</span></a></code></pre></div>
<p><code>mod</code>命令:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb58-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> mod <span class="co"># 显示所有模块的信息</span></a>
<a class="sourceLine" id="cb58-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> mod -s <span class="op">&lt;</span>module name<span class="op">&gt;</span> <span class="op">&lt;</span>ko path<span class="op">&gt;</span> <span class="co"># 加载</span></a>
<a class="sourceLine" id="cb58-3" title="3"><span class="ex">crash</span><span class="op">&gt;</span> mod -d <span class="op">&lt;</span>module name<span class="op">&gt;</span> <span class="co"># 删除</span></a>
<a class="sourceLine" id="cb58-4" title="4"><span class="ex">crash</span><span class="op">&gt;</span> mod -S <span class="co"># 从某个特定目录加载所有模块，默认从/lib/modules/`uname -r` 目录</span></a></code></pre></div>
<p><code>sym</code>命令（解析符号信息）:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb59-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> sym -l <span class="co"># 相当于查看 System.map</span></a>
<a class="sourceLine" id="cb59-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> sym -m ubifs <span class="co"># 查看某个内核模块</span></a>
<a class="sourceLine" id="cb59-3" title="3"><span class="ex">crash</span><span class="op">&gt;</span> sym -q ext2 <span class="co"># 查看包含ext2字符串的符号信息</span></a></code></pre></div>
<p><code>rd</code>命令用于读取内存地址的值:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb60-1" title="1"><span class="co"># -p: 物理地址</span></a>
<a class="sourceLine" id="cb60-2" title="2"><span class="co"># -u: 用户空间虚拟地址</span></a>
<a class="sourceLine" id="cb60-3" title="3"><span class="co"># -d: 10进制</span></a>
<a class="sourceLine" id="cb60-4" title="4"><span class="co"># -s: 显示符号</span></a>
<a class="sourceLine" id="cb60-5" title="5"><span class="co"># -32: 32位宽</span></a>
<a class="sourceLine" id="cb60-6" title="6"><span class="co"># -64: 64位宽</span></a>
<a class="sourceLine" id="cb60-7" title="7"><span class="co"># -a: ascii码</span></a>
<a class="sourceLine" id="cb60-8" title="8"><span class="ex">crash</span><span class="op">&gt;</span> rd 0xffff888005462800 20 <span class="co"># 读20个值</span></a></code></pre></div>
<p><code>struct</code>命令:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb61-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> struct ext2_inode <span class="co"># 显示结构体定义</span></a>
<a class="sourceLine" id="cb61-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> struct ext2_inode -o <span class="co"># 偏移</span></a>
<a class="sourceLine" id="cb61-3" title="3"><span class="ex">crash</span><span class="op">&gt;</span> struct ext2_inode ffff88800dc59820 <span class="co"># 解析值</span></a>
<a class="sourceLine" id="cb61-4" title="4"><span class="ex">crash</span><span class="op">&gt;</span> struct ext2_inode.i_mtime ffff88800dc59820 <span class="co"># 某个成员的值</span></a></code></pre></div>
<p><code>p</code>命令:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb62-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> p jiffies</a>
<a class="sourceLine" id="cb62-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> p ext2_readdir <span class="co"># 输出函数符号地址</span></a>
<a class="sourceLine" id="cb62-3" title="3"><span class="ex">crash</span><span class="op">&gt;</span> p irq_stat <span class="co"># percpu变量，定义在 arch/x86/kernel/irq.c 中</span></a>
<a class="sourceLine" id="cb62-4" title="4"><span class="ex">crash</span><span class="op">&gt;</span> p irq_stat:0 <span class="co"># cpu 0</span></a></code></pre></div>
<p><code>irq</code>中断相关信息:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb63-1" title="1"><span class="co"># -a: 中断亲和性</span></a>
<a class="sourceLine" id="cb63-2" title="2"><span class="co"># -s: 系统中断信息</span></a>
<a class="sourceLine" id="cb63-3" title="3"><span class="ex">crash</span><span class="op">&gt;</span> irq <span class="co"># 所有中断</span></a>
<a class="sourceLine" id="cb63-4" title="4"><span class="ex">crash</span><span class="op">&gt;</span> irq 0 <span class="co"># 第0个中断</span></a>
<a class="sourceLine" id="cb63-5" title="5"><span class="ex">crash</span><span class="op">&gt;</span> irq -b <span class="co"># 下半部</span></a></code></pre></div>
<p><code>task</code>命令显示<code>struct task_struct</code>和<code>struct thread_info</code>的内容:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb64-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> task -x <span class="co"># 16进制</span></a></code></pre></div>
<p><code>vm</code>命令显示进程地址空间:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb65-1" title="1"><span class="co"># -p: 虚拟地址和物理地址</span></a>
<a class="sourceLine" id="cb65-2" title="2"><span class="co"># -m: mm_struct</span></a>
<a class="sourceLine" id="cb65-3" title="3"><span class="co"># -R: 搜索</span></a>
<a class="sourceLine" id="cb65-4" title="4"><span class="co"># -v: 所有 vm_area_struct</span></a>
<a class="sourceLine" id="cb65-5" title="5"><span class="co"># -f num: 显示num在vm_flags对应的位</span></a>
<a class="sourceLine" id="cb65-6" title="6"><span class="ex">crash</span><span class="op">&gt;</span> vm <span class="co"># 崩溃瞬间进程</span></a>
<a class="sourceLine" id="cb65-7" title="7"><span class="ex">crash</span><span class="op">&gt;</span> vm 575 <span class="co"># 指定pid</span></a></code></pre></div>
<p><code>kmem</code>显示内存信息:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb66-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> kmem -i <span class="co"># 系统内存使用情况</span></a>
<a class="sourceLine" id="cb66-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> kmem -s <span class="co"># slab使用情况</span></a>
<a class="sourceLine" id="cb66-3" title="3"><span class="ex">crash</span><span class="op">&gt;</span> kmem -v <span class="co"># vmalloc</span></a>
<a class="sourceLine" id="cb66-4" title="4"><span class="ex">crash</span><span class="op">&gt;</span> kmem -V <span class="co"># vm_stat</span></a>
<a class="sourceLine" id="cb66-5" title="5"><span class="ex">crash</span><span class="op">&gt;</span> kmem -z <span class="co"># zone</span></a>
<a class="sourceLine" id="cb66-6" title="6"><span class="ex">crash</span><span class="op">&gt;</span> kmem -p <span class="co"># page</span></a>
<a class="sourceLine" id="cb66-7" title="7"><span class="ex">crash</span><span class="op">&gt;</span> kmem -g <span class="co"># page flag</span></a></code></pre></div>
<p><code>list</code>命令:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb67-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> list super_blocks</a>
<a class="sourceLine" id="cb67-2" title="2"><span class="co"># -s: 链表成员</span></a>
<a class="sourceLine" id="cb67-3" title="3"><span class="co"># -h: 链表头地址，这里可以用 p super_blocks 获取</span></a>
<a class="sourceLine" id="cb67-4" title="4"><span class="ex">crash</span><span class="op">&gt;</span> list -s super_block.s_blocksize_bits,s_maxbytes -h 0xffff888005462800</a>
<a class="sourceLine" id="cb67-5" title="5"><span class="ex">crash</span><span class="op">&gt;</span> list -h 0xffff888005462800 <span class="kw">|</span> <span class="fu">wc</span> -l <span class="co"># 链表长度</span></a></code></pre></div>
<p><code>files</code>查看文件:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb68-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> files 1027 <span class="co"># pid为1027进程打开的文件</span></a>
<a class="sourceLine" id="cb68-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> foreach files -R mnt <span class="co"># 打开路径名中包含mnt的文件的所有进程</span></a></code></pre></div>
<h2 id="例子1"><span class="header-section-number">6.6</span> 例子1</h2>
<p>构造一个空指针访问的场景:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb69-1" title="1"><span class="fu">diff</span> --git a/fs/ext2/dir.c b/fs/ext2/dir.c</a>
<a class="sourceLine" id="cb69-2" title="2"><span class="ex">index</span> b335f17f682f..01893352b0bb 100644</a>
<a class="sourceLine" id="cb69-3" title="3"><span class="ex">---</span> a/fs/ext2/dir.c</a>
<a class="sourceLine" id="cb69-4" title="4"><span class="ex">+++</span> b/fs/ext2/dir.c</a>
<a class="sourceLine" id="cb69-5" title="5"><span class="ex">@@</span> -266,6 +266,9 @@ ext2_readdir(struct file *file, struct dir_context *ctx)</a>
<a class="sourceLine" id="cb69-6" title="6">        <span class="ex">bool</span> need_revalidate = !inode_eq_iversion(inode, file-<span class="op">&gt;</span>f_version);</a>
<a class="sourceLine" id="cb69-7" title="7">        <span class="ex">bool</span> has_filetype<span class="kw">;</span></a>
<a class="sourceLine" id="cb69-8" title="8"> </a>
<a class="sourceLine" id="cb69-9" title="9"><span class="ex">+</span>       file = NULL<span class="kw">;</span></a>
<a class="sourceLine" id="cb69-10" title="10"><span class="ex">+</span>       file-<span class="op">&gt;</span>f_pos = 2<span class="kw">;</span></a>
<a class="sourceLine" id="cb69-11" title="11"><span class="ex">+</span></a>
<a class="sourceLine" id="cb69-12" title="12">        <span class="kw">if</span> <span class="kw">(</span><span class="ex">pos</span> <span class="op">&gt;</span> inode-<span class="op">&gt;</span>i_size - EXT2_DIR_REC_LEN(1<span class="kw">)</span>)</a>
<a class="sourceLine" id="cb69-13" title="13">                <span class="bu">return</span> 0<span class="kw">;</span></a></code></pre></div>
<h3 id="查看崩溃在哪一行"><span class="header-section-number">6.6.1</span> 查看崩溃在哪一行</h3>
<p>可以使用内核仓库的脚本<code>scripts/faddr2line</code>:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb70-1" title="1"><span class="co"># 查看内核日志</span></a>
<a class="sourceLine" id="cb70-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> dmesg <span class="kw">|</span> <span class="fu">less</span></a>
<a class="sourceLine" id="cb70-3" title="3"><span class="ex">...</span></a>
<a class="sourceLine" id="cb70-4" title="4"><span class="ex">BUG</span>: kernel NULL pointer dereference, address: 0000000000000040</a>
<a class="sourceLine" id="cb70-5" title="5"><span class="ex">...</span></a>
<a class="sourceLine" id="cb70-6" title="6"><span class="ex">RIP</span>: 0010:ext2_readdir+0x7e/0x310</a>
<a class="sourceLine" id="cb70-7" title="7"><span class="ex">...</span></a>
<a class="sourceLine" id="cb70-8" title="8"> <span class="ex">iterate_dir+0xb6/0x1f0</span></a>
<a class="sourceLine" id="cb70-9" title="9"></a>
<a class="sourceLine" id="cb70-10" title="10"><span class="co"># 在内核仓库目录下执行的shell命令，在x86_64下也可以直接运行脚本解析aarch64的vmcore</span></a>
<a class="sourceLine" id="cb70-11" title="11"><span class="co"># 遇到过在有些环境上解析结果有问题，可能是某些软件版本的问题，可以尝试换个环境</span></a>
<a class="sourceLine" id="cb70-12" title="12"><span class="ex">./scripts/faddr2line</span> build/vmlinux ext2_readdir+0x7e/0x310 <span class="co"># 或者把vmlinux替换成ko文件</span></a>
<a class="sourceLine" id="cb70-13" title="13"><span class="ex">ext2_readdir</span> at fs/ext2/dir.c:270</a></code></pre></div>
<p>也可以在<code>crash</code>中反汇编查看:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb71-1" title="1"><span class="co"># 查看崩溃的栈</span></a>
<a class="sourceLine" id="cb71-2" title="2"><span class="ex">crash</span><span class="op">&gt;</span> bt</a>
<a class="sourceLine" id="cb71-3" title="3"><span class="ex">...</span></a>
<a class="sourceLine" id="cb71-4" title="4">    [<span class="ex">exception</span> RIP: ext2_readdir+126]</a>
<a class="sourceLine" id="cb71-5" title="5">    <span class="ex">RIP</span>: ffffffff81796a9e</a>
<a class="sourceLine" id="cb71-6" title="6"></a>
<a class="sourceLine" id="cb71-7" title="7"><span class="co"># 反汇编指定地址的代码，以查看其汇编指令, -l 选项用于在反汇编时显示源代码行号（如果可用）</span></a>
<a class="sourceLine" id="cb71-8" title="8"><span class="ex">crash</span><span class="op">&gt;</span> dis -l ffffffff81796a9e</a>
<a class="sourceLine" id="cb71-9" title="9"><span class="ex">/home/linux/code/linux/build/../fs/ext2</span>/dir.c: <span class="ex">270</span></a>
<a class="sourceLine" id="cb71-10" title="10"><span class="ex">0xffffffff81796a9e</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">126&gt;</span>:  movq   <span class="va">$0</span>x2,0x40</a>
<a class="sourceLine" id="cb71-11" title="11"></a>
<a class="sourceLine" id="cb71-12" title="12"><span class="co"># 查找指定地址的符号信息</span></a>
<a class="sourceLine" id="cb71-13" title="13"><span class="ex">crash</span><span class="op">&gt;</span> sym ffffffff81796a9e</a>
<a class="sourceLine" id="cb71-14" title="14"><span class="ex">ffffffff81796a9e</span> (t) <span class="ex">ext2_readdir+126</span> /home/linux/code/linux/build/../fs/ext2/dir.c: 270</a></code></pre></div>
<p><code>faddr2line</code>脚本和<code>crash</code>解析的结果都是崩溃在<code>fs/ext2/dir.c: 270</code>，也就是<code>file-&gt;f_pos = 2</code>。</p>
<h3 id="file-f_pos在结构体中的偏移量"><span class="header-section-number">6.6.2</span> <code>file-&gt;f_pos</code>在结构体中的偏移量</h3>
<div class="sourceCode" id="cb72"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb72-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> struct file -ox</a>
<a class="sourceLine" id="cb72-2" title="2"><span class="ex">struct</span> file {</a>
<a class="sourceLine" id="cb72-3" title="3">  <span class="ex">...</span></a>
<a class="sourceLine" id="cb72-4" title="4">  [<span class="ex">0x40</span>] loff_t f_pos<span class="kw">;</span></a>
<a class="sourceLine" id="cb72-5" title="5">  <span class="ex">...</span></a>
<a class="sourceLine" id="cb72-6" title="6">}</a>
<a class="sourceLine" id="cb72-7" title="7"><span class="ex">SIZE</span>: 0xe8</a></code></pre></div>
<p>可以看出<code>f_pos</code>的偏移量是<code>0x40</code>，这就是<code>dmesg</code>日志中<code>BUG: kernel NULL pointer dereference, address: 0000000000000040</code>的含义。</p>
<h3 id="分析slab-cache"><span class="header-section-number">6.6.3</span> 分析slab cache</h3>
<div class="sourceCode" id="cb73"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb73-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> bt -FF</a>
<a class="sourceLine" id="cb73-2" title="2"><span class="ex">...</span></a>
<a class="sourceLine" id="cb73-3" title="3"> <span class="co">#5 [ffffc900021cfd70] asm_exc_page_fault at ffffffff82a00bc2</span></a>
<a class="sourceLine" id="cb73-4" title="4">    [<span class="ex">exception</span> RIP: ext2_readdir+126]</a>
<a class="sourceLine" id="cb73-5" title="5">    <span class="ex">...</span></a>
<a class="sourceLine" id="cb73-6" title="6">    <span class="ex">ffffc900021cfd78</span>: [ffff888014451800:kmalloc-2k] [ffff88800eda3ce8:ext2_inode_cache] </a>
<a class="sourceLine" id="cb73-7" title="7">    <span class="ex">ffffc900021cfd88</span>: 0000000000000000 [ffff888006899200:filp]</a>
<a class="sourceLine" id="cb73-8" title="8"><span class="ex">...</span></a></code></pre></div>
<p>我们先看<code>[ffff88800eda3ce8:ext2_inode_cache]</code>，注意这个并不是<code>struct ext2_inode_info</code>的指针的地址，用以下命令:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb74-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> kmem ffff88800eda3ce8</a>
<a class="sourceLine" id="cb74-2" title="2"><span class="ex">CACHE</span>             OBJSIZE  ALLOCATED     TOTAL  SLABS  SSIZE  NAME</a>
<a class="sourceLine" id="cb74-3" title="3"><span class="ex">...</span></a>
<a class="sourceLine" id="cb74-4" title="4">  <span class="ex">FREE</span> / [ALLOCATED]</a>
<a class="sourceLine" id="cb74-5" title="5">  [<span class="ex">ffff88800eda3c30</span>]</a></code></pre></div>
<p><code>struct ext2_inode_info</code>的地址是<code>ffff88800eda3c30</code>，<code>[ALLOCATED]</code>代表已分配，那么<code>ffff88800eda3ce8:ext2_inode_cache</code>的地址是什么结构体的呢，我们查看<code>struct ext2_inode_info</code>结构体:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb75-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> struct ext2_inode_info ffff88800eda3c30 -ox</a>
<a class="sourceLine" id="cb75-2" title="2"><span class="ex">struct</span> ext2_inode_info {</a>
<a class="sourceLine" id="cb75-3" title="3">  <span class="ex">...</span></a>
<a class="sourceLine" id="cb75-4" title="4">  [<span class="ex">ffff88800eda3ce8</span>] struct inode vfs_inode<span class="kw">;</span></a>
<a class="sourceLine" id="cb75-5" title="5">  <span class="ex">...</span></a>
<a class="sourceLine" id="cb75-6" title="6">}</a>
<a class="sourceLine" id="cb75-7" title="7"><span class="ex">SIZE</span>: 0x350</a></code></pre></div>
<p>所以<code>ffff88800eda3ce8</code>是<code>struct inode</code>的指针地址。</p>
<p>再看<code>[ffff888006899200:filp]</code>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb76-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> kmem ffff888006899200</a>
<a class="sourceLine" id="cb76-2" title="2"><span class="ex">...</span></a>
<a class="sourceLine" id="cb76-3" title="3">  <span class="ex">FREE</span> / [ALLOCATED]</a>
<a class="sourceLine" id="cb76-4" title="4">  [<span class="ex">ffff888006899200</span>]</a></code></pre></div>
<p>刚好是<code>struct file</code>指针的地址。</p>
<h3 id="分析汇编"><span class="header-section-number">6.6.4</span> 分析汇编</h3>
<p>查看栈中寄存器的信息:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb77-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> bt</a>
<a class="sourceLine" id="cb77-2" title="2"><span class="ex">...</span></a>
<a class="sourceLine" id="cb77-3" title="3">    [<span class="ex">exception</span> RIP: ext2_readdir+126]</a>
<a class="sourceLine" id="cb77-4" title="4">    <span class="ex">RIP</span>: ffffffff81796a9e  RSP: ffffc900021cfe20  RFLAGS: 00010297</a>
<a class="sourceLine" id="cb77-5" title="5">    <span class="ex">RAX</span>: 0000000000000000  RBX: 0000000000000000  RCX: 00000000fffff000</a>
<a class="sourceLine" id="cb77-6" title="6">    <span class="ex">RDX</span>: 0000000000000001  RSI: ffff888008be8000  RDI: 0000000000001000</a>
<a class="sourceLine" id="cb77-7" title="7">    <span class="ex">RBP</span>: ffffc900021cfec0   R8: 0000000000000000   R9: 0000000000000000</a>
<a class="sourceLine" id="cb77-8" title="8">    <span class="ex">R10</span>: 0000000000000000  R11: 0000000000000000  R12: ffff888006899200</a>
<a class="sourceLine" id="cb77-9" title="9">    <span class="ex">R13</span>: 0000000000000000  R14: ffff88800eda3ce8  R15: ffff888014451800</a>
<a class="sourceLine" id="cb77-10" title="10">    <span class="ex">ORIG_RAX</span>: ffffffffffffffff  CS: 0010  SS: 0018</a></code></pre></div>
<p>再反汇编<code>ext2_readdir()</code>函数，只看<code>ext2_readdir+126</code>之前的:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb78-1" title="1"><span class="ex">crash</span><span class="op">&gt;</span> dis -l ext2_readdir</a>
<a class="sourceLine" id="cb78-2" title="2"><span class="ex">0xffffffff81796a20</span> <span class="op">&lt;</span>ext2_readdir<span class="op">&gt;</span>:      nopl   0x0(%rax,%rax,1) [<span class="ex">FTRACE</span> NOP]</a>
<a class="sourceLine" id="cb78-3" title="3"><span class="ex">0xffffffff81796a25</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">5&gt;</span>:    push   %r15</a>
<a class="sourceLine" id="cb78-4" title="4"><span class="ex">0xffffffff81796a27</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">7&gt;</span>:    push   %r14</a>
<a class="sourceLine" id="cb78-5" title="5"><span class="ex">0xffffffff81796a29</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">9&gt;</span>:    push   %r13</a>
<a class="sourceLine" id="cb78-6" title="6"><span class="ex">0xffffffff81796a2b</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">11&gt;</span>:   push   %r12</a>
<a class="sourceLine" id="cb78-7" title="7"><span class="ex">0xffffffff81796a2d</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">13&gt;</span>:   push   %rbp</a>
<a class="sourceLine" id="cb78-8" title="8"><span class="ex">0xffffffff81796a2e</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">14&gt;</span>:   push   %rbx</a>
<a class="sourceLine" id="cb78-9" title="9"><span class="ex">0xffffffff81796a2f</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">15&gt;</span>:   sub    <span class="va">$0</span>x28,%rsp</a>
<a class="sourceLine" id="cb78-10" title="10"><span class="ex">0xffffffff81796a33</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">19&gt;</span>:   mov    %rdi,%r12</a>
<a class="sourceLine" id="cb78-11" title="11"><span class="ex">0xffffffff81796a36</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">22&gt;</span>:   mov    %rsi,%rbp</a>
<a class="sourceLine" id="cb78-12" title="12"><span class="ex">0xffffffff81796a39</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">25&gt;</span>:   call   0xffffffff813318e0 <span class="op">&lt;</span>__sanitizer_cov_trace_pc<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb78-13" title="13"><span class="ex">0xffffffff81796a3e</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">30&gt;</span>:   mov    0x8(%rbp),<span class="ex">%rax</span></a>
<a class="sourceLine" id="cb78-14" title="14"><span class="ex">0xffffffff81796a42</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">34&gt;</span>:   mov    0xa8(%r12),<span class="ex">%r14</span></a>
<a class="sourceLine" id="cb78-15" title="15"><span class="ex">0xffffffff81796a4a</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">42&gt;</span>:   mov    0x28(%r14),<span class="ex">%r15</span></a>
<a class="sourceLine" id="cb78-16" title="16"><span class="ex">0xffffffff81796a4e</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">46&gt;</span>:   mov    %r15,0x10(%rsp)</a>
<a class="sourceLine" id="cb78-17" title="17"><span class="ex">0xffffffff81796a53</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">51&gt;</span>:   mov    %eax,%ebx</a>
<a class="sourceLine" id="cb78-18" title="18"><span class="ex">0xffffffff81796a55</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">53&gt;</span>:   and    <span class="va">$0</span>xfff,%ebx</a>
<a class="sourceLine" id="cb78-19" title="19"><span class="ex">0xffffffff81796a5b</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">59&gt;</span>:   mov    %rax,%r13</a>
<a class="sourceLine" id="cb78-20" title="20"><span class="ex">0xffffffff81796a5e</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">62&gt;</span>:   sar    <span class="va">$0</span>xc,%r13</a>
<a class="sourceLine" id="cb78-21" title="21"><span class="ex">0xffffffff81796a62</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">66&gt;</span>:   mov    0x50(%r14),<span class="ex">%rdi</span></a>
<a class="sourceLine" id="cb78-22" title="22"><span class="ex">0xffffffff81796a66</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">70&gt;</span>:   lea    0xfff(%rdi),<span class="ex">%rdx</span></a>
<a class="sourceLine" id="cb78-23" title="23"><span class="ex">0xffffffff81796a6d</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">77&gt;</span>:   shr    <span class="va">$0</span>xc,%rdx</a>
<a class="sourceLine" id="cb78-24" title="24"><span class="ex">0xffffffff81796a71</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">81&gt;</span>:   mov    %rdx,0x8(%rsp)</a>
<a class="sourceLine" id="cb78-25" title="25"><span class="ex">0xffffffff81796a76</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">86&gt;</span>:   mov    0x18(%r15),<span class="ex">%rdi</span></a>
<a class="sourceLine" id="cb78-26" title="26"><span class="ex">0xffffffff81796a7a</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">90&gt;</span>:   mov    %rdi,(%rsp)</a>
<a class="sourceLine" id="cb78-27" title="27"><span class="ex">0xffffffff81796a7e</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">94&gt;</span>:   mov    (%rsp),<span class="ex">%ecx</span></a>
<a class="sourceLine" id="cb78-28" title="28"><span class="ex">0xffffffff81796a81</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">97&gt;</span>:   neg    %ecx</a>
<a class="sourceLine" id="cb78-29" title="29"><span class="ex">0xffffffff81796a83</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">99&gt;</span>:   mov    %ecx,0x1c(%rsp)</a>
<a class="sourceLine" id="cb78-30" title="30"><span class="ex">0xffffffff81796a87</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">103&gt;</span>:  mov    0x148(%r14),<span class="ex">%rdx</span></a>
<a class="sourceLine" id="cb78-31" title="31"><span class="ex">0xffffffff81796a8e</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">110&gt;</span>:  shr    %rdx</a>
<a class="sourceLine" id="cb78-32" title="32"><span class="ex">0xffffffff81796a91</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">113&gt;</span>:  cmp    %rdx,0xb8(%r12)</a>
<a class="sourceLine" id="cb78-33" title="33"><span class="ex">0xffffffff81796a99</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">121&gt;</span>:  setne  0x18(%rsp)</a>
<a class="sourceLine" id="cb78-34" title="34"><span class="ex">0xffffffff81796a9e</span> <span class="op">&lt;</span>ext2_readdir+<span class="op">126&gt;</span>:  movq   <span class="va">$0</span>x2,0x40</a></code></pre></div>
<p><code>x86_64</code>下整数参数使用的寄存器依次为: <code>RDI，RSI，RDX，RCX，R8，R9</code>，要注意的是栈中的寄存器值可能已经经过运算，所以这些寄存器不能直接对应函数参数，要分析汇编。</p>
<p>先看第一个参数，本来是寄存器<code>rdi</code>，但和<code>rdi</code>的值被<code>mov    0x18(%r15),%rdi</code>改变了，所以这个寄存器的值已经不是函数刚传入时的参数，那要怎么找到第一个参数的值呢？我们看到<code>mov    %rdi,%r12</code>把值赋给了<code>r12</code>寄存器，而之后<code>r12</code>寄存器的值没有被覆盖，所以<code>r12</code>就是第一个参数的值，就是<code>R12: ffff888006899200</code>，和前面我们在栈中找到的slab cache <code>[ffff888006899200:filp]</code>的值一样。</p>
<p>与第二个入参相关的寄存器是<code>rsi</code>，只有<code>mov    %rsi,%rbp</code>一条汇编指令，意思是将源寄存器 <code>%rsi</code> 的内容移动到目标寄存器 <code>%rbp</code>，所以<code>rsi</code>的值没有被改变，就是第二个参数的值。</p>
<h1 id="systemtap"><span class="header-section-number">7</span> <code>systemtap</code></h1>
<p>参考:</p>
<ul>
<li><a href="https://chenxiaosong.com/src/translation/systemtap/systemtap-readme.html">systemtap README翻译</a></li>
<li><a href="https://sourceware.org/systemtap/">Systemtap tutorial</a></li>
<li><a href="https://sourceware.org/git/?p=systemtap.git;a=tree">systemtap源码</a></li>
<li><a href="https://sourceware.org/git/?p=systemtap.git;a=tree;f=testsuite/systemtap.examples;h=816fa8005086a2fcec91a82883aec4956a1ae96c;hb=HEAD">源码中的例子</a></li>
</ul>
<p>测试发现，ubuntu2404暂时无法运行<code>systemtap</code>脚本，ubuntu2204无法探测<code>return</code>。可以尝试在<code>fedora40</code>中测试。</p>
<h2 id="fedora40测试环境"><span class="header-section-number">7.1</span> fedora40测试环境</h2>
<p>基于<code>kprobe</code>，典型的应用是列出前几个调用次数最多的系统调用。</p>
<p>安装:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb79-1" title="1"><span class="fu">sudo</span> apt install systemtap -y</a>
<a class="sourceLine" id="cb79-2" title="2"><span class="fu">sudo</span> dnf install systemtap -y</a></code></pre></div>
<p>写一个最简单的<code>hello-world.stp</code>文件，进行测试:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb80-1" title="1"><span class="ex">probe</span> begin</a>
<a class="sourceLine" id="cb80-2" title="2"><span class="kw">{</span></a>
<a class="sourceLine" id="cb80-3" title="3">  <span class="ex">print</span> (<span class="st">&quot;hello world\n&quot;</span>)</a>
<a class="sourceLine" id="cb80-4" title="4">  <span class="fu">exit ()</span></a>
<a class="sourceLine" id="cb80-5" title="5"><span class="kw">}</span></a></code></pre></div>
<p>fedora要安装<code>kernel-debuginfo</code>和<code>kernel-devel</code>（对应内核版本）。ubuntu要安装<code>kernel-debuginfo</code>软件包。</p>
<p>运行:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb81-1" title="1"><span class="ex">stap</span> hello-world.stp</a>
<a class="sourceLine" id="cb81-2" title="2"><span class="ex">hello</span> world</a>
<a class="sourceLine" id="cb81-3" title="3"></a>
<a class="sourceLine" id="cb81-4" title="4"><span class="co"># 或者编译成ko再运行</span></a>
<a class="sourceLine" id="cb81-5" title="5"><span class="ex">stap</span> -m helloword hello-word.stp</a>
<a class="sourceLine" id="cb81-6" title="6"><span class="ex">staprun</span> helloword.ko</a></code></pre></div>
<h2 id="源码安装"><span class="header-section-number">7.2</span> 源码安装</h2>
<p>在<code>qemu</code>中用<code>systemtap</code>调试最新内核，需要在虚拟机中用源码安装<code>systemtap</code>。</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb82-1" title="1"><span class="ex">dnf</span> install g++ -y</a>
<a class="sourceLine" id="cb82-2" title="2"></a>
<a class="sourceLine" id="cb82-3" title="3"><span class="fu">git</span> clone https://sourceware.org/git/systemtap.git</a>
<a class="sourceLine" id="cb82-4" title="4"><span class="bu">cd</span> systemtap</a>
<a class="sourceLine" id="cb82-5" title="5"><span class="fu">mkdir</span> build</a>
<a class="sourceLine" id="cb82-6" title="6"><span class="bu">cd</span> build</a>
<a class="sourceLine" id="cb82-7" title="7"><span class="ex">../configure</span> --prefix=/your/path</a>
<a class="sourceLine" id="cb82-8" title="8"><span class="fu">make</span> all <span class="co"># 内存小时不能加 -j`nproc`，否则会oom</span></a>
<a class="sourceLine" id="cb82-9" title="9"><span class="fu">make</span> install</a></code></pre></div>
<h2 id="跟踪函数"><span class="header-section-number">7.3</span> 跟踪函数</h2>
<p>查看可以被跟踪的函数:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb83-1" title="1"><span class="ex">stap</span> -l <span class="st">&#39;kernel.function(&quot;sched*&quot;)&#39;</span> <span class="co"># 编译到vmlinux中的函数</span></a>
<a class="sourceLine" id="cb83-2" title="2"><span class="ex">stap</span> -l <span class="st">&#39;module(&quot;xfs&quot;).function(&quot;xfs*&quot;)&#39;</span> <span class="co"># xfs模块的函数</span></a></code></pre></div>
<p><code>test.stp</code>文件:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb84-1" title="1"><span class="co"># 如果xfs编译到vmlinux中，&#39;module(&quot;xfs&quot;)&#39;要换成&#39;kernel&#39;</span></a>
<a class="sourceLine" id="cb84-2" title="2"><span class="ex">probe</span> module(<span class="st">&quot;xfs&quot;</span>)<span class="ex">.function</span>(<span class="st">&quot;xfs_file_read_iter&quot;</span>)<span class="ex">.call</span> {</a>
<a class="sourceLine" id="cb84-3" title="3">    <span class="bu">printf</span>(<span class="st">&quot;Function %s called\n&quot;</span>, probefunc())</a>
<a class="sourceLine" id="cb84-4" title="4">}</a>
<a class="sourceLine" id="cb84-5" title="5"></a>
<a class="sourceLine" id="cb84-6" title="6"><span class="ex">probe</span> module(<span class="st">&quot;xfs&quot;</span>)<span class="ex">.function</span>(<span class="st">&quot;xfs_file_read_iter&quot;</span>)<span class="ex">.return</span> {</a>
<a class="sourceLine" id="cb84-7" title="7">    <span class="bu">printf</span>(<span class="st">&quot;Function %s returned %d\n&quot;</span>, probefunc(), <span class="va">$return</span>)</a>
<a class="sourceLine" id="cb84-8" title="8">}</a></code></pre></div>
<p>测试命令:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb85-1" title="1"><span class="ex">fallocate</span> -l 300M image</a>
<a class="sourceLine" id="cb85-2" title="2"><span class="ex">mkfs.xfs</span> -f image</a>
<a class="sourceLine" id="cb85-3" title="3"><span class="fu">mount</span> image /mnt</a>
<a class="sourceLine" id="cb85-4" title="4"><span class="bu">echo</span> 1234567 <span class="op">&gt;</span> /mnt/file</a>
<a class="sourceLine" id="cb85-5" title="5"><span class="fu">cat</span> /mnt/file</a></code></pre></div>
<h1 id="bpftrace"><span class="header-section-number">8</span> bpftrace</h1>
<p>请查看<a href="https://chenxiaosong.com/course/kernel/bpf.html">《BPF》</a>。</p>
</body>
</html>
