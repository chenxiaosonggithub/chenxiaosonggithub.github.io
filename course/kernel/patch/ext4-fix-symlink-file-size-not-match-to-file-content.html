<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>a2b0b205d125 ext4: fix symlink file size not match to file content</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://chenxiaosong.com/stylesheet.css" />
</head>
<body>
<header id="title-block-header">
<!-- sign begin -->
<ul>
<li>作者: 陈孝松</li>
<li><a href="https://chenxiaosong.com/">中文主页: chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/en">英文主页: chenxiaosong.com/en</a></li>
<li><a href="https://chenxiaosong.com/video.html">哔哩哔哩教学视频: 陈孝松</a></li>
<li><a href="https://chenxiaosong.com/course.html">课程: chenxiaosong.com/course</a></li>
<li><a href="https://chenxiaosong.com/blog.html">博客: chenxiaosong.com/blog</a></li>
<li><a href="https://chenxiaosong.com/contribution.html">贡献: chenxiaosong.com/contribution</a></li>
<li>邮箱: <a href="mailto:chenxiaosong@chenxiaosong.com" class="email">chenxiaosong@chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/q.html">QQ交流群: 544216206, 点击查看群介绍</a></li>
</ul>
<!-- sign end -->
<h1 class="title">a2b0b205d125 ext4: fix symlink file size not match to file content</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#问题描述"><span class="toc-section-number">1</span> 问题描述</a></li>
<li><a href="#内核构造补丁"><span class="toc-section-number">2</span> 内核构造补丁</a></li>
<li><a href="#修复补丁合入之前的现象"><span class="toc-section-number">3</span> 修复补丁合入之前的现象</a></li>
<li><a href="#修复补丁合入之后的现象"><span class="toc-section-number">4</span> 修复补丁合入之后的现象</a></li>
<li><a href="#代码流程"><span class="toc-section-number">5</span> 代码流程</a></li>
</ul>
</nav>
<p><a href="https://chenxiaosong.com/course/kernel/kernel.html">点击跳转到内核课程所有目录</a>。</p>
<p><a href="https://chenxiaosong.com/course/kernel/video.html">点击这里查看配套的教学视频</a>。</p>
<h1 id="问题描述"><span class="header-section-number">1</span> 问题描述</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1">[<span class="ex">home</span>]# fsck.ext4  -fn  ram0yb</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ex">e2fsck</span> 1.45.6 (20-Mar-2020)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ex">Pass</span> 1: Checking inodes, blocks, and sizes</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ex">Pass</span> 2: Checking directory structure</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="ex">Symlink</span> /p3/d14/d1a/l3d (inode <span class="co">#3494) is invalid.</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="ex">Clear?</span> no</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="ex">Entry</span> <span class="st">&#39;l3d&#39;</span> in /p3/d14/d1a (3383) <span class="ex">has</span> an incorrect filetype (was 7, should be 0)<span class="ex">.</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="ex">Fix?</span> no</a></code></pre></div>
<h1 id="内核构造补丁"><span class="header-section-number">2</span> 内核构造补丁</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb2-1" title="1">From edd845db91cb201343ce26bf4827a08dec213dac Mon Sep <span class="dv">17</span> <span class="bn">00</span>:<span class="bn">00</span>:<span class="bn">00</span> <span class="dv">2001</span></a>
<a class="sourceLine" id="cb2-2" title="2">From: ChenXiaoSong &lt;chenxiaosongemail@foxmail.com&gt;</a>
<a class="sourceLine" id="cb2-3" title="3">Date: Sun, <span class="dv">1</span> May <span class="dv">2022</span> <span class="dv">18</span>:<span class="dv">54</span>:<span class="dv">12</span> +<span class="er">0800</span></a>
<a class="sourceLine" id="cb2-4" title="4">Subject: [PATCH] reproduce symlink file size <span class="cf">do</span> not match to file content</a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6">Signed-off-by: ChenXiaoSong &lt;chenxiaosongemail@foxmail.com&gt;</a>
<a class="sourceLine" id="cb2-7" title="7">---</a>
<a class="sourceLine" id="cb2-8" title="8"> block/blk-core.c       | <span class="dv">34</span> +++++++++++++++++++++++++++++-----</a>
<a class="sourceLine" id="cb2-9" title="9"> fs/ext4/ext4.h         |  <span class="dv">1</span> +</a>
<a class="sourceLine" id="cb2-10" title="10"> fs/ext4/inode.c        |  <span class="dv">8</span> +++++++-</a>
<a class="sourceLine" id="cb2-11" title="11"> fs/ext4/page-io.c      | <span class="dv">18</span> +++++++++++++++---</a>
<a class="sourceLine" id="cb2-12" title="12"> include/linux/bio.h    |  <span class="dv">1</span> +</a>
<a class="sourceLine" id="cb2-13" title="13"> include/linux/blkdev.h |  <span class="dv">1</span> +</a>
<a class="sourceLine" id="cb2-14" title="14"> <span class="dv">6</span> files changed, <span class="dv">54</span> insertions(+), <span class="dv">9</span> deletions(-)</a>
<a class="sourceLine" id="cb2-15" title="15"></a>
<a class="sourceLine" id="cb2-16" title="16">diff --git a/block/blk-core.c b/block/blk-core.c</a>
<a class="sourceLine" id="cb2-17" title="17">index <span class="dv">937</span><span class="er">bb6b86331</span>.<span class="fl">.40979511</span><span class="er">c0cf</span> <span class="dv">100644</span></a>
<a class="sourceLine" id="cb2-18" title="18">--- a/block/blk-core.c</a>
<a class="sourceLine" id="cb2-19" title="19">+++ b/block/blk-core.c</a>
<a class="sourceLine" id="cb2-20" title="20">@@ -<span class="dv">771</span>,<span class="dv">7</span> +<span class="dv">771</span>,<span class="dv">7</span> @@ <span class="dt">void</span> submit_bio_noacct_nocheck(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-21" title="21">  * systems and other upper level users of the block layer should use</a>
<a class="sourceLine" id="cb2-22" title="22">  * submit_bio() instead.</a>
<a class="sourceLine" id="cb2-23" title="23">  */</a>
<a class="sourceLine" id="cb2-24" title="24">-<span class="dt">void</span> submit_bio_noacct(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-25" title="25">+<span class="dt">void</span> origin_submit_bio_noacct(<span class="kw">struct</span> bio *bio, <span class="dt">char</span> fault)</a>
<a class="sourceLine" id="cb2-26" title="26"> {</a>
<a class="sourceLine" id="cb2-27" title="27">    <span class="kw">struct</span> block_device *bdev = bio-&gt;bi_bdev;</a>
<a class="sourceLine" id="cb2-28" title="28">    <span class="kw">struct</span> request_queue *q = bdev_get_queue(bdev);</a>
<a class="sourceLine" id="cb2-29" title="29">@@ -<span class="dv">791</span>,<span class="dv">8</span> +<span class="dv">791</span>,<span class="dv">10</span> @@ <span class="dt">void</span> submit_bio_noacct(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-30" title="30">    <span class="cf">if</span> ((bio-&gt;bi_opf &amp; REQ_NOWAIT) &amp;&amp; !blk_queue_nowait(q))</a>
<a class="sourceLine" id="cb2-31" title="31">        <span class="cf">goto</span> not_supported;</a>
<a class="sourceLine" id="cb2-32" title="32"> </a>
<a class="sourceLine" id="cb2-33" title="33">-   <span class="cf">if</span> (should_fail_bio(bio))</a>
<a class="sourceLine" id="cb2-34" title="34">+   <span class="cf">if</span> (should_fail_bio(bio) || fault) {</a>
<a class="sourceLine" id="cb2-35" title="35">+       printk(<span class="st">&quot;%s:%d,inject fault,fault:%d</span><span class="sc">\n</span><span class="st">&quot;</span>, __func__, __LINE__, fault);</a>
<a class="sourceLine" id="cb2-36" title="36">        <span class="cf">goto</span> end_io;</a>
<a class="sourceLine" id="cb2-37" title="37">+   }</a>
<a class="sourceLine" id="cb2-38" title="38">    <span class="cf">if</span> (unlikely(bio_check_ro(bio)))</a>
<a class="sourceLine" id="cb2-39" title="39">        <span class="cf">goto</span> end_io;</a>
<a class="sourceLine" id="cb2-40" title="40">    <span class="cf">if</span> (!bio_flagged(bio, BIO_REMAPPED)) {</a>
<a class="sourceLine" id="cb2-41" title="41">@@ -<span class="dv">873</span>,<span class="dv">8</span> +<span class="dv">875</span>,<span class="dv">19</span> @@ <span class="dt">void</span> submit_bio_noacct(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-42" title="42">    bio-&gt;bi_status = status;</a>
<a class="sourceLine" id="cb2-43" title="43">    bio_endio(bio);</a>
<a class="sourceLine" id="cb2-44" title="44"> }</a>
<a class="sourceLine" id="cb2-45" title="45">+</a>
<a class="sourceLine" id="cb2-46" title="46">+<span class="dt">void</span> submit_bio_noacct(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-47" title="47">+{</a>
<a class="sourceLine" id="cb2-48" title="48">+   origin_submit_bio_noacct(bio, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb2-49" title="49">+}</a>
<a class="sourceLine" id="cb2-50" title="50"> EXPORT_SYMBOL(submit_bio_noacct);</a>
<a class="sourceLine" id="cb2-51" title="51"> </a>
<a class="sourceLine" id="cb2-52" title="52">+<span class="dt">void</span> submit_bio_noacct2(<span class="kw">struct</span> bio *bio, <span class="dt">char</span> fault)</a>
<a class="sourceLine" id="cb2-53" title="53">+{</a>
<a class="sourceLine" id="cb2-54" title="54">+   origin_submit_bio_noacct(bio, fault);</a>
<a class="sourceLine" id="cb2-55" title="55">+}</a>
<a class="sourceLine" id="cb2-56" title="56">+EXPORT_SYMBOL(submit_bio_noacct2);</a>
<a class="sourceLine" id="cb2-57" title="57">+</a>
<a class="sourceLine" id="cb2-58" title="58"> <span class="co">/**</span></a>
<a class="sourceLine" id="cb2-59" title="59"><span class="co">  * submit_bio - submit a bio to the block device layer for I/O</span></a>
<a class="sourceLine" id="cb2-60" title="60"><span class="co">  * </span><span class="an">@bio:</span><span class="co"> The &amp;struct bio which describes the I/O</span></a>
<a class="sourceLine" id="cb2-61" title="61"><span class="an">@@</span><span class="co"> -888,7 +901,7 </span><span class="an">@@</span><span class="co"> EXPORT_SYMBOL(submit_bio_noacct);</span></a>
<a class="sourceLine" id="cb2-62" title="62"><span class="co">  * in </span><span class="an">@bio.</span><span class="co">  The bio must NOT be touched by thecaller until -&gt;bi_end_io() has</span></a>
<a class="sourceLine" id="cb2-63" title="63"><span class="co">  * been called.</span></a>
<a class="sourceLine" id="cb2-64" title="64"><span class="co">  */</span></a>
<a class="sourceLine" id="cb2-65" title="65">-<span class="dt">void</span> submit_bio(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-66" title="66">+<span class="dt">void</span> origin_submit_bio(<span class="kw">struct</span> bio *bio, <span class="dt">char</span> fault)</a>
<a class="sourceLine" id="cb2-67" title="67"> {</a>
<a class="sourceLine" id="cb2-68" title="68">    <span class="cf">if</span> (blkcg_punt_bio_submit(bio))</a>
<a class="sourceLine" id="cb2-69" title="69">        <span class="cf">return</span>;</a>
<a class="sourceLine" id="cb2-70" title="70">@@ -<span class="dv">919</span>,<span class="dv">15</span> +<span class="dv">932</span>,<span class="dv">26</span> @@ <span class="dt">void</span> submit_bio(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-71" title="71">        <span class="dt">unsigned</span> <span class="dt">long</span> pflags;</a>
<a class="sourceLine" id="cb2-72" title="72"> </a>
<a class="sourceLine" id="cb2-73" title="73">        psi_memstall_enter(&amp;pflags);</a>
<a class="sourceLine" id="cb2-74" title="74">-       submit_bio_noacct(bio);</a>
<a class="sourceLine" id="cb2-75" title="75">+       submit_bio_noacct2(bio, fault);</a>
<a class="sourceLine" id="cb2-76" title="76">        psi_memstall_leave(&amp;pflags);</a>
<a class="sourceLine" id="cb2-77" title="77">        <span class="cf">return</span>;</a>
<a class="sourceLine" id="cb2-78" title="78">    }</a>
<a class="sourceLine" id="cb2-79" title="79"> </a>
<a class="sourceLine" id="cb2-80" title="80">-   submit_bio_noacct(bio);</a>
<a class="sourceLine" id="cb2-81" title="81">+   submit_bio_noacct2(bio, fault);</a>
<a class="sourceLine" id="cb2-82" title="82">+}</a>
<a class="sourceLine" id="cb2-83" title="83">+</a>
<a class="sourceLine" id="cb2-84" title="84">+<span class="dt">void</span> submit_bio(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-85" title="85">+{</a>
<a class="sourceLine" id="cb2-86" title="86">+   origin_submit_bio(bio, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb2-87" title="87"> }</a>
<a class="sourceLine" id="cb2-88" title="88"> EXPORT_SYMBOL(submit_bio);</a>
<a class="sourceLine" id="cb2-89" title="89"> </a>
<a class="sourceLine" id="cb2-90" title="90">+<span class="dt">void</span> submit_bio2(<span class="kw">struct</span> bio *bio, <span class="dt">char</span> fault)</a>
<a class="sourceLine" id="cb2-91" title="91">+{</a>
<a class="sourceLine" id="cb2-92" title="92">+   origin_submit_bio(bio, fault);</a>
<a class="sourceLine" id="cb2-93" title="93">+}</a>
<a class="sourceLine" id="cb2-94" title="94">+EXPORT_SYMBOL(submit_bio2);</a>
<a class="sourceLine" id="cb2-95" title="95">+</a>
<a class="sourceLine" id="cb2-96" title="96"> <span class="co">/**</span></a>
<a class="sourceLine" id="cb2-97" title="97"><span class="co">  * bio_poll - poll for BIO completions</span></a>
<a class="sourceLine" id="cb2-98" title="98"><span class="co">  * </span><span class="an">@bio:</span><span class="co"> bio to poll for</span></a>
<a class="sourceLine" id="cb2-99" title="99"><span class="co">diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.h</span></a>
<a class="sourceLine" id="cb2-100" title="100"><span class="co">index 3f87cca49f0c..375bf9eefab8 100644</span></a>
<a class="sourceLine" id="cb2-101" title="101"><span class="co">--- a/fs/ext4/ext4.h</span></a>
<a class="sourceLine" id="cb2-102" title="102"><span class="co">+++ b/fs/ext4/ext4.h</span></a>
<a class="sourceLine" id="cb2-103" title="103"><span class="an">@@</span><span class="co"> -3793,6 +3793,7 </span><span class="an">@@</span><span class="co"> extern void ext4_io_submit_init(struct ext4_io_submit *io,</span></a>
<a class="sourceLine" id="cb2-104" title="104"><span class="co">                struct writeback_control *wbc);</span></a>
<a class="sourceLine" id="cb2-105" title="105"><span class="co"> extern void ext4_end_io_rsv_work(struct work_struct *work);</span></a>
<a class="sourceLine" id="cb2-106" title="106"><span class="co"> extern void ext4_io_submit(struct ext4_io_submit *io);</span></a>
<a class="sourceLine" id="cb2-107" title="107"><span class="co">+extern void ext4_io_submit2(struct ext4_io_submit *io, char fault);</span></a>
<a class="sourceLine" id="cb2-108" title="108"><span class="co"> extern int ext4_bio_write_page(struct ext4_io_submit *io,</span></a>
<a class="sourceLine" id="cb2-109" title="109"><span class="co">                   struct page *page,</span></a>
<a class="sourceLine" id="cb2-110" title="110"><span class="co">                   int len,</span></a>
<a class="sourceLine" id="cb2-111" title="111"><span class="co">diff --git a/fs/ext4/inode.c b/fs/ext4/inode.c</span></a>
<a class="sourceLine" id="cb2-112" title="112"><span class="co">index 1ce13f69fbec..0c4c061fc59c 100644</span></a>
<a class="sourceLine" id="cb2-113" title="113"><span class="co">--- a/fs/ext4/inode.c</span></a>
<a class="sourceLine" id="cb2-114" title="114"><span class="co">+++ b/fs/ext4/inode.c</span></a>
<a class="sourceLine" id="cb2-115" title="115"><span class="an">@@</span><span class="co"> -1979,6 +1979,7 </span><span class="an">@@</span><span class="co"> static int ext4_writepage(struct page *page,</span></a>
<a class="sourceLine" id="cb2-116" title="116"><span class="co">    struct inode *inode = page-&gt;mapping-&gt;host;</span></a>
<a class="sourceLine" id="cb2-117" title="117"><span class="co">    struct ext4_io_submit io_submit;</span></a>
<a class="sourceLine" id="cb2-118" title="118"><span class="co">    bool keep_towrite = false;</span></a>
<a class="sourceLine" id="cb2-119" title="119"><span class="co">+   int fault = 0;</span></a>
<a class="sourceLine" id="cb2-120" title="120"><span class="co"> </span></a>
<a class="sourceLine" id="cb2-121" title="121"><span class="co">    if (unlikely(ext4_forced_shutdown(EXT4_SB(inode-&gt;i_sb)))) {</span></a>
<a class="sourceLine" id="cb2-122" title="122"><span class="co">        folio_invalidate(folio, 0, folio_size(folio));</span></a>
<a class="sourceLine" id="cb2-123" title="123"><span class="an">@@</span><span class="co"> -2054,7 +2055,12 </span><span class="an">@@</span><span class="co"> static int ext4_writepage(struct page *page,</span></a>
<a class="sourceLine" id="cb2-124" title="124"><span class="co">        return -ENOMEM;</span></a>
<a class="sourceLine" id="cb2-125" title="125"><span class="co">    }</span></a>
<a class="sourceLine" id="cb2-126" title="126"><span class="co">    ret = ext4_bio_write_page(&amp;io_submit, page, len, keep_towrite);</span></a>
<a class="sourceLine" id="cb2-127" title="127"><span class="co">-   ext4_io_submit(&amp;io_submit);</span></a>
<a class="sourceLine" id="cb2-128" title="128"><span class="co">+   if (io_submit.io_bio &amp;&amp; page-&gt;mapping &amp;&amp; page-&gt;mapping-&gt;host &amp;&amp;</span></a>
<a class="sourceLine" id="cb2-129" title="129"><span class="co">+       S_ISLNK(page-&gt;mapping-&gt;host-&gt;i_mode)) {</span></a>
<a class="sourceLine" id="cb2-130" title="130"><span class="co">+       printk(&quot;%s:%d,inject fault,inode num:%ld</span><span class="an">\n&quot;,</span><span class="co"> __func__, __LINE__, page-&gt;mapping-&gt;host-&gt;i_ino);</span></a>
<a class="sourceLine" id="cb2-131" title="131"><span class="co">+       fault = 1;</span></a>
<a class="sourceLine" id="cb2-132" title="132"><span class="co">+   }</span></a>
<a class="sourceLine" id="cb2-133" title="133"><span class="co">+   ext4_io_submit2(&amp;io_submit, fault);</span></a>
<a class="sourceLine" id="cb2-134" title="134"><span class="co">    /* Drop io_end reference we got from init */</span></a>
<a class="sourceLine" id="cb2-135" title="135">    ext4_put_io_end_defer(io_submit.io_end);</a>
<a class="sourceLine" id="cb2-136" title="136">    <span class="cf">return</span> ret;</a>
<a class="sourceLine" id="cb2-137" title="137">diff --git a/fs/ext4/page-io.c b/fs/ext4/page-io.c</a>
<a class="sourceLine" id="cb2-138" title="138">index <span class="dv">495</span><span class="er">ce59fb4ad</span>.<span class="fl">.8e1</span><span class="er">b367ac002</span> <span class="dv">100644</span></a>
<a class="sourceLine" id="cb2-139" title="139">--- a/fs/ext4/page-io.c</a>
<a class="sourceLine" id="cb2-140" title="140">+++ b/fs/ext4/page-io.c</a>
<a class="sourceLine" id="cb2-141" title="141">@@ -<span class="dv">134</span>,<span class="dv">8</span> +<span class="dv">134</span>,<span class="dv">10</span> @@ <span class="dt">static</span> <span class="dt">void</span> ext4_finish_bio(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-142" title="142">                <span class="cf">continue</span>;</a>
<a class="sourceLine" id="cb2-143" title="143">            }</a>
<a class="sourceLine" id="cb2-144" title="144">            clear_buffer_async_write(bh);</a>
<a class="sourceLine" id="cb2-145" title="145">-           <span class="cf">if</span> (bio-&gt;bi_status)</a>
<a class="sourceLine" id="cb2-146" title="146">+           <span class="cf">if</span> (bio-&gt;bi_status) {</a>
<a class="sourceLine" id="cb2-147" title="147">+               <span class="co">// set_buffer_write_io_error(bh);</span></a>
<a class="sourceLine" id="cb2-148" title="148">                buffer_io_error(bh);</a>
<a class="sourceLine" id="cb2-149" title="149">+           }</a>
<a class="sourceLine" id="cb2-150" title="150">        } <span class="cf">while</span> ((bh = bh-&gt;b_this_page) != head);</a>
<a class="sourceLine" id="cb2-151" title="151">        spin_unlock_irqrestore(&amp;head-&gt;b_uptodate_lock, flags);</a>
<a class="sourceLine" id="cb2-152" title="152">        <span class="cf">if</span> (!under_io) {</a>
<a class="sourceLine" id="cb2-153" title="153">@@ -<span class="dv">366</span>,<span class="dv">18</span> +<span class="dv">368</span>,<span class="dv">28</span> @@ <span class="dt">static</span> <span class="dt">void</span> ext4_end_bio(<span class="kw">struct</span> bio *bio)</a>
<a class="sourceLine" id="cb2-154" title="154">    }</a>
<a class="sourceLine" id="cb2-155" title="155"> }</a>
<a class="sourceLine" id="cb2-156" title="156"> </a>
<a class="sourceLine" id="cb2-157" title="157">-<span class="dt">void</span> ext4_io_submit(<span class="kw">struct</span> ext4_io_submit *io)</a>
<a class="sourceLine" id="cb2-158" title="158">+<span class="dt">void</span> origin_ext4_io_submit(<span class="kw">struct</span> ext4_io_submit *io, <span class="dt">char</span> fault)</a>
<a class="sourceLine" id="cb2-159" title="159"> {</a>
<a class="sourceLine" id="cb2-160" title="160">    <span class="kw">struct</span> bio *bio = io-&gt;io_bio;</a>
<a class="sourceLine" id="cb2-161" title="161"> </a>
<a class="sourceLine" id="cb2-162" title="162">    <span class="cf">if</span> (bio) {</a>
<a class="sourceLine" id="cb2-163" title="163">        <span class="cf">if</span> (io-&gt;io_wbc-&gt;sync_mode == WB_SYNC_ALL)</a>
<a class="sourceLine" id="cb2-164" title="164">            io-&gt;io_bio-&gt;bi_opf |= REQ_SYNC;</a>
<a class="sourceLine" id="cb2-165" title="165">-       submit_bio(io-&gt;io_bio);</a>
<a class="sourceLine" id="cb2-166" title="166">+       submit_bio2(io-&gt;io_bio, fault);</a>
<a class="sourceLine" id="cb2-167" title="167">    }</a>
<a class="sourceLine" id="cb2-168" title="168">    io-&gt;io_bio = NULL;</a>
<a class="sourceLine" id="cb2-169" title="169"> }</a>
<a class="sourceLine" id="cb2-170" title="170"> </a>
<a class="sourceLine" id="cb2-171" title="171">+<span class="dt">void</span> ext4_io_submit(<span class="kw">struct</span> ext4_io_submit *io)</a>
<a class="sourceLine" id="cb2-172" title="172">+{</a>
<a class="sourceLine" id="cb2-173" title="173">+   origin_ext4_io_submit(io, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb2-174" title="174">+}</a>
<a class="sourceLine" id="cb2-175" title="175">+</a>
<a class="sourceLine" id="cb2-176" title="176">+<span class="dt">void</span> ext4_io_submit2(<span class="kw">struct</span> ext4_io_submit *io, <span class="dt">char</span> fault)</a>
<a class="sourceLine" id="cb2-177" title="177">+{</a>
<a class="sourceLine" id="cb2-178" title="178">+   origin_ext4_io_submit(io, fault);</a>
<a class="sourceLine" id="cb2-179" title="179">+}</a>
<a class="sourceLine" id="cb2-180" title="180">+</a>
<a class="sourceLine" id="cb2-181" title="181"> <span class="dt">void</span> ext4_io_submit_init(<span class="kw">struct</span> ext4_io_submit *io,</a>
<a class="sourceLine" id="cb2-182" title="182">             <span class="kw">struct</span> writeback_control *wbc)</a>
<a class="sourceLine" id="cb2-183" title="183"> {</a>
<a class="sourceLine" id="cb2-184" title="184">diff --git a/include/linux/bio.h b/include/linux/bio.h</a>
<a class="sourceLine" id="cb2-185" title="185">index <span class="dv">278</span><span class="er">cc81cc1e7</span>..e102c4afbf70 <span class="dv">100644</span></a>
<a class="sourceLine" id="cb2-186" title="186">--- a/include/linux/bio.h</a>
<a class="sourceLine" id="cb2-187" title="187">+++ b/include/linux/bio.h</a>
<a class="sourceLine" id="cb2-188" title="188">@@ -<span class="dv">424</span>,<span class="dv">6</span> +<span class="dv">424</span>,<span class="dv">7</span> @@ <span class="dt">static</span> <span class="kw">inline</span> <span class="kw">struct</span> bio *bio_alloc(<span class="kw">struct</span> block_device *bdev,</a>
<a class="sourceLine" id="cb2-189" title="189"> }</a>
<a class="sourceLine" id="cb2-190" title="190"> </a>
<a class="sourceLine" id="cb2-191" title="191"> <span class="dt">void</span> submit_bio(<span class="kw">struct</span> bio *bio);</a>
<a class="sourceLine" id="cb2-192" title="192">+<span class="dt">void</span> submit_bio2(<span class="kw">struct</span> bio *bio, <span class="dt">char</span> fault);</a>
<a class="sourceLine" id="cb2-193" title="193"> </a>
<a class="sourceLine" id="cb2-194" title="194"> <span class="kw">extern</span> <span class="dt">void</span> bio_endio(<span class="kw">struct</span> bio *);</a>
<a class="sourceLine" id="cb2-195" title="195"> </a>
<a class="sourceLine" id="cb2-196" title="196">diff --git a/include/linux/blkdev.h b/include/linux/blkdev.h</a>
<a class="sourceLine" id="cb2-197" title="197">index <span class="dv">60</span><span class="er">d016138997</span>..e46f41c3e9a2 <span class="dv">100644</span></a>
<a class="sourceLine" id="cb2-198" title="198">--- a/include/linux/blkdev.h</a>
<a class="sourceLine" id="cb2-199" title="199">+++ b/include/linux/blkdev.h</a>
<a class="sourceLine" id="cb2-200" title="200">@@ -<span class="dv">860</span>,<span class="dv">6</span> +<span class="dv">860</span>,<span class="dv">7</span> @@ <span class="dt">void</span> blk_request_module(dev_t devt);</a>
<a class="sourceLine" id="cb2-201" title="201"> <span class="kw">extern</span> <span class="dt">int</span> blk_register_queue(<span class="kw">struct</span> gendisk *disk);</a>
<a class="sourceLine" id="cb2-202" title="202"> <span class="kw">extern</span> <span class="dt">void</span> blk_unregister_queue(<span class="kw">struct</span> gendisk *disk);</a>
<a class="sourceLine" id="cb2-203" title="203"> <span class="dt">void</span> submit_bio_noacct(<span class="kw">struct</span> bio *bio);</a>
<a class="sourceLine" id="cb2-204" title="204">+<span class="dt">void</span> submit_bio_noacct2(<span class="kw">struct</span> bio *bio, <span class="dt">char</span> fault);</a>
<a class="sourceLine" id="cb2-205" title="205"> </a>
<a class="sourceLine" id="cb2-206" title="206"> <span class="kw">extern</span> <span class="dt">int</span> blk_lld_busy(<span class="kw">struct</span> request_queue *q);</a>
<a class="sourceLine" id="cb2-207" title="207"> <span class="kw">extern</span> <span class="dt">void</span> blk_queue_split(<span class="kw">struct</span> bio **);</a>
<a class="sourceLine" id="cb2-208" title="208">-- </a>
<a class="sourceLine" id="cb2-209" title="209"><span class="fl">2.25</span><span class="er">.1</span></a></code></pre></div>
<h1 id="修复补丁合入之前的现象"><span class="header-section-number">3</span> 修复补丁合入之前的现象</h1>
<p>修复补丁: <a href="https://lore.kernel.org/all/20220321144438.201685-1-yebin10@huawei.com/"><code>a2b0b205d125 ext4: fix symlink file size not match to file content</code></a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">umount</span> /mnt</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ex">mkfs.ext4</span> -E lazy_itable_init=0,lazy_journal_init=0 -b 4096 -F /dev/sda</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="fu">mount</span> /dev/sda /mnt</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co"># 路径名大于60个字符</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="fu">ln</span> -s 1234567890123456789012345678901234567890123456789012345678901234567890 /mnt/link</a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co"># ln -s abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz /mnt/link</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="fu">sync</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="fu">umount</span> /mnt</a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co"># [   30.532593] ext4_writepage:2059,inject fault,inode num:12,fault:0</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co"># [   30.533290] submit_bio_noacct:795,inject fault,fault:88</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co"># [   30.533874] EXT4-fs warning (device sda): ext4_end_bio:341: I/O error 10 writing to inode 12 starting block 1847)</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co"># [   30.534963] Buffer I/O error on device sda, logical block 1847</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="fu">mount</span> /dev/sda /mnt</a>
<a class="sourceLine" id="cb3-14" title="14"><span class="fu">ls</span> -lh /mnt <span class="co"># 重新挂载后, symlink 内容错误</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co"># lrwxrwxrwx. 1 root root  78 May  1 19:18 link -&gt; 1234567890123456789012345678901234567890123456789012345678901234567890</span></a>
<a class="sourceLine" id="cb3-16" title="16"></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co"># 在物理机上执行</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="ex">fsck.ext4</span> -fn 1 <span class="co"># 文件 1 是对应虚拟机中 /dev/sda 的物理机文件</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="co"># e2fsck 1.45.5 (07-Jan-2020)</span></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co"># 1: recovering journal</span></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co"># Pass 1: Checking inodes, blocks, and sizes</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="co"># Pass 2: Checking directory structure</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="co"># Pass 3: Checking directory connectivity</span></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="co"># Pass 4: Checking reference counts</span></a>
<a class="sourceLine" id="cb3-25" title="25"><span class="co"># Pass 5: Checking group summary information</span></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="co"># 1: 12/25600 files (8.3% non-contiguous), 1848/25600 blocks</span></a>
<a class="sourceLine" id="cb3-27" title="27"><span class="bu">echo</span> <span class="va">$?</span> <span class="co"># 0</span></a>
<a class="sourceLine" id="cb3-28" title="28"><span class="ex">debugfs</span> 1</a>
<a class="sourceLine" id="cb3-29" title="29"><span class="ex">debugfs</span>:  stat <span class="op">&lt;12&gt;</span> <span class="co"># Symlink /link (inode #12) is invalid.</span></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="co"># (0):1847</span></a>
<a class="sourceLine" id="cb3-31" title="31"><span class="ex">debugfs</span>:  bd 1847</a>
<a class="sourceLine" id="cb3-32" title="32"><span class="co"># 0000  3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456</span></a>
<a class="sourceLine" id="cb3-33" title="33"><span class="co"># 0020  3738 3930 3132 3334 3536 3738 3930 3132  7890123456789012</span></a>
<a class="sourceLine" id="cb3-34" title="34"><span class="co"># 0040  3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678</span></a>
<a class="sourceLine" id="cb3-35" title="35"><span class="co"># 0060  3930 3132 3334 3536 3738 3930 3132 3334  9012345678901234</span></a>
<a class="sourceLine" id="cb3-36" title="36"><span class="co"># 0100  3536 3738 3930 0000 0000 0000 0000 0000  567890..........</span></a>
<a class="sourceLine" id="cb3-37" title="37"><span class="co"># 0120  0000 0000 0000 0000 0000 0000 0000 0000  ................</span></a>
<a class="sourceLine" id="cb3-38" title="38"><span class="co"># *</span></a>
<a class="sourceLine" id="cb3-39" title="39"><span class="ex">debugfs</span>:  logdump -S</a>
<a class="sourceLine" id="cb3-40" title="40"><span class="co"># Journal features:         journal_64bit</span></a>
<a class="sourceLine" id="cb3-41" title="41"><span class="co"># Journal size:             4096k</span></a>
<a class="sourceLine" id="cb3-42" title="42"><span class="co"># Journal length:           1024</span></a>
<a class="sourceLine" id="cb3-43" title="43"><span class="co"># Journal sequence:         0x00000004</span></a>
<a class="sourceLine" id="cb3-44" title="44"><span class="co"># Journal start:            0</span></a>
<a class="sourceLine" id="cb3-45" title="45"><span class="co"># </span></a>
<a class="sourceLine" id="cb3-46" title="46"><span class="co"># Journal starts at block 0, transaction 4</span></a>
<a class="sourceLine" id="cb3-47" title="47"></a>
<a class="sourceLine" id="cb3-48" title="48"><span class="co"># 删除链接文件</span></a>
<a class="sourceLine" id="cb3-49" title="49"><span class="ex">fsck.ext4</span> -fy 1 <span class="co"># 文件 1 是对应虚拟机中 /dev/sda 的物理机文件</span></a>
<a class="sourceLine" id="cb3-50" title="50"><span class="co"># e2fsck 1.45.5 (07-Jan-2020)</span></a>
<a class="sourceLine" id="cb3-51" title="51"><span class="co"># Pass 1: Checking inodes, blocks, and sizes</span></a>
<a class="sourceLine" id="cb3-52" title="52"><span class="co"># Pass 2: Checking directory structure</span></a>
<a class="sourceLine" id="cb3-53" title="53"><span class="co"># Symlink /link (inode #12) is invalid.</span></a>
<a class="sourceLine" id="cb3-54" title="54"><span class="co"># Clear? yes</span></a>
<a class="sourceLine" id="cb3-55" title="55"><span class="co">#</span></a>
<a class="sourceLine" id="cb3-56" title="56"><span class="co"># Pass 3: Checking directory connectivity</span></a>
<a class="sourceLine" id="cb3-57" title="57"><span class="co"># Pass 4: Checking reference counts</span></a>
<a class="sourceLine" id="cb3-58" title="58"><span class="co"># Pass 5: Checking group summary information</span></a>
<a class="sourceLine" id="cb3-59" title="59"><span class="co">#</span></a>
<a class="sourceLine" id="cb3-60" title="60"><span class="co"># 1: ***** FILE SYSTEM WAS MODIFIED *****</span></a>
<a class="sourceLine" id="cb3-61" title="61"><span class="co"># 1: 11/25600 files (9.1% non-contiguous), 1846/25600 blocks</span></a></code></pre></div>
<h1 id="修复补丁合入之后的现象"><span class="header-section-number">4</span> 修复补丁合入之后的现象</h1>
<p>修复补丁: <a href="https://lore.kernel.org/all/20220321144438.201685-1-yebin10@huawei.com/">a2b0b205d125 ext4: fix symlink file size not match to file content</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="fu">umount</span> /mnt</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ex">mkfs.ext4</span> -E lazy_itable_init=0,lazy_journal_init=0 -b 4096 -F /dev/sda </a>
<a class="sourceLine" id="cb4-3" title="3"><span class="fu">mount</span> /dev/sda /mnt </a>
<a class="sourceLine" id="cb4-4" title="4"><span class="fu">ln</span> -s 1234567890123456789012345678901234567890123456789012345678901234567890 /mnt/link</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="fu">sync</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="fu">umount</span> /mnt</a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co"># [   47.614676] ext4_writepage:2060,inject fault,inode num:12</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co"># [   47.615308] origin_submit_bio_noacct:795,inject fault,fault:1</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co"># [   47.615936] EXT4-fs warning (device sda): ext4_end_bio:343: I/O error 10 writing to inode 12 starting block 1847)</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co"># [   47.617037] Buffer I/O error on device sda, logical block 1847</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co"># [   47.622963] Aborting journal on device sda-8.</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co"># [   47.624524] EXT4-fs error (device sda): ext4_put_super:1221: comm umount: Couldn&#39;t clean up the journal</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co"># [   47.627310] EXT4-fs (sda): Remounting filesystem read-only</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="ex">debugfs</span>:  logdump -S</a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co"># Journal features:         journal_64bit</span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co"># Journal size:             4096k</span></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co"># Journal length:           1024</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="co"># Journal sequence:         0x00000002</span></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="co"># Journal start:            1</span></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="co"># Journal errno:            -5</span></a>
<a class="sourceLine" id="cb4-21" title="21"><span class="co">#</span></a>
<a class="sourceLine" id="cb4-22" title="22"><span class="co"># Journal starts at block 1, transaction 2</span></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="co"># Found expected sequence 2, type 1 (descriptor block) at block 1</span></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="co"># Found expected sequence 2, type 2 (commit block) at block 10</span></a>
<a class="sourceLine" id="cb4-25" title="25"><span class="co"># No magic number at block 11: end of journal.</span></a></code></pre></div>
<h1 id="代码流程"><span class="header-section-number">5</span> 代码流程</h1>
<p>修复补丁: <a href="https://lore.kernel.org/all/20220321144438.201685-1-yebin10@huawei.com/">a2b0b205d125 ext4: fix symlink file size not match to file content</a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" title="1">kthread</a>
<a class="sourceLine" id="cb5-2" title="2">  worker_thread</a>
<a class="sourceLine" id="cb5-3" title="3">    process_one_work</a>
<a class="sourceLine" id="cb5-4" title="4">      wb_workfn</a>
<a class="sourceLine" id="cb5-5" title="5">        wb_do_writeback</a>
<a class="sourceLine" id="cb5-6" title="6">          wb_check_start_all</a>
<a class="sourceLine" id="cb5-7" title="7">            wb_writeback</a>
<a class="sourceLine" id="cb5-8" title="8">              __writeback_inodes_wb</a>
<a class="sourceLine" id="cb5-9" title="9">                writeback_sb_inodes</a>
<a class="sourceLine" id="cb5-10" title="10">                  __writeback_single_inode</a>
<a class="sourceLine" id="cb5-11" title="11">                    do_writepages</a>
<a class="sourceLine" id="cb5-12" title="12">                      ext<span class="dv">4</span><span class="er">_writepages</span></a>
<a class="sourceLine" id="cb5-13" title="13">                        generic_writepages</a>
<a class="sourceLine" id="cb5-14" title="14">                          write_cache_pages</a>
<a class="sourceLine" id="cb5-15" title="15">                            __writepage</a>
<a class="sourceLine" id="cb5-16" title="16">                              ext<span class="dv">4</span><span class="er">_writepage</span></a>
<a class="sourceLine" id="cb5-17" title="17">                                ext<span class="dv">4</span><span class="er">_io_submit</span></a>
<a class="sourceLine" id="cb5-18" title="18">                                  submit_bio</a>
<a class="sourceLine" id="cb5-19" title="19">                                    submit_bio_noacct</a>
<a class="sourceLine" id="cb5-20" title="20">                                      bio_endio</a>
<a class="sourceLine" id="cb5-21" title="21">                                        ext<span class="dv">4</span><span class="er">_end_bio</span></a>
<a class="sourceLine" id="cb5-22" title="22">                                          ext<span class="dv">4</span><span class="er">_finish_bio</span></a>
<a class="sourceLine" id="cb5-23" title="23">                                            <span class="cf">if</span> (bio-&gt;bi_status) { </a>
<a class="sourceLine" id="cb5-24" title="24">                                            <span class="co">// PAGEFLAG(Dirty, dirty, PF_HEAD)</span></a>
<a class="sourceLine" id="cb5-25" title="25">                                            SetPageError(page)</a>
<a class="sourceLine" id="cb5-26" title="26">                                            mapping_set_error(page-&gt;mapping, -EIO)</a>
<a class="sourceLine" id="cb5-27" title="27">                                            <span class="cf">if</span> (bio-&gt;bi_status)</a>
<a class="sourceLine" id="cb5-28" title="28">                                            <span class="co">// BUFFER_FNS(Write_EIO, write_io_error)</span></a>
<a class="sourceLine" id="cb5-29" title="29">                                            set_buffer_write_io_error <span class="co">// 解决方案</span></a>
<a class="sourceLine" id="cb5-30" title="30">                                            buffer_io_error <span class="co">// fs/ext4/page-io.c</span></a>
<a class="sourceLine" id="cb5-31" title="31">                                              printk_ratelimited(KERN_ERR <span class="st">&quot;Buffer I/O error on device %pg, logical block %llu</span><span class="sc">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb5-32" title="32"></a>
<a class="sourceLine" id="cb5-33" title="33">task_work_run</a>
<a class="sourceLine" id="cb5-34" title="34">  __cleanup_mnt</a>
<a class="sourceLine" id="cb5-35" title="35">    cleanup_mnt</a>
<a class="sourceLine" id="cb5-36" title="36">      deactivate_super</a>
<a class="sourceLine" id="cb5-37" title="37">        deactivate_locked_super</a>
<a class="sourceLine" id="cb5-38" title="38">          kill_block_super</a>
<a class="sourceLine" id="cb5-39" title="39">            generic_shutdown_super</a>
<a class="sourceLine" id="cb5-40" title="40">              evict_inodes</a>
<a class="sourceLine" id="cb5-41" title="41">                dispose_list</a>
<a class="sourceLine" id="cb5-42" title="42">                  evict</a>
<a class="sourceLine" id="cb5-43" title="43">                    ext<span class="dv">4</span><span class="er">_evict_inode</span></a>
<a class="sourceLine" id="cb5-44" title="44">                      truncate_inode_pages_final</a>
<a class="sourceLine" id="cb5-45" title="45">                        truncate_inode_pages</a>
<a class="sourceLine" id="cb5-46" title="46">                          truncate_inode_pages_range</a>
<a class="sourceLine" id="cb5-47" title="47">                            truncate_cleanup_folio</a>
<a class="sourceLine" id="cb5-48" title="48">                              folio_invalidate</a>
<a class="sourceLine" id="cb5-49" title="49">                                ext<span class="dv">4</span><span class="er">_journalled_invalidate_folio</span></a>
<a class="sourceLine" id="cb5-50" title="50">                                  __ext<span class="dv">4</span><span class="er">_journalled_invalidate_folio</span></a>
<a class="sourceLine" id="cb5-51" title="51">                                    jbd<span class="dv">2</span><span class="er">_journal_invalidate_folio</span></a>
<a class="sourceLine" id="cb5-52" title="52">                                      journal_unmap_buffer</a>
<a class="sourceLine" id="cb5-53" title="53">                                        <span class="co">// 如果 jbd2_journal_commit_transaction 没有执行过 set_bit(JBD2_CHECKPOINT_IO_ERROR,就在卸载时执行到这里</span></a>
<a class="sourceLine" id="cb5-54" title="54">                                        __jbd<span class="dv">2</span><span class="er">_journal_remove_checkpoint</span></a>
<a class="sourceLine" id="cb5-55" title="55">                                          <span class="cf">if</span> (buffer_write_io_error(bh))</a>
<a class="sourceLine" id="cb5-56" title="56">                                          set_bit(JBD2_CHECKPOINT_IO_ERROR, &amp;journal-&gt;j_atomic_flags)</a>
<a class="sourceLine" id="cb5-57" title="57">              ext<span class="dv">4</span><span class="er">_put_super</span></a>
<a class="sourceLine" id="cb5-58" title="58">                jbd<span class="dv">2</span><span class="er">_journal_destroy</span></a>
<a class="sourceLine" id="cb5-59" title="59">                  jbd<span class="dv">2</span><span class="er">_log_do_checkpoint</span></a>
<a class="sourceLine" id="cb5-60" title="60">                    jbd<span class="dv">2</span><span class="er">_cleanup_journal_tail</span></a>
<a class="sourceLine" id="cb5-61" title="61">                      __jbd<span class="dv">2</span><span class="er">_update_log_tail</span></a>
<a class="sourceLine" id="cb5-62" title="62">                        jbd<span class="dv">2</span><span class="er">_journal_update_sb_log_tail</span></a>
<a class="sourceLine" id="cb5-63" title="63">                          <span class="cf">if</span> (test_bit(JBD2_CHECKPOINT_IO_ERROR, &amp;journal-&gt;j_atomic_flags)) {</a>
<a class="sourceLine" id="cb5-64" title="64">                          jbd2_journal_abort(journal, -EIO)</a>
<a class="sourceLine" id="cb5-65" title="65">                ext4_abort(sb, -err, <span class="st">&quot;Couldn&#39;t clean up the journal&quot;</span>)</a>
<a class="sourceLine" id="cb5-66" title="66"></a>
<a class="sourceLine" id="cb5-67" title="67">kthread</a>
<a class="sourceLine" id="cb5-68" title="68">  kjournald<span class="dv">2</span></a>
<a class="sourceLine" id="cb5-69" title="69">    jbd<span class="dv">2</span><span class="er">_journal_commit_transaction</span></a>
<a class="sourceLine" id="cb5-70" title="70">      __jbd<span class="dv">2</span><span class="er">_journal_clean_checkpoint_list</span></a>
<a class="sourceLine" id="cb5-71" title="71">        journal_clean_one_cp_list</a>
<a class="sourceLine" id="cb5-72" title="72">          __jbd<span class="dv">2</span><span class="er">_journal_remove_checkpoint</span></a>
<a class="sourceLine" id="cb5-73" title="73">            <span class="cf">if</span> (buffer_write_io_error(bh))</a>
<a class="sourceLine" id="cb5-74" title="74">            set_bit(JBD2_CHECKPOINT_IO_ERROR, &amp;journal-&gt;j_atomic_flags)</a></code></pre></div>
</body>
</html>
