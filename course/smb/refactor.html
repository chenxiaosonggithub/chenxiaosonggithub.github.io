<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>smb代码重构</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://chenxiaosong.com/stylesheet.css" />
</head>
<body>
<header id="title-block-header">
<!-- sign begin -->
<ul>
<li>作者: 陈孝松</li>
<li><a href="https://chenxiaosong.com/">中文主页: chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/en">英文主页: chenxiaosong.com/en</a></li>
<li><a href="https://chenxiaosong.com/video.html">哔哩哔哩教学视频: 陈孝松</a></li>
<li><a href="https://chenxiaosong.com/course.html">课程: chenxiaosong.com/course</a></li>
<li><a href="https://chenxiaosong.com/blog.html">博客: chenxiaosong.com/blog</a></li>
<li><a href="https://chenxiaosong.com/contribution.html">贡献: chenxiaosong.com/contribution</a></li>
<li>邮箱: <a href="mailto:chenxiaosong@chenxiaosong.com" class="email">chenxiaosong@chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/q.html">QQ交流群: 544216206, 点击查看群介绍</a></li>
</ul>
<!-- sign end -->
<h1 class="title">smb代码重构</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#重构参考"><span class="toc-section-number">1</span> 重构参考</a></li>
<li><a href="#todo"><span class="toc-section-number">2</span> todo</a><ul>
<li><a href="#加引用"><span class="toc-section-number">2.1</span> 加引用</a></li>
<li><a href="#重复定义"><span class="toc-section-number">2.2</span> 重复定义</a><ul>
<li><a href="#smb1pdu.h"><span class="toc-section-number">2.2.1</span> <code>smb1pdu.h</code></a></li>
<li><a href="#smb2pdu.h"><span class="toc-section-number">2.2.2</span> <code>smb2pdu.h</code></a></li>
<li><a href="#cifspdu.h"><span class="toc-section-number">2.2.3</span> <code>cifspdu.h</code>:</a></li>
<li><a href="#cifsglob.h"><span class="toc-section-number">2.2.4</span> <code>cifsglob.h</code></a></li>
</ul></li>
<li><a href="#krb5_authenticate-ntlm_authenticate-binding_session"><span class="toc-section-number">2.3</span> krb5_authenticate, ntlm_authenticate, binding_session:</a></li>
<li><a href="#ksmbd_decode_ntlmssp_auth_blob-arc4_setkey和arc4_crypt是否必须"><span class="toc-section-number">2.4</span> <code>ksmbd_decode_ntlmssp_auth_blob()</code>: <code>arc4_setkey()</code>和<code>arc4_crypt()</code>是否必须？</a></li>
</ul></li>
<li><a href="#已经提交到社区的补丁"><span class="toc-section-number">3</span> 已经提交到社区的补丁</a></li>
<li><a href="#smb2_open重构"><span class="toc-section-number">4</span> <code>smb2_open()</code>重构</a></li>
<li><a href="#公共头文件fssmbcommonsmb2status.h"><span class="toc-section-number">5</span> 公共头文件<code>fs/smb/common/smb2status.h</code></a><ul>
<li><a href="#fssmbclientsmb2status.h"><span class="toc-section-number">5.1</span> <code>fs/smb/client/smb2status.h</code></a></li>
<li><a href="#fssmbserversmbstatus.h"><span class="toc-section-number">5.2</span> <code>fs/smb/server/smbstatus.h</code></a></li>
<li><a href="#最新代码对比"><span class="toc-section-number">5.3</span> 最新代码对比</a></li>
</ul></li>
<li><a href="#公共头文件fssmbcommonsmbacl.h"><span class="toc-section-number">6</span> 公共头文件<code>fs/smb/common/smbacl.h</code></a></li>
<li><a href="#smb2_compound_op重构"><span class="toc-section-number">7</span> <code>smb2_compound_op()</code>重构</a></li>
<li><a href="#smb2_lock重构"><span class="toc-section-number">8</span> <code>smb2_lock()</code>重构</a></li>
<li><a href="#年凑数补丁"><span class="toc-section-number">9</span> 2025年凑数补丁</a><ul>
<li><a href="#重复定义-1"><span class="toc-section-number">9.1</span> 重复定义</a></li>
<li><a href="#返回值"><span class="toc-section-number">9.2</span> 返回值</a></li>
</ul></li>
</ul>
</nav>
<p><a href="https://chenxiaosong.com/course/smb/video.html">点击这里查看配套的教学视频</a>。</p>
<p><a href="https://chenxiaosong.com/course/smb/smb.html">点击跳转到smb课程所有目录</a>。</p>
<p>最近调研了ksmbd，打算贡献社区补丁，用<a href="https://gitee.com/chenxiaosonggitee/blog/blob/master/course/kernel/src/script/calc-func-lines.sh"><code>calc-func-lines.sh</code></a>脚本发现所有的文件系统的函数中排名第二长度（901行, 3714-2810）的是<code>smb2_open()</code>（排名第一的是ntfs3的1470行的<code>log_replay()</code>，但不熟悉就暂时不瞎参与了），就想着先把这个函数给尝试重构了，也先通过这个函数入手深入了解ksmbd。当然除了这个函数也会尝试做一些其他的重构。</p>
<h1 id="重构参考"><span class="header-section-number">1</span> 重构参考</h1>
<p>重构技巧可以参考Jason Yan <a href="mailto:yanaijie@huawei.com" class="email">yanaijie@huawei.com</a>的ext4重构补丁集<a href="https://chenxiaosong.com/course/kernel/patch/refactor-of-__ext4_fill_super.html"><code>some refactor of __ext4_fill_super()</code></a>。</p>
<p>函数参数是结构体请参考<code>nfs4_run_open_task()</code>。</p>
<h1 id="todo"><span class="header-section-number">2</span> todo</h1>
<h2 id="加引用"><span class="header-section-number">2.1</span> 加引用</h2>
<ul>
<li>FILE_NO_SHARE, FILE_SHARE_READ
<ul>
<li>MS-SMB2 2.2.13</li>
<li>MS-CIFS 2.2.4.64.1</li>
<li>MS-CIFS 2.2.7.1.1</li>
</ul></li>
</ul>
<h2 id="重复定义"><span class="header-section-number">2.2</span> 重复定义</h2>
<h3 id="smb1pdu.h"><span class="header-section-number">2.2.1</span> <code>smb1pdu.h</code></h3>
<ul>
<li>FILE_BASIC_INFO, smb2_file_basic_info</li>
</ul>
<h3 id="smb2pdu.h"><span class="header-section-number">2.2.2</span> <code>smb2pdu.h</code></h3>
<h3 id="cifspdu.h"><span class="header-section-number">2.2.3</span> <code>cifspdu.h</code>:</h3>
<ul>
<li>CIFS_ENCPWD_SIZE</li>
<li>CIFS_CPHTXT_SIZE</li>
<li>CIFS_CRYPTO_KEY_SIZE</li>
<li>CIFS_AUTH_RESP_SIZE</li>
<li>CIFS_HMAC_MD5_HASH_SIZE</li>
<li>CIFS_NTHASH_SIZE</li>
<li>CREATE_TREE_CONNECTION, CREATE_OPTION_READONLY, CREATE_OPTION_SPECIAL
<ul>
<li>文档搜索 FILE_DIRECTORY_FILE</li>
<li>MS-SMB2 2.2.13</li>
<li>MS-CIFS 2.2.4.64.1</li>
<li>MS-CIFS 2.2.7.1.1</li>
</ul></li>
<li>ntlmv2_resp</li>
<li>COMPRESSION_FORMAT_NONE, COMPRESSION_FORMAT_LZNT1</li>
</ul>
<h3 id="cifsglob.h"><span class="header-section-number">2.2.4</span> <code>cifsglob.h</code></h3>
<ul>
<li>ntlmssp_auth</li>
</ul>
<h2 id="krb5_authenticate-ntlm_authenticate-binding_session"><span class="header-section-number">2.3</span> krb5_authenticate, ntlm_authenticate, binding_session:</h2>
<h2 id="ksmbd_decode_ntlmssp_auth_blob-arc4_setkey和arc4_crypt是否必须"><span class="header-section-number">2.4</span> <code>ksmbd_decode_ntlmssp_auth_blob()</code>: <code>arc4_setkey()</code>和<code>arc4_crypt()</code>是否必须？</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb1-1" title="1">smb<span class="dv">2</span><span class="er">_sess_setup</span></a>
<a class="sourceLine" id="cb1-2" title="2">  ntlm_authenticate</a>
<a class="sourceLine" id="cb1-3" title="3">    ksmbd_decode_ntlmssp_auth_blob</a>
<a class="sourceLine" id="cb1-4" title="4">    set_user_flag(sess-&gt;user, KSMBD_USER_FLAG_BAD_PASSWORD) <span class="co">// 发生错误时</span></a></code></pre></div>
<h1 id="已经提交到社区的补丁"><span class="header-section-number">3</span> 已经提交到社区的补丁</h1>
<p><a href="https://lore.kernel.org/all/20240619161753.385508-1-chenxiaosong@chenxiaosong.com/"><code>[PATCH] ksmbd: remove duplicate SMB2 Oplock levels definitions</code></a></p>
<p><a href="https://lore.kernel.org/all/20240822082101.391272-1-chenxiaosong@chenxiaosong.com/"><code>[PATCH v2 00/12] smb: fix some bugs, move duplicate definitions to common header file, and some small cleanups</code></a></p>
<h1 id="smb2_open重构"><span class="header-section-number">4</span> <code>smb2_open()</code>重构</h1>
<p>重构补丁还未完成，但发了一些这个函数的bugfix补丁，请查看<a href="https://lore.kernel.org/all/20240822082101.391272-1-chenxiaosong@chenxiaosong.com/"><code>[PATCH v2 00/12] smb: fix some bugs, move duplicate definitions to common header file, and some small cleanups</code></a>，以及2023年时发过的这个函数的一个bugfix补丁<a href="https://patchwork.kernel.org/project/cifs-client/patch/20230302135804.2583061-1-chenxiaosong2@huawei.com/"><code>624b445544f ksmbd: fix possible refcount leak in smb2_open()</code></a>。</p>
<p>先整理一下函数流程。<code>smb2_open()</code>框架流程:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb2-1" title="1">  ksmbd_override_fsids</a>
<a class="sourceLine" id="cb2-2" title="2">  ksmbd_vfs_getattr</a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="cf">goto</span> reconnected_fp;</a>
<a class="sourceLine" id="cb2-4" title="4">  ksmbd_override_fsids</a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="co">// 之前是 goto err_out2</span></a>
<a class="sourceLine" id="cb2-6" title="6">  ksmbd_vfs_kern_path_locked</a>
<a class="sourceLine" id="cb2-7" title="7">  <span class="cf">goto</span> err_out;</a>
<a class="sourceLine" id="cb2-8" title="8">  smb<span class="dv">2</span><span class="er">_creat</span></a>
<a class="sourceLine" id="cb2-9" title="9">  ksmbd_vfs_kern_path_unlock</a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="cf">goto</span> err_out1;</a>
<a class="sourceLine" id="cb2-11" title="11">reconnected_fp:</a>
<a class="sourceLine" id="cb2-12" title="12">  <span class="co">// 已经重连</span></a>
<a class="sourceLine" id="cb2-13" title="13">err_out:</a>
<a class="sourceLine" id="cb2-14" title="14">  ksmbd_vfs_kern_path_unlock</a>
<a class="sourceLine" id="cb2-15" title="15">err_out1:</a>
<a class="sourceLine" id="cb2-16" title="16">  ksmbd_revert_fsids</a>
<a class="sourceLine" id="cb2-17" title="17">err_out2:</a>
<a class="sourceLine" id="cb2-18" title="18">  <span class="co">// 最后的错误处理</span></a></code></pre></div>
<p>更具体的代码流程:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb3-1" title="1">kthread</a>
<a class="sourceLine" id="cb3-2" title="2">  worker_thread</a>
<a class="sourceLine" id="cb3-3" title="3">    process_scheduled_works</a>
<a class="sourceLine" id="cb3-4" title="4">      process_one_work</a>
<a class="sourceLine" id="cb3-5" title="5">        handle_ksmbd_work</a>
<a class="sourceLine" id="cb3-6" title="6">          __handle_ksmbd_work</a>
<a class="sourceLine" id="cb3-7" title="7">            __process_request</a>
<a class="sourceLine" id="cb3-8" title="8">              smb<span class="dv">2</span><span class="er">_open</span></a>
<a class="sourceLine" id="cb3-9" title="9">smb<span class="dv">2</span><span class="er">_open</span></a>
<a class="sourceLine" id="cb3-10" title="10">  WORK_BUFFERS</a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="co">// 获取smb2_create_req和smb2_create_rsp</span></a>
<a class="sourceLine" id="cb3-12" title="12">    __wbuf</a>
<a class="sourceLine" id="cb3-13" title="13">  smb2_get_name <span class="co">// 获取要打开的文件名</span></a>
<a class="sourceLine" id="cb3-14" title="14">  parse_stream_name <span class="co">// stream name是什么鬼，后面再看TODO</span></a>
<a class="sourceLine" id="cb3-15" title="15">  ksmbd_share_veto_filename <span class="co">// 检查是否禁止访问的文件，veto翻译为禁止或否决</span></a>
<a class="sourceLine" id="cb3-16" title="16">  server_conf.flags &amp; KSMBD_GLOBAL_FLAG_DURABLE_HANDLE <span class="co">// 处理durable handle</span></a>
<a class="sourceLine" id="cb3-17" title="17">  parse_durable_handle_context</a>
<a class="sourceLine" id="cb3-18" title="18">    ksmbd_lookup_durable_fd</a>
<a class="sourceLine" id="cb3-19" title="19">      __ksmbd_lookup_fd</a>
<a class="sourceLine" id="cb3-20" title="20">        ksmbd_fp_get</a>
<a class="sourceLine" id="cb3-21" title="21">          atomic_inc_not_zero(&amp;fp-&gt;refcount) <span class="co">// 增加引用计数</span></a>
<a class="sourceLine" id="cb3-22" title="22">  smb<span class="dv">2</span><span class="er">_check_durable_oplock</span></a>
<a class="sourceLine" id="cb3-23" title="23">  ksmbd_reopen_durable_fd</a>
<a class="sourceLine" id="cb3-24" title="24">    __open_id(&amp;work-&gt;sess-&gt;file_table, fp, OPEN_ID_TYPE_VOLATILE_ID);</a>
<a class="sourceLine" id="cb3-25" title="25">  ksmbd_override_fsids</a>
<a class="sourceLine" id="cb3-26" title="26">  ksmbd_put_durable_fd</a>
<a class="sourceLine" id="cb3-27" title="27">    __ksmbd_close_fd</a>
<a class="sourceLine" id="cb3-28" title="28">      atomic_dec_and_test(&amp;fp-&gt;refcount) <span class="co">// 减少引用计数</span></a>
<a class="sourceLine" id="cb3-29" title="29">  ksmbd_fd_put</a>
<a class="sourceLine" id="cb3-30" title="30">    atomic_dec_and_test(&amp;fp-&gt;refcount) <span class="co">// 减少引用计数</span></a>
<a class="sourceLine" id="cb3-31" title="31">    __put_fd_final</a>
<a class="sourceLine" id="cb3-32" title="32">      __ksmbd_close_fd</a>
<a class="sourceLine" id="cb3-33" title="33">        ksmbd_remove_durable_fd</a>
<a class="sourceLine" id="cb3-34" title="34">          __ksmbd_remove_durable_fd</a>
<a class="sourceLine" id="cb3-35" title="35">            idr_remove(global_ft.idr, fp-&gt;persistent_id)</a>
<a class="sourceLine" id="cb3-36" title="36">        __ksmbd_remove_fd</a>
<a class="sourceLine" id="cb3-37" title="37">      atomic_dec(&amp;work-&gt;conn-&gt;stats.open_files_count)</a>
<a class="sourceLine" id="cb3-38" title="38">  req-&gt;ImpersonationLevel <span class="co">// 扮演，模仿</span></a>
<a class="sourceLine" id="cb3-39" title="39">  req-&gt;CreateOptions <span class="co">// 判断选项是否有效</span></a>
<a class="sourceLine" id="cb3-40" title="40">  req-&gt;CreateDisposition <span class="co">// Disposition 性情，气质，脾性</span></a>
<a class="sourceLine" id="cb3-41" title="41">  req-&gt;DesiredAccess <span class="co">// 访问权限检查</span></a>
<a class="sourceLine" id="cb3-42" title="42">  req-&gt;FileAttributes <span class="co">// 属性</span></a>
<a class="sourceLine" id="cb3-43" title="43">  smb2_find_context_vals <span class="co">// 4次调用，non-durable handle</span></a>
<a class="sourceLine" id="cb3-44" title="44">  ksmbd_override_fsids <span class="co">// 这个还没看懂TODO</span></a>
<a class="sourceLine" id="cb3-45" title="45">  ksmbd_vfs_kern_path_locked <span class="co">// 获取当前文件和父目录的path</span></a>
<a class="sourceLine" id="cb3-46" title="46">  <span class="cf">if</span> (stream_name) { <span class="co">// 处理stream name</span></a>
<a class="sourceLine" id="cb3-47" title="47">  CreateOptions &amp; FILE_NON_DIRECTORY_FILE_LE &amp;&amp; S_ISDIR <span class="co">// 报错是个文件夹</span></a>
<a class="sourceLine" id="cb3-48" title="48">  CreateOptions &amp; FILE_DIRECTORY_FILE_LE &amp;&amp; !S_ISDIR <span class="co">// 报错不是文件夹</span></a>
<a class="sourceLine" id="cb3-49" title="49">  file_present &amp;&amp; CreateDisposition == FILE_CREATE_LE <span class="co">// 报错已存在</span></a>
<a class="sourceLine" id="cb3-50" title="50">  smb_map_generic_desired_access <span class="co">// 访问权限处理</span></a>
<a class="sourceLine" id="cb3-51" title="51">  smb_check_perm_dacl <span class="co">// 检查访问权限</span></a>
<a class="sourceLine" id="cb3-52" title="52">  ksmbd_vfs_query_maximal_access <span class="co">// 请求最大访问权限</span></a>
<a class="sourceLine" id="cb3-53" title="53">  smb2_create_open_flags <span class="co">// 生成open flag</span></a>
<a class="sourceLine" id="cb3-54" title="54">  <span class="co">// 文件不存在</span></a>
<a class="sourceLine" id="cb3-55" title="55">  smb2_creat <span class="co">// 创建</span></a>
<a class="sourceLine" id="cb3-56" title="56">  smb2_set_ea <span class="co">// Extended Attributes</span></a>
<a class="sourceLine" id="cb3-57" title="57">  <span class="co">// 文件存在且未请求最大访问权限，处理访问权限</span></a>
<a class="sourceLine" id="cb3-58" title="58">  inode_permission <span class="co">// 分别检查文件和父目录的访问权限</span></a>
<a class="sourceLine" id="cb3-59" title="59">  <span class="co">// 此时文件肯定存在了</span></a>
<a class="sourceLine" id="cb3-60" title="60">  ksmbd_query_inode_status <span class="co">// 获取inode状态</span></a>
<a class="sourceLine" id="cb3-61" title="61">  dentry_open</a>
<a class="sourceLine" id="cb3-62" title="62">    vfs_open</a>
<a class="sourceLine" id="cb3-63" title="63">      do_dentry_open</a>
<a class="sourceLine" id="cb3-64" title="64">        ext2_file_open <span class="co">// 执行到具体的后端文件系统</span></a>
<a class="sourceLine" id="cb3-65" title="65">  file_info <span class="co">// 处理Create Action Flags</span></a>
<a class="sourceLine" id="cb3-66" title="66">  ksmbd_vfs_set_fadvise <span class="co">// 将 SMB IO 缓存选项转换为 Linux 选项</span></a>
<a class="sourceLine" id="cb3-67" title="67">  ksmbd_open_fd <span class="co">// ksmbd_file, Volatile-ID</span></a>
<a class="sourceLine" id="cb3-68" title="68">    __open_id(&amp;work-&gt;sess-&gt;file_table, fp, OPEN_ID_TYPE_VOLATILE_ID);</a>
<a class="sourceLine" id="cb3-69" title="69">    atomic_inc(&amp;work-&gt;conn-&gt;stats.open_files_count)</a>
<a class="sourceLine" id="cb3-70" title="70">  ksmbd_open_durable_fd <span class="co">// Persistent-ID</span></a>
<a class="sourceLine" id="cb3-71" title="71">  <span class="co">// 开始，如果创建新文件，则设置默认的 Windows 和 POSIX ACL</span></a>
<a class="sourceLine" id="cb3-72" title="72">  ksmbd_vfs_inherit_posix_acl <span class="co">// 继承</span></a>
<a class="sourceLine" id="cb3-73" title="73">  smb_inherit_dacl <span class="co">// </span><span class="al">TODO</span></a>
<a class="sourceLine" id="cb3-74" title="74">  smb2_create_sd_buffer <span class="co">// security descriptor</span></a>
<a class="sourceLine" id="cb3-75" title="75">  ksmbd_vfs_set_init_posix_acl</a>
<a class="sourceLine" id="cb3-76" title="76">  ksmbd_acls_fattr <span class="co">// 获取cf_acls和cf_dacls</span></a>
<a class="sourceLine" id="cb3-77" title="77">  build_sec_desc <span class="co">// 将权限位从模式转换为等效的 CIFS ACL</span></a>
<a class="sourceLine" id="cb3-78" title="78">  ksmbd_vfs_set_sd_xattr <span class="co">// 设置security descriptor扩展属性</span></a>
<a class="sourceLine" id="cb3-79" title="79">  <span class="co">// 结束，如果创建新文件，则设置默认的 Windows 和 POSIX ACL</span></a>
<a class="sourceLine" id="cb3-80" title="80">  smb2_set_stream_name_xattr <span class="co">// stream name扩展属性</span></a>
<a class="sourceLine" id="cb3-81" title="81">  <span class="co">// 在 daccess、saccess、attrib_only 和 stream 初始化后，能够通过 ksmbd_inode.m_fp_list 搜索到 fp</span></a>
<a class="sourceLine" id="cb3-82" title="82">  list_add(&amp;fp-&gt;node, &amp;fp-&gt;f_ci-&gt;m_fp_list);</a>
<a class="sourceLine" id="cb3-83" title="83">  ksmbd_inode_pending_delete <span class="co">// 在 oplock 断裂前，检查之前的 fp 中是否有删除待处理</span></a>
<a class="sourceLine" id="cb3-84" title="84">  smb_break_all_oplock <span class="co">// 断开批处理/独占 oplock 和二级 oplock</span></a>
<a class="sourceLine" id="cb3-85" title="85">  ksmbd_smb_check_shared_mode <span class="co">// 检查shared mode</span></a>
<a class="sourceLine" id="cb3-86" title="86">  smb_send_parent_lease_break_noti <span class="co">// 使用parent key比较parent lease。如果没有具有相同parent lease，发送lease断裂通知</span></a>
<a class="sourceLine" id="cb3-87" title="87">  smb_grant_oplock <span class="co">// 在文件打开时处理 Oplock/Lease 请求</span></a>
<a class="sourceLine" id="cb3-88" title="88">  ksmbd_fd_set_delete_on_close <span class="co">// 关闭时自动删除</span></a>
<a class="sourceLine" id="cb3-89" title="89">  smb<span class="dv">2</span><span class="er">_create_truncate</span></a>
<a class="sourceLine" id="cb3-90" title="90">  smb2_find_context_vals <span class="co">// 在打开请求中查找特定的上下文信息</span></a>
<a class="sourceLine" id="cb3-91" title="91">  smb_break_all_levII_oplock <span class="co">// 发送 Level 2 Oplock 或 Read Lease 断裂命令</span></a>
<a class="sourceLine" id="cb3-92" title="92">  vfs_fallocate</a>
<a class="sourceLine" id="cb3-93" title="93">  ksmbd_vfs_getattr</a>
<a class="sourceLine" id="cb3-94" title="94">  opinfo &amp;&amp; opinfo-&gt;is_lease <span class="co">// 如果请求了租约，则发送租约上下文响应</span></a></code></pre></div>
<h1 id="公共头文件fssmbcommonsmb2status.h"><span class="header-section-number">5</span> 公共头文件<code>fs/smb/common/smb2status.h</code></h1>
<p>具体的补丁请查看<a href="https://lore.kernel.org/all/20240822082101.391272-1-chenxiaosong@chenxiaosong.com/"><code>[PATCH v2 00/12] smb: fix some bugs, move duplicate definitions to common header file, and some small cleanups</code></a>。</p>
<h2 id="fssmbclientsmb2status.h"><span class="header-section-number">5.1</span> <code>fs/smb/client/smb2status.h</code></h2>
<ul>
<li><a href="https://github.com/torvalds/linux/commits/master/fs/smb/client/smb2status.h"><code>fs/smb/client/smb2status.h</code>的修改历史</a></li>
<li><a href="https://github.com/torvalds/linux/commits/38c8a9a52082579090e34c033d439ed2cd1a462d/fs/cifs/smb2status.h?browsing_rename_history=true&amp;new_path=fs/smb/client/smb2status.h&amp;original_branch=master"><code>fs/cifs/smb2status.h</code>的修改历史</a></li>
</ul>
<h2 id="fssmbserversmbstatus.h"><span class="header-section-number">5.2</span> <code>fs/smb/server/smbstatus.h</code></h2>
<ul>
<li><a href="https://github.com/torvalds/linux/commits/master/fs/smb/server/smbstatus.h"><code>fs/smb/server/smbstatus.h</code>的修改历史</a></li>
<li><a href="https://github.com/torvalds/linux/commits/38c8a9a52082579090e34c033d439ed2cd1a462d/fs/ksmbd/smbstatus.h?browsing_rename_history=true&amp;new_path=fs/smb/server/smbstatus.h&amp;original_branch=master"><code>fs/ksmbd/smbstatus.h</code>的修改历史</a></li>
<li><a href="https://github.com/torvalds/linux/commits/1a93084b9a89818aec0ac7b59a5a51f2112bf203/fs/cifsd/smbstatus.h?browsing_rename_history=true&amp;new_path=fs/smb/server/smbstatus.h&amp;original_branch=master"><code>fs/cifsd/smbstatus.h</code>的修改历史</a></li>
</ul>
<p><code>e2f34481b24d cifsd: add server-side procedures for SMB3</code>的<code>fs/cifsd/smbstatus.h</code>和最新的<code>fs/smb/server/smbstatus.h</code>只有以下不同:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="ex">@@</span> -1,6 +1,6 @@</a>
<a class="sourceLine" id="cb4-2" title="2"> <span class="ex">/*</span> SPDX-License-Identifier: LGPL-2.1+ */</a>
<a class="sourceLine" id="cb4-3" title="3"> <span class="ex">/*</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="ex">-</span> *   fs/server/smb2status.h</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="ex">+</span> *   fs/cifs/smb2status.h</a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="ex">*</span></a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="ex">*</span>   SMB2 Status code (network error) <span class="ex">definitions</span></a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="ex">*</span>   Definitions are from MS-ERREF</a></code></pre></div>
<h2 id="最新代码对比"><span class="header-section-number">5.3</span> 最新代码对比</h2>
<p>在vim下，<code>fs/smb/server/smbstatus.h</code>先做两组替换<code>:%s/\t\\\n\t/ /g</code>和<code>:%s/ \\\n\t/ /g</code>，然后再和<code>fs/smb/client/smb2status.h</code>对比，有以下不同:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># 这俩是client端的</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="ex">+</span>#define STATUS_SERVER_UNAVAILABLE cpu_to_le32(0xC0000466)</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="ex">+</span>#define STATUS_FILE_NOT_AVAILABLE cpu_to_le32(0xC0000467)</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co"># 这俩是server端的</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="ex">-</span>#define STATUS_NO_PREAUTH_INTEGRITY_HASH_OVERLAP cpu_to_le32(0xC05D0000)</a>
<a class="sourceLine" id="cb5-6" title="6"><span class="ex">-</span>#define STATUS_INVALID_LOCK_RANGE cpu_to_le32(0xC00001a1)</a></code></pre></div>
<h1 id="公共头文件fssmbcommonsmbacl.h"><span class="header-section-number">6</span> 公共头文件<code>fs/smb/common/smbacl.h</code></h1>
<p>具体的补丁请查看<a href="https://lore.kernel.org/all/20240822082101.391272-1-chenxiaosong@chenxiaosong.com/"><code>[PATCH v2 00/12] smb: fix some bugs, move duplicate definitions to common header file, and some small cleanups</code></a>。</p>
<p>执行以下替换:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="fu">find</span> fs/smb/client -type f -exec sed -i <span class="st">&#39;s/struct cifs_ntsd/struct smb_ntsd/g&#39;</span> {} <span class="ex">+</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="fu">find</span> fs/smb/client -type f -exec sed -i <span class="st">&#39;s/struct cifs_sid/struct smb_sid/g&#39;</span> {} <span class="ex">+</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="fu">find</span> fs/smb/client -type f -exec sed -i <span class="st">&#39;s/struct cifs_acl/struct smb_acl/g&#39;</span> {} <span class="ex">+</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="fu">find</span> fs/smb/client -type f -exec sed -i <span class="st">&#39;s/struct cifs_ace/struct smb_ace/g&#39;</span> {} <span class="ex">+</span></a></code></pre></div>
<p>再把重复的宏定义移动到公共头文件。</p>
<h1 id="smb2_compound_op重构"><span class="header-section-number">7</span> <code>smb2_compound_op()</code>重构</h1>
<p>这个函数有12个参数，649行（827-177），必须重构了他。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb7-1" title="1"><span class="co">/*</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co"> * 注意: 如果传递了 cfile，这里会释放对它的引用。所以请确保在从此函数返回后不要再次使用 cfile。</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co"> * 如果传递了 @out_iov 和 @out_buftype，请确保它们都足够大（&gt;= 3）以容纳所有复合响应。调用方也负责使用 free_rsp_buf() 来释放它们。</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co"> */</span></a>
<a class="sourceLine" id="cb7-5" title="5">smb<span class="dv">2</span><span class="er">_compound_op</span></a></code></pre></div>
<h1 id="smb2_lock重构"><span class="header-section-number">8</span> <code>smb2_lock()</code>重构</h1>
<p>这个函数也挺长挺复杂，有353行（7535-7181）。</p>
<h1 id="年凑数补丁"><span class="header-section-number">9</span> 2025年凑数补丁</h1>
<h2 id="重复定义-1"><span class="header-section-number">9.1</span> 重复定义</h2>
<p>列出每个提交的修改:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">git</span> log -p --oneline <span class="op">&lt;</span>提交<span class="op">1&gt;</span>..<span class="op">&lt;</span>提交n<span class="op">&gt;</span></a></code></pre></div>
<p>发邮件:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="fu">git</span> send-email --to=sfrench@samba.org,smfrench@gmail.com,linkinjeon@kernel.org,linkinjeon@samba.org,christophe.jaillet@wanadoo.fr --cc=linux-cifs@vger.kernel.org,linux-kernel@vger.kernel.org  00* <span class="co"># --in-reply-to=xxx --no-thread --suppress-cc=all</span></a></code></pre></div>
<p>发现gtags没法找到<code>ksmbd_conn_handler_loop()</code>的定义，是gtags的bug，有空去修一下。</p>
<ul>
<li>server文件: fs/smb/server/glob.h, fs/smb/server/smb2pdu.h, fs/smb/server/smb_common.h</li>
<li>client文件: fs/smb/client/cifspdu.h, fs/smb/client/smb2pdu.h, fs/smb/client/cifsglob.h, fs/smb/client/smb2glob.h</li>
</ul>
<h2 id="返回值"><span class="header-section-number">9.2</span> 返回值</h2>
<ul>
<li>smb2_0_server_cmds</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1"><span class="fu">git</span> send-email --to=sfrench@samba.org,smfrench@gmail.com,linkinjeon@kernel.org,linkinjeon@samba.org --cc=linux-cifs@vger.kernel.org,linux-kernel@vger.kernel.org  00*</a></code></pre></div>
</body>
</html>
