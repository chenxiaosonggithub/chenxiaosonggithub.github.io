<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>smb2 change notify特性开发</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://chenxiaosong.com/stylesheet.css" />
</head>
<body>
<header id="title-block-header">
<!-- sign begin -->
<ul>
<li>作者: 陈孝松</li>
<li><a href="https://chenxiaosong.com/">中文主页: chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/en">英文主页: chenxiaosong.com/en</a></li>
<li><a href="https://chenxiaosong.com/video.html">哔哩哔哩教学视频: 陈孝松</a></li>
<li><a href="https://chenxiaosong.com/course.html">课程: chenxiaosong.com/course</a></li>
<li><a href="https://chenxiaosong.com/blog.html">博客: chenxiaosong.com/blog</a></li>
<li><a href="https://chenxiaosong.com/contribution.html">贡献: chenxiaosong.com/contribution</a></li>
<li>邮箱: <a href="mailto:chenxiaosong@chenxiaosong.com" class="email">chenxiaosong@chenxiaosong.com</a></li>
<li><a href="https://chenxiaosong.com/q.html">QQ交流群: 544216206, 点击查看群介绍</a></li>
</ul>
<!-- sign end -->
<h1 class="title">smb2 change notify特性开发</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#requirements-description"><span class="toc-section-number">1</span> 需求描述</a></li>
<li><a href="#复现步骤"><span class="toc-section-number">2</span> 复现步骤</a></li>
<li><a href="#smb协议分析"><span class="toc-section-number">3</span> smb协议分析</a></li>
<li><a href="#tcpdump抓包分析"><span class="toc-section-number">4</span> tcpdump抓包分析</a></li>
<li><a href="#samba代码分析"><span class="toc-section-number">5</span> samba代码分析</a></li>
<li><a href="#smb-server内核代码分析"><span class="toc-section-number">6</span> smb server内核代码分析</a></li>
<li><a href="#smb-client内核代码分析"><span class="toc-section-number">7</span> smb client内核代码分析</a></li>
<li><a href="#fanotify"><span class="toc-section-number">8</span> fanotify</a></li>
</ul>
</nav>
<p><a href="https://chenxiaosong.com/course/smb/video.html">点击这里查看配套的教学视频</a>。</p>
<p><a href="https://chenxiaosong.com/course/smb/smb.html">点击跳转到smb课程所有目录</a>。</p>
<p><a href="https://chenxiaosong.com/en/smb2-change-notify.html">与社区交流的英文网页</a>。</p>
<h1 id="requirements-description"><span class="header-section-number">1</span> 需求描述</h1>
<p>请看<a href="https://github.com/namjaejeon/ksmbd/issues/495#issuecomment-3473472265">github上的issue</a>。</p>
<p>与maintainer Steve French的其他沟通内容:</p>
<pre><code>I am also very interested in the work to improve the VFS to allow
filesystems, especially cifs.ko (client) to support change notify
(without having to use the ioctl or smb client specific tool, smbinfo
etc).  It will be very useful.
翻译:
我也对改进 VFS 的工作非常感兴趣，
这样文件系统（尤其是客户端的 cifs.ko）就能支持 change notify（更改通知） 功能，
而无需使用 ioctl 或特定于 SMB 客户端的工具（如 smbinfo 等）。
这将会非常有用。

There are MANY exciting features for both client
and server that would be broadly helpful, and of course as you spot
new ioctls or VFS syscall flags there is always the opportunity to
make small extensions to SMB3.1.1 Linux Extensions to make
Linux--&gt;Linux exceptional over SMB3.1.1.
翻译:
对于客户端和服务器来说，都有许多令人兴奋的新功能，
这些功能将会带来广泛的帮助。
当然，当你发现新的 ioctl 或 VFS 系统调用标志时，
总是有机会对 SMB3.1.1 Linux 扩展 进行一些小的改进，
从而让 Linux --&gt; Linux 通过 SMB3.1.1 的交互更加出色。

there are relatively simple things like improving the
compression support, adding support for SMB3.1.1 over QUIC, adding
support for some additional fsctls, adding support for faster GCM
signing, etc that are well documented
翻译:
有一些相对简单的改进方向，例如：
改进压缩支持、
为 SMB3.1.1 添加基于 QUIC 的支持、
增加对更多 FSCTL 的支持、
以及支持更快速的 GCM 签名 等等，
这些都有相当完善的文档说明。

And Metze could probably help with the minor changes needed to support
SMB3.1.1 over QUIC.
翻译: 而 Metze 可能可以协助完成支持 SMB3.1.1 over QUIC 所需的一些小改动。

Would be awesome to fix inotify in the vfs layer to work with network fs (since cifs.ko already supports change notify)
翻译: 如果能在 VFS 层修复 inotify，使其支持网络文件系统就太好了（因为 cifs.ko 已经支持 change notify）。

Have you seen this article from my presentation a few years ago at
LSF/MM summit? https://lwn.net/Articles/896055/
翻译: 你有没有看到我几年前在 LSF/MM 峰会上演讲时写的这篇文章？ https://lwn.net/Articles/896055/</code></pre>
<h1 id="复现步骤"><span class="header-section-number">2</span> 复现步骤</h1>
<p>详细的分析过程请查看英文网页<a href="https://chenxiaosong.com/en/smb2-change-notify.html#win-env">《SMB2 CHANGE_NOTIFY feature》</a>。</p>
<p>环境搭建请查看<a href="https://chenxiaosong.com/course/smb/environment.html">《smb环境》</a>。</p>
<p>smb server在虚拟机中，要让外部的windows系统能访问到，需要<a href="https://chenxiaosong.com/course/gnu-linux/ssh-reverse.html">内网穿透</a>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="co"># 其中10.42.20.210是windows能访问到的地址，且这个系统上的445端口不能被占用（就是没有启动smb server）</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co"># 192.168.53.209是虚拟机的ip，注意换成localhost用默认走ipv6</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="fu">ssh</span> -R 10.42.20.210:445:192.168.53.209:445 root@10.42.20.210</a></code></pre></div>
<p>使用内网穿透，Windows好像要先连接samba所在的服务器，然后再切为ksmbd所在的服务器，这时才能挂载上ksmbd，但不确定，需要针对性再调试一下。</p>
<p>可能还需要删除凭据，打开“控制面板”（Win+R然后输入control），“用户账户” -&gt; “凭据管理器” -&gt; “管理Windows凭据”，点击条目展开，然后点击 “删除” 。</p>
<p>测试步骤如下:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="co"># /tmp/s_test是smb server导出的目录</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="bu">echo</span> something <span class="op">&gt;</span> /tmp/s_test/file <span class="co"># 在server端执行</span></a></code></pre></div>
<p>当server使用samba时，创建的新文件在windows上能立刻显示；当server使用ksmbd时，创建的新文件在windows上不会显示，需要按f5刷新。</p>
<h1 id="smb协议分析"><span class="header-section-number">3</span> smb协议分析</h1>
<p>请查看<a href="https://chenxiaosong.com/src/translation/smb/ms-doc.html">《SMB MS文档翻译》</a>。</p>
<ul>
<li>MS-SMB2 2.2.1 SMB2 Packet Header</li>
<li>MS-SMB2 2.2.1.1 SMB2 Packet Header - ASYNC</li>
<li>MS-SMB2 2.2.1.2 SMB2 Packet Header - SYNC</li>
<li>MS-SMB2 3.3.4.2 Sending an Interim Response for an Asynchronous Operation</li>
<li>MS-SMB2 3.3.4.3 Sending a Success Response</li>
<li>MS-SMB2 3.3.4.4 Sending an Error Response</li>
<li>MS-SMB2 3.2.5.1.5 Handling Asynchronous Responses</li>
<li>MS-SMB2 3.2.4.24 Application Requests Canceling an Operation</li>
<li>MS-SMB2 3.3.5.16 Receiving an SMB2 CANCEL Request</li>
</ul>
<h1 id="tcpdump抓包分析"><span class="header-section-number">4</span> tcpdump抓包分析</h1>
<p>在虚拟机中使用以下命令抓包:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="ex">tcpdump</span> --interface=any -w smb-server.pcap</a></code></pre></div>
<p>在wireshark中打开，用<code>smb2.cmd == 15</code>过滤。</p>
<p>详细的分析过程请查看英文网页<a href="https://chenxiaosong.com/en/smb2-change-notify.html#tcpdump">《SMB2 CHANGE_NOTIFY feature》</a>。</p>
<h1 id="samba代码分析"><span class="header-section-number">5</span> samba代码分析</h1>
<p>samba的调试方法请查看<a href="https://chenxiaosong.com/course/smb/debug.html#samba-print">《smb调试方法》</a>。</p>
<p>用<code>NT_STATUS_V()</code>得到错误码的值，但好像打印出来是个很大的负数，可以用<code>get_nt_error_c_code()</code>转换成字符串。</p>
<p>详细的分析过程请查看英文网页<a href="https://chenxiaosong.com/en/smb2-change-notify.html#samba-code">《SMB2 CHANGE_NOTIFY feature》</a>。</p>
<h1 id="smb-server内核代码分析"><span class="header-section-number">6</span> smb server内核代码分析</h1>
<p>异步等待和唤醒:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" title="1">smb<span class="dv">2</span><span class="er">_lock</span></a>
<a class="sourceLine" id="cb5-2" title="2">  setup_async_work(..., smb2_remove_blocked_lock, ...)</a>
<a class="sourceLine" id="cb5-3" title="3">    work-&gt;cancel_fn = fn</a>
<a class="sourceLine" id="cb5-4" title="4">  smb2_send_interim_resp(work, STATUS_PENDING);</a>
<a class="sourceLine" id="cb5-5" title="5">  ksmbd_vfs_posix_lock_wait</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">smb<span class="dv">2</span><span class="er">_cancel</span></a>
<a class="sourceLine" id="cb5-8" title="8">  iter-&gt;state = KSMBD_WORK_CANCELLED</a>
<a class="sourceLine" id="cb5-9" title="9">  smb2_remove_blocked_lock <span class="co">// iter-&gt;cancel_fn</span></a>
<a class="sourceLine" id="cb5-10" title="10">    locks_delete_block</a>
<a class="sourceLine" id="cb5-11" title="11">      __locks_delete_block</a>
<a class="sourceLine" id="cb5-12" title="12">        __locks_wake_up_blocks</a>
<a class="sourceLine" id="cb5-13" title="13">          locks_wake_up_waiter</a>
<a class="sourceLine" id="cb5-14" title="14">            wake_up(&amp;flc-&gt;flc_wait)</a>
<a class="sourceLine" id="cb5-15" title="15"></a>
<a class="sourceLine" id="cb5-16" title="16">ksmbd_conn_handler_loop <span class="co">// default_conn_ops.process_fn</span></a>
<a class="sourceLine" id="cb5-17" title="17">  ksmbd_server_process_request</a>
<a class="sourceLine" id="cb5-18" title="18">    queue_ksmbd_work</a>
<a class="sourceLine" id="cb5-19" title="19">      ksmbd_alloc_work_struct</a>
<a class="sourceLine" id="cb5-20" title="20">        ksmbd_queue_work</a>
<a class="sourceLine" id="cb5-21" title="21">          handle_ksmbd_work <span class="co">// queue_work(ksmbd_wq,</span></a>
<a class="sourceLine" id="cb5-22" title="22">            __handle_ksmbd_work</a>
<a class="sourceLine" id="cb5-23" title="23">              __process_request</a>
<a class="sourceLine" id="cb5-24" title="24">              ksmbd_conn_try_dequeue_request</a>
<a class="sourceLine" id="cb5-25" title="25">                list_del_init(&amp;work-&gt;request_entry) <span class="co">// 从async_requests链表中删除</span></a>
<a class="sourceLine" id="cb5-26" title="26">                release_async_work</a></code></pre></div>
<p>文件名处理:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" title="1">smb<span class="dv">2</span><span class="er">_query_info</span></a>
<a class="sourceLine" id="cb6-2" title="2">  smb<span class="dv">2</span><span class="er">_get_info_filesystem</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="kw">struct</span> smb2_query_info_rsp <span class="co">// MS-SMB2 2.2.38</span></a>
<a class="sourceLine" id="cb6-4" title="4">    info = (FILE_SYSTEM_ATTRIBUTE_INFO *)rsp-&gt;Buffer;</a>
<a class="sourceLine" id="cb6-5" title="5">  smb<span class="dv">2</span><span class="er">_get_info_file</span></a>
<a class="sourceLine" id="cb6-6" title="6">    smb<span class="dv">2</span><span class="er">_get_ea</span></a>
<a class="sourceLine" id="cb6-7" title="7">      ptr = (<span class="dt">char</span> *)rsp-&gt;Buffer</a>
<a class="sourceLine" id="cb6-8" title="8">      eainfo = (<span class="kw">struct</span> smb2_ea_info *)ptr;</a>
<a class="sourceLine" id="cb6-9" title="9"></a>
<a class="sourceLine" id="cb6-10" title="10">__handle_ksmbd_work</a>
<a class="sourceLine" id="cb6-11" title="11">  smb2_allocate_rsp_buf <span class="co">// conn-&gt;ops-&gt;allocate_rsp_buf</span></a>
<a class="sourceLine" id="cb6-12" title="12">    .max_trans_size = SMB3_DEFAULT_TRANS_SIZE,</a></code></pre></div>
<h1 id="smb-client内核代码分析"><span class="header-section-number">7</span> smb client内核代码分析</h1>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb7-1" title="1">ioctl</a>
<a class="sourceLine" id="cb7-2" title="2">  cifs_ioctl</a>
<a class="sourceLine" id="cb7-3" title="3">    smb<span class="dv">3</span><span class="er">_notify</span></a>
<a class="sourceLine" id="cb7-4" title="4">      SMB2_open(xid, &amp;oparms, ...)</a>
<a class="sourceLine" id="cb7-5" title="5">        SMB<span class="dv">2</span><span class="er">_open_init</span></a>
<a class="sourceLine" id="cb7-6" title="6">          smb2_plain_req_init(SMB2_CREATE,</a>
<a class="sourceLine" id="cb7-7" title="7">      SMB<span class="dv">2</span><span class="er">_change_notify</span></a>
<a class="sourceLine" id="cb7-8" title="8">        SMB<span class="dv">2</span><span class="er">_notify_init</span></a>
<a class="sourceLine" id="cb7-9" title="9">          smb2_plain_req_init(SMB2_CHANGE_NOTIFY,</a>
<a class="sourceLine" id="cb7-10" title="10">        cifs_send_recv</a>
<a class="sourceLine" id="cb7-11" title="11">          compound_send_recv</a>
<a class="sourceLine" id="cb7-12" title="12">            smb2_setup_request <span class="co">// .setup_request</span></a>
<a class="sourceLine" id="cb7-13" title="13">              smb<span class="dv">2</span><span class="er">_seq_num_into_buf</span></a>
<a class="sourceLine" id="cb7-14" title="14">                smb2_seq_num_into_buf(server, shdr);</a>
<a class="sourceLine" id="cb7-15" title="15">      SMB<span class="dv">2</span><span class="er">_cancel</span></a>
<a class="sourceLine" id="cb7-16" title="16">        cifs_send_recv</a>
<a class="sourceLine" id="cb7-17" title="17">          compound_send_recv</a>
<a class="sourceLine" id="cb7-18" title="18">            smb_send_rqst</a>
<a class="sourceLine" id="cb7-19" title="19">              __smb_send_rqst</a>
<a class="sourceLine" id="cb7-20" title="20">                rc = -ERESTARTSYS</a>
<a class="sourceLine" id="cb7-21" title="21">                <span class="cf">if</span> (fatal_signal_pending(current)) { <span class="co">// 进程将要退出</span></a>
<a class="sourceLine" id="cb7-22" title="22">                <span class="cf">goto</span> out</a>
<a class="sourceLine" id="cb7-23" title="23">                <span class="cf">return</span> -ERESTARTSYS</a>
<a class="sourceLine" id="cb7-24" title="24">      SMB<span class="dv">2</span><span class="er">_close</span></a>
<a class="sourceLine" id="cb7-25" title="25">        __SMB<span class="dv">2</span><span class="er">_close</span></a>
<a class="sourceLine" id="cb7-26" title="26">          rc = cifs_send_recv <span class="co">// -ERESTARTSYS</span></a>
<a class="sourceLine" id="cb7-27" title="27">          smb<span class="dv">2</span><span class="er">_handle_cancelled_close</span></a>
<a class="sourceLine" id="cb7-28" title="28">            __smb<span class="dv">2</span><span class="er">_handle_cancelled_cmd</span></a>
<a class="sourceLine" id="cb7-29" title="29">              smb2_cancelled_close_fid <span class="co">// INIT_WORK(&amp;cancelled-&gt;work,</span></a>
<a class="sourceLine" id="cb7-30" title="30">                SMB2_close(<span class="dv">0</span>, tcon, <span class="co">// 在工作队列中再次尝试</span></a>
<a class="sourceLine" id="cb7-31" title="31"></a>
<a class="sourceLine" id="cb7-32" title="32">kthread</a>
<a class="sourceLine" id="cb7-33" title="33">  cifs_demultiplex_thread</a>
<a class="sourceLine" id="cb7-34" title="34">    cifs_handle_standard</a>
<a class="sourceLine" id="cb7-35" title="35">      smb<span class="dv">2</span><span class="er">_is_status_pending</span></a>
<a class="sourceLine" id="cb7-36" title="36"></a>
<a class="sourceLine" id="cb7-37" title="37">revert_current_mid</a>
<a class="sourceLine" id="cb7-38" title="38">revert_current_mid_from_hdr</a></code></pre></div>
<h1 id="fanotify"><span class="header-section-number">8</span> fanotify</h1>
<p>详细的分析过程请查看英文网页<a href="https://chenxiaosong.com/en/smb2-change-notify.html#fanotify">《SMB2 CHANGE_NOTIFY feature》</a>。</p>
</body>
</html>
